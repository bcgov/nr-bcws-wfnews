name: Build Android

env:
  WEBADE_JCRS_URL: ${{ secrets.WEBADE_JCRS_URL }}
  NPMRC: ${{ secrets.NPMRC }}

# Controls when the workflow will run
on: 
  workflow_call:
    inputs:
      PRODUCTION_RELEASE:
        required: true
        type: boolean

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    env:
      ANGULAR_DIRECTORY: ./client/wfnews-war/src/main/angular
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      
      - name: Add .npmrc file
        run: echo -e $NPMRC > ~/.npmrc
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install Ionic
        run: npm install -g @ionic/cli

      - name: Install app dependencies
        working-directory: ${{ env.ANGULAR_DIRECTORY }}
        run: npm ci

      - name: Prepare app for build
        working-directory: ${{ env.ANGULAR_DIRECTORY }}
        run: ionic capacitor sync android --prod

      - name: Make gradlew executable
        working-directory: ./android
        run: chmod +x ./gradlew

      - uses: sparkfabrik/android-build-action@v1.4.0
        name: Build APK
        if: inputs.PRODUCTION_RELEASE == false
        with:
          build-type: "assemble"
          gradle-task: "assembleDebug"
          increment-build-number: false
          # package-name: "com.wfnews.app"
          # keystore-content: "keystore file content as base64 encoded string"
          # keystore-password: "keystore password"
          # key-alias: "keystore alias"
          # json-key-data: "JSON keystore file content"
          upload-to-play-store: false
          project-path: '${{ env.ANGULAR_DIRECTORY }}/android/'
          output-path: wfnews-dev-${{ github.sha }}.apk
          # fastlane-env: ""
          # ruby-version: "head"
          # bundler-version: "2.3"
          release-track: "internal"
          # release-status: "draft"

      - uses: sparkfabrik/android-build-action@v1.4.0
        name: Build AAB and upload to Play Store
        if: inputs.PRODUCTION_RELEASE == true
        with:
          build-type: "bundle"
          gradle-task: "bundleRelease"
          increment-build-number: true
          # package-name: "com.wfnews.app"
          # keystore-content: "keystore file content as base64 encoded string"
          # keystore-password: "keystore password"
          # key-alias: "keystore alias"
          json-key-data: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
          upload-to-play-store: true
          project-path: '${{ env.ANGULAR_DIRECTORY }}/android/'
          output-path: wfnews-release-${{ github.sha }}.aab
          # fastlane-env: ""
          # ruby-version: "head"
          # bundler-version: "2.3"
          release-track: "production"
          # release-status: "draft"

      - uses: actions/upload-artifact@v3
        name: Upload APK to GitHub
        if: inputs.PRODUCTION_RELEASE == false
        with:
          name: wfnews-dev-${{ github.sha }}.apk
          path: '${{ env.ANGULAR_DIRECTORY }}/android/wfnews-dev-${{ github.sha }}.apk'
  
      - uses: actions/upload-artifact@v3
        name: Upload AAB to GitHub
        if: inputs.PRODUCTION_RELEASE == true
        with:
          name: wfnews-release-${{ github.sha }}.aab
          path: '${{ env.ANGULAR_DIRECTORY }}/android/wfnews-release-${{ github.sha }}.aab'