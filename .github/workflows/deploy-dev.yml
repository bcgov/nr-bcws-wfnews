name: Deploy Dev

env:
  REGISTRY: ghcr.io
  WEBADE_JCRS_URL: ${{ secrets.WEBADE_JCRS_URL }}
  NPMRC: ${{ secrets.NPMRC }}
  TRIGGERS: ('client/' 'server/' '.github/workflows')
on:
  pull_request_target:
    types:
      - closed
    branches:
      - 'main'
    paths:
      - ".github/workflows/**"
      - "client/**"
      - "server/**"
      - "database/**"
      - "docker/**"
      - "terraform/**"
      - "Dockerfile"
      - "Dockerfile_client"
      - "!**/README.md"

jobs:

  call-mvn-client:
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/mvn-client.yml
    secrets: inherit
    with: 
      REGISTRY: ghcr.io
      #TARGET_ENV used when generating self-referential url
      TARGET_ENV: dev

  call-mvn-server:
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/mvn-server.yml
    #SMTP_PASSWORD, DV_PASSWORD AND TFC_PROJECT ARE STORED AS SECRET
    with:
      REGISTRY: ghcr.io
      TARGET_ENV: dev
    secrets:
      DB_PASS: ${{ secrets.DEV_DB_PASS }}
      IDIR_AS_EMAIL: ${{ secrets.IDIR_AS_EMAIL }}
      IDIR_PASSWORD: ${{ secrets.IDIR_PASSWORD }}

  liquibase-build:
    uses: ./.github/workflows/liquibase.yml
    with:
      REGISTRY: ghcr.io
      TARGET_ENV: dev
    secrets: inherit

  # reverse-proxy:
  #   uses: ./.github/workflows/reverse-proxy.yml
  #   with:
  #     REGISTRY: ghcr.io
  #     TARGET_ENV: dev
  #   secrets: inherit

  # reverse-proxy:
  #   uses: ./.github/workflows/reverse-proxy.yml
  #   with:
  #     REGISTRY: ghcr.io
  #     TARGET_ENV: dev
  #   secrets: inherit

#  trivy:
#    # if: needs.check.outputs.build == 'true'
#    needs: [call-mvn-client, call-mvn-server]
#    uses: ./.github/workflows/trivy.yml

  terragrunt-deploy:
    # if: needs.check.outputs.build == 'true'
    uses: ./.github/workflows/terragrunt-deploy.yml
    needs: [call-mvn-client, call-mvn-server, liquibase-build]
    with:
      REGISTRY: ghcr.io
      #Server and Image name get PR number as appropriate inside deploy step
      CLIENT_IMAGE: nr-bcws-wfnews-client
      SERVER_IMAGE: nr-bcws-wfnews-server
      LIQUIBASE_IMAGE: nr-bcws-wfnews-liquibase
      TARGET_ENV: dev
      ALB_NAME: default
      VPC_NAME: Dev_vpc
      SUBNET_FILTER: App
      WEBADE_OAUTH2_CLIENT_ID: WFNEWS-UI
      WEBADE-OAUTH2_TOKEN_CLIENT_URL: https://intapps.nrs.gov.bc.ca/pub/oauth2/v1/check_token?disableDeveloperFilter=true&grant_type=client_credentials
      WEBADE-OAUTH2_TOKEN_URL: https://intapps.nrs.gov.bc.ca/pub/oauth2/v1/oauth/token?disableDeveloperFilter=true
      WEBADE_OAUTH2_AUTHORIZE_URL: https://intapps.nrs.gov.bc.ca/ext/oauth2/v1/oauth/authorize
      WFDM_REST_URL: https://wfappsi.nrs.gov.bc.ca/int/wfdm-document-management-api/
      WFIM_CLIENT_URL: https://wfappsi.nrs.gov.bc.ca/int/wfim-incidents-api/
      WFIM_CODE_TABLES_URL: https://wfappsi.nrs.gov.bc.ca/int/wfim-incidents-api/codeTables
      WEBADE-OAUTH2_CHECK_TOKEN_URL: https://intapps.nrs.gov.bc.ca/pub/oauth2/v1/check_token?disableDeveloperFilter=true
      WFNEWS_EMAIL_NOTIFICATIONS_ENABLED: true
      SMTP_HOST_NAME: apps.smtp.gov.bc.ca
      SMTP_FROM_EMAIL: noreply@gov.bc.ca
      SMTP_ADMIN_EMAIL: fake@mail.ignoreme
      SMTP_EMAIL_SYNC_ERROR_FREQ: 10
      SMTP_EMAIL_FREQ: 10 
      SMTP_EMAIL_ERROR_SUBJECT: WFNEWS API Error Subject [DEV]
      SMTP_EMAIL_SUBJECT: WFNEWS API Error [DEV]
      DEFAULT_APPLICATION_ENVIRONMENT: DEV
      WFNEWS_AGOL_QUERY_URL: https://services6.arcgis.com/ubm4tcTYICKBpist/ArcGIS/rest/services/BCWS_ActiveFires_PublicView/FeatureServer/0/query?where=FIRE_STATUS+%3C%3E+%27Out%27&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=4326&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&relationParam=&returnGeodetic=false&outFields=*&returnGeometry=true&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&defaultSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pjson&token=
      WFNEWS_USERNAME: wfnewsdev
      WFNEWS_MAX_CONNECTIONS: 10

    secrets:
      LICENSE_PLATE: ${{ secrets.LICENSE_PLATE }}
      DB_PASS: ${{ secrets.DEV_DB_PASS }}
      TFC_TEAM_TOKEN: ${{ secrets.TFC_TEAM_TOKEN }}
      SMTP_PASSWORD: ${{ secrets.DEV_SMTP_PASSWORD }}
      WEBADE_OAUTH2_WFNEWS_REST_CLIENT_SECRET: ${{ secrets.DEV_WEBADE_OAUTH2_WFNEWS_REST_CLIENT_SECRET }}
