name: Deploy using terragrunt

on:
  workflow_call:
    inputs:
      DEFAULT_APPLICATION_ENVIRONMENT:
        required: true
        type: string
      TARGET_ENV:
        required: true
        type: string
      IMAGE_TAG:
        required: true
        type: string
      IS_HOTFIX:
        required: true
        type: boolean
        default: false

      MAX_RECEIVED_COUNT:
        required: false
        type: number
        default: 10
      VISIBILITY_TIMEOUT_SECONDS:
        required: false
        type: number
        default: 10
      ACCEPTED_IPS:
        required: false
        type: string
        default: ""
      PUSH_NOTIFICATION_AWS_USER:
        required: false
        type: string
        default: ""
      EVENT_BRIDGE_ARN:
        required: false
        type: string
        default: ""
      WFNEWS_URL:
        required: false
        type: string
        default: ""
      SECRET_NAME:
        required: false
        type: string
        default: ""
      BAN_PROHIBITION_MONITOR_KEY:
        required: false
        type: string
        default: ""
      ACTIVE_FIRE_MONITOR_KEY:
        required: false
        type: string
        default: ""
      AREA_RESTRICTIONS_MONITOR_KEY:
        required: false
        type: string
        default: ""
      EVACUATION_MONITOR_KEY:
        required: false
        type: string
        default: ""
      LAMBDA_LAYER_KEY:
        required: false
        type: string
        default: ""
      FUNCTION_BUCKET:
        required: false
        type: string
        default: "wfnews-lambdas"
      #POINTID API VARIABLES
      DATABASE_WEATHER_URL:
        required: false
        type: string
        default: ""
      DATABASE_WEATHER_USER:
        required: false
        type: string
        default: ""
      BCGW_URL:
        required: false
        type: string
        default: ""
      WFGS_URL:
        required: false
        type: string
        default: ""
      MAX_ALLOWED_RADIUS:
        required: false
        type: number
        default: 1000
      ASYNC_JOB_INTERVAL:
        required: false
        type: number
        default: 900000
      ASYNC_JOB_REF_LAT:
        required: false
        type: number
        default: 55.2758
      ASYNC_JOB_REF_LONG: 
        required: false
        type: number
        default: -124.8509
      ASYNC_JOB_REF_RADIUS:
        required: false
        type: number
        default: 999
      WEATHER_HOST:
        required: false
        type: string
        default: ""
      WEATHER_USER:
        required: false
        type: string
        default: ""
      WFARCGIS_URL:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_AREA_RESTRICTIONS:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_BANS_PROHIBITION_AREAS:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_DANGER_RATING:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_ACTIVE_FIRES:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_EVACUATION_ORDERS_ALERTS:
        required: false
        type: string
        default: ""
      WFARCGIS_LAYER_FIRE_CENTRE_BOUNDARIES:
        required: false
        type: string
        default: ""
      WFARCGIS_QUEUESIZE:
        required: false
        type: number
        default: 1500
      WEBADE_OAUTH2_CLIENT_ID:
        required: false
        type: string
        default: ""
      WEBADE_OATH2_TOKEN_URL:
        required: false
        type: string
        default: ""
      WEBADE_OAUTH2_CLIENT_SCOPES:
        required: false
        type: string
        default: ""
      FIREWEATHER_BASEURL:
        required: false
        type: string
        default: ""
      FIREWEATHER_QUEUESIZE:
        required: false
        type: number
        default: 1500
      WFNEWS_BASEURL:
        required: false
        type: string
        default: ""
      WFNEWS_QUEUESIZE:
        required: false
        type: number
        default: 1500

    secrets:
      # AWS_ACCESS_KEY_ID:
      #   required: true
      # AWS_SECRET_ACCESS_KEY:
      #   required: true
      LICENSE_PLATE:
        required: true
      DB_PASS:
        required: true
      TFC_TEAM_TOKEN:
        required: true
      SMTP_PASSWORD:
        required: true
      WEBADE_OAUTH2_WFNEWS_REST_CLIENT_SECRET:
        required: true
      WEBADE_OAUTH2_WFNEWS_UI_CLIENT_SECRET:
        required: true
      API_KEY:
        required: true
      SNS_EMAIL_TARGETS:
        required: true
      CLOUDFRONT_HEADER:
        required: true
      DATABASE_WEATHER_PWD:
        required: true
      WEATHER_PASSWORD:
        required: true
      WEBADE_OAUTH2_CLIENT_SECRET:
        required: true

env:
  TF_VERSION: 1.2.2
  TG_VERSION: 0.37.1
  TG_SRC_PATH: terraform
  TFC_WORKSPACE: wfnews-${{ inputs.TARGET_ENV }}
  REPOSITORY: ghcr.io

jobs:
  plan:
    name: Deploy
    runs-on: ubuntu-22.04
    environment: ${{ inputs.DEFAULT_APPLICATION_ENVIRONMENT }}

    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: retrieve lambda artifacts
        uses: actions/download-artifact@v3
        with:
          name: lambda-functions
          path: ${{env.TG_SRC_PATH}}/lambda-functions

      - uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TFC_TEAM_TOKEN }}

      - uses: peter-murray/terragrunt-github-action@v1.0.0
        with:
          terragrunt_version: ${{ env.TG_VERSION }}
      
      - name: Terragrunt Apply
        working-directory: ${{env.TG_SRC_PATH}}/${{ inputs.TARGET_ENV }}
        env:
          # AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID }}
          # AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          agolAreaRestrictions: ${{vars.AGOL_AREA_RESTRICTIONS}}
          agolBansAndProhibitions: ${{vars.AGOL_BANS_AND_PROHIBITIONS}}
          agolUrl: ${{vars.AGOL_URL}}
          ALB_NAME: ${{ vars.ALB_NAME }}
          API_KEY: ${{ secrets.API_KEY }}
          APISIX_IMAGE: ${{vars.REGISTRY}}/${{ github.repository_owner }}/${{ vars.APISIX_IMAGE }}:${{ inputs.IMAGE_TAG }}
          CLIENT_CPU_UNITS: ${{vars.CLIENT_CPU_UNITS}}
          CLIENT_IMAGE: ${{vars.REGISTRY}}/${{ github.repository_owner }}/${{ vars.CLIENT_IMAGE }}${{ inputs.IS_HOTFIX && '-hotfix' }}:${{ inputs.IMAGE_TAG }}
          CLIENT_MEMORY: ${{vars.CLIENT_MEMORY}}
          CLOUDFRONT_HEADER: ${{ secrets.CLOUDFRONT_HEADER }}
          DB_INSTANCE_TYPE: ${{vars.DB_INSTANCE_TYPE}}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_SIZE: ${{ vars.DB_SIZE }}
          DEFAULT_APPLICATION_ENVIRONMENT: ${{inputs.DEFAULT_APPLICATION_ENVIRONMENT}}
          drivebcBaseUrl: ${{vars.DRIVEBC_BASE_URL}}
          GITHUB_RELEASE_NAME: ${{ github.event.release.name }}
          INSTANCE_COUNT: ${{vars.INSTANCE_COUNT}}
          LIQUIBASE_IMAGE: ${{vars.REGISTRY}}/${{ github.repository_owner }}/${{ vars.LIQUIBASE_IMAGE }}:${{ inputs.IMAGE_TAG }}
          LOGGING_LEVEL: ${{vars.LOGGING_LEVEL}}
          MAX_UPLOAD_SIZE: ${{ vars.MAX_UPLOAD_SIZE }}
          openmapsBaseUrl: ${{vars.OPENMAPS_BASE_URL}}
          SERVER_CPU_UNITS: ${{vars.SERVER_CPU_UNITS}}
          SERVER_IMAGE: ${{vars.REGISTRY}}/${{ github.repository_owner }}/${{ vars.SERVER_IMAGE }}${{ inputs.IS_HOTFIX && '-hotfix' }}:${{ inputs.IMAGE_TAG }}
          SERVER_MEMORY: ${{vars.SERVER_MEMORY}}
          siteMinderURLPrefix: ${{vars.SITEMINDER_URL_PREFIX}}
          SMTP_ADMIN_EMAIL: ${{vars.SMTP_ADMIN_EMAIL}}
          SMTP_EMAIL_ERROR_SUBJECT: ${{vars.SMTP_EMAIL_ERROR_SUBJECT}}
          SMTP_EMAIL_FREQ: ${{vars.SMTP_EMAIL_FREQ}}
          SMTP_EMAIL_SUBJECT: ${{vars.SMTP_EMAIL_SUBJECT}}
          SMTP_EMAIL_SYNC_ERROR_FREQ: ${{vars.SMTP_EMAIL_SYNC_ERROR_FREQ}}
          SMTP_FROM_EMAIL: ${{vars.SMTP_FROM_EMAIL}}
          SMTP_HOST_NAME: ${{vars.SMTP_HOST_NAME}}
          SMTP_PASSWORD: ${{secrets.SMTP_PASSWORD}}
          SNS_EMAIL_TARGETS: ${{ secrets.SNS_EMAIL_TARGETS }}
          SUBNET_FILTER: ${{ vars.SUBNET_FILTER }}
          TARGET_ENV: ${{ inputs.TARGET_ENV }}
          TFC_PROJECT: ${{ secrets.LICENSE_PLATE }}
          VPC_NAME: ${{ vars.VPC_NAME }}
          WEBADE_OAUTH2_AUTHORIZE_URL: ${{vars.WEBADE_OAUTH2_AUTHORIZE_URL}}
          WEBADE_OAUTH2_REST_CLIENT_ID: ${{vars.WEBADE_OAUTH2_REST_CLIENT_ID}}
          WEBADE_OAUTH2_UI_CLIENT_ID: ${{vars.WEBADE_OAUTH2_UI_CLIENT_ID}}
          WEBADE_OAUTH2_WFNEWS_REST_CLIENT_SECRET: ${{secrets.WEBADE_OAUTH2_WFNEWS_REST_CLIENT_SECRET}}
          WEBADE_OAUTH2_WFNEWS_UI_CLIENT_SECRET: ${{secrets.WEBADE_OAUTH2_WFNEWS_UI_CLIENT_SECRET}}
          WEBADE-OAUTH2_CHECK_TOKEN_URL: ${{vars.WEBADE_OAUTH2_CHECK_TOKEN_URL}}
          WEBADE-OAUTH2_TOKEN_CLIENT_URL: ${{vars.WEBADE_OAUTH2_TOKEN_CLIENT_URL}}
          WEBADE-OAUTH2_TOKEN_URL: ${{vars.WEBADE_OAUTH2_TOKEN_URL}}
          WFDM_REST_URL: ${{vars.WFDM_REST_URL}}
          WFIM_CLIENT_URL: ${{vars.WFIM_CLIENT_URL}}
          WFIM_CODE_TABLES_URL: ${{vars.WFIM_CODE_TABLES_URL}}
          WFNEWS_AGOL_QUERY_URL: ${{vars.WFNEWS_AGOL_QUERY_URL}}
          WFNEWS_EMAIL_NOTIFICATIONS_ENABLED: ${{vars.WFNEWS_EMAIL_NOTIFICATIONS_ENABLED}}
          WFNEWS_MAX_CONNECTIONS: ${{vars.WFNEWS_MAX_CONNECTIONS}}
          WFNEWS_USERNAME: ${{vars.WFNEWS_USERNAME}}

          MAX_RECEIVED_COUNT: ${{inputs.MAX_RECEIVED_COUNT }}
          VISIBILITY_TIMEOUT_SECONDS: ${{inputs.VISIBILITY_TIMEOUT_SECONDS }}
          ACCEPTED_IPS: ${{inputs.ACCEPTED_IPS }}
          PUSH_NOTIFICATION_AWS_USER: ${{inputs.PUSH_NOTIFICATION_AWS_USER }}
          EVENT_BRIDGE_ARN: ${{inputs.EVENT_BRIDGE_ARN }}
          WFNEWS_URL: ${{inputs.WFNEWS_URL }}
          SECRET_NAME: ${{inputs.SECRET_NAME }}
          BAN_PROHIBITION_MONITOR_KEY: ${{inputs.BAN_PROHIBITION_MONITOR_KEY }}
          ACTIVE_FIRE_MONITOR_KEY: ${{inputs.ACTIVE_FIRE_MONITOR_KEY }}
          AREA_RESTRICTIONS_MONITOR_KEY: ${{inputs.AREA_RESTRICTIONS_MONITOR_KEY }}
          EVACUATION_MONITOR_KEY: ${{inputs.EVACUATION_MONITOR_KEY }}
          LAMBDA_LAYER_KEY: ${{inputs.LAMBDA_LAYER_KEY }}
          FUNCTION_BUCKET: ${{inputs.FUNCTION_BUCKET}}

          # POINTID API VARIABLES
          DATABASE_WEATHER_URL: ${{ inputs.DATABASE_WEATHER_URL }}
          DATABASE_WEATHER_USER: ${{inputs.DATABASE_WEATHER_USER }}
          BCGW_URL: ${{inputs.BCGW_URL }}
          WFGS_URL: ${{inputs.WFGS_URL }}
          MAX_ALLOWED_RADIUS: ${{inputs.MAX_ALLOWED_RADIUS }}
          ASYNC_JOB_INTERVAL: ${{inputs.ASYNC_JOB_INTERVAL }}
          ASYNC_JOB_REF_LAT: ${{inputs.ASYNC_JOB_REF_LAT }}
          ASYNC_JOB_REF_LONG: ${{inputs.ASYNC_JOB_REF_LONG }}
          ASYNC_JOB_REF_RADIUS: ${{inputs.ASYNC_JOB_REF_RADIUS }}
          WEATHER_HOST: ${{inputs.WEATHER_HOST }}
          WEATHER_USER: ${{inputs.WEATHER_USER }}
          WFARCGIS_URL: ${{inputs.WFARCGIS_URL }}
          WFARCGIS_LAYER_AREA_RESTRICTIONS: ${{inputs.WFARCGIS_LAYER_AREA_RESTRICTIONS }}
          WFARCGIS_LAYER_BANS_PROHIBITION_AREAS: ${{inputs.WFARCGIS_LAYER_BANS_PROHIBITION_AREAS }}
          WFARCGIS_LAYER_DANGER_RATING: ${{inputs.WFARCGIS_LAYER_DANGER_RATING }}
          WFARCGIS_LAYER_ACTIVE_FIRES: ${{inputs.WFARCGIS_LAYER_ACTIVE_FIRES }}
          WFARCGIS_LAYER_EVACUATION_ORDERS_ALERTS: ${{inputs.WFARCGIS_LAYER_EVACUATION_ORDERS_ALERTS }}
          WFARGIS_LAYER_FIRE_CENTRE_BOUNDARIES: ${{inputs.WFARGIS_LAYER_FIRE_CENTRE_BOUNDARIES }}
          WFARCGIS_QUEUESIZE: ${{inputs.WFARCGIS_QUEUESIZE }}
          WEBADE_OAUTH2_CLIENT_ID: ${{inputs.WEBADE_OAUTH2_CLIENT_ID }}
          WEBADE_OATH2_TOKEN_URL: ${{inputs.WEBADE_OATH2_TOKEN_URL }}
          WEBADE_OAUTH2_CLIENT_SCOPES: ${{inputs.WEBADE_OAUTH2_CLIENT_SCOPES }}
          FIREWEATHER_BASEURL: ${{inputs.FIREWEATHER_BASEURL }}
          FIREWEATHER_QUEUESIZE: ${{inputs.FIREWEATHER_QUEUESIZE }}
          WFNEWS_BASEURL: ${{inputs.WFNEWS_BASEURL }}
          WFNEWS_QUEUESIZE: ${{inputs.WFNEWS_QUEUESIZE }}
          DATABASE_WEATHER_PWD: ${{secrets.DATABASE_WEATHER_PWD }}
          WEATHER_PASSWORD: ${{secrets.WEATHER_PASSWORD }}
          WEBADE_OAUTH2_CLIENT_SECRET: ${{secrets.WEBADE_OAUTH2_CLIENT_SECRET }}

        run: terragrunt apply --terragrunt-non-interactive -auto-approve

