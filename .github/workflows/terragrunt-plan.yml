name: Plan using terragrunt

on:
  pull_request_target:
    types: 
      - opened
    branches:
      - 'main'
    paths:
      - ".github/workflows/**"
      - "client/**"
      - "server/**"
      - "database/**"
      - "docker/**"
      - "terraform/**"
      - "Dockerfile"
      - "!**/README.md"

env:
  TF_VERSION: 1.2.2
  TG_VERSION: 0.37.1
  TG_SRC_PATH: terraform
  REGISTRY: ghcr.io
  CLIENT_IMAGE: "wfnews-client"
  SERVER_IMAGE: "wfnews-server"
  LIQUIBASE_IMAGE: "wfnews-liquibase"
  TARGET_ENV: "dev"
  ALB_NAME: "default"
  VPC_NAME: "Dev_vpc"
  SUBNET_FILTER: "App"

jobs:
  plan:
    name: plan
    runs-on: ubuntu-22.04
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TFC_TEAM_TOKEN }}

      - uses: peter-murray/terragrunt-github-action@v1.0.0
        with:
          terragrunt_version: ${{ env.TG_VERSION }}
      
      - name: Terragrunt Plan
        working-directory: ${{env.TG_SRC_PATH}}/${{ env.TARGET_ENV }}
        env:
          CLIENT_IMAGE: ${{inputs.registry}}/bcgov/${{ env.CLIENT_IMAGE }}-${{ github.event.pull_request.number }}:pr-${{ github.event.pull_request.number }}
          SERVER_IMAGE: ${{inputs.registry}}/bcgov/${{ env.SERVER_IMAGE }}-${{ github.event.pull_request.number }}:pr-${{ github.event.pull_request.number }}
          LIQUIBASE_IMAGE: ${{inputs.registry}}/bcgov/${{ env.LIQUIBASE_IMAGE }}:pr-${{ github.event.pull_request.number }}
          TFC_PROJECT: ${{ secrets.LICENSE_PLATE }}
          DB_PASS: dbTESTsecretUNUSED
          ALB_NAME: ${{ env.ALB_NAME }}
          VPC_NAME: ${{ env.VPC_NAME }}
          SUBNET_FILTER: ${{ env.SUBNET_FILTER }}
        run: terragrunt plan --terragrunt-non-interactive

