import { Injectable, Injector } from "@angular/core";
import { HttpClient, HttpHandler, HttpHeaders } from "@angular/common/http";
import { OAuthService } from "angular-oauth2-oidc";
import * as momentInstance from "moment";
import { AsyncSubject } from "rxjs";
// Services
import { AppConfigService } from "./app-config.service";
import { catchError } from "rxjs/operators";
import * as i0 from "@angular/core";
import * as i1 from "./app-config.service";
const moment = momentInstance;
const OAUTH_LOCAL_STORAGE_KEY = 'oauth';
export class TokenService {
    constructor(injector, appConfigService) {
        //console.log("initing token service", appConfigService.getConfig());
        this.injector = injector;
        this.appConfigService = appConfigService;
        this.LOCAL_STORAGE_KEY = OAUTH_LOCAL_STORAGE_KEY;
        this.useLocalStore = false;
        this.credentials = new AsyncSubject();
        this.authToken = new AsyncSubject();
        this.credentialsEmitter = this.credentials.asObservable();
        this.authTokenEmitter = this.authToken.asObservable();
        const lazyAuthenticate = appConfigService.getConfig().application.lazyAuthenticate;
        const enableLocalStorageToken = appConfigService.getConfig().application.enableLocalStorageToken;
        const localStorageTokenKey = appConfigService.getConfig().application.localStorageTokenKey;
        const allowLocalExpiredToken = appConfigService.getConfig().application.allowLocalExpiredToken;
        if (localStorageTokenKey) {
            this.LOCAL_STORAGE_KEY = localStorageTokenKey;
        }
        if (enableLocalStorageToken) {
            this.useLocalStore = true;
        }
        this.checkForToken(undefined, lazyAuthenticate, allowLocalExpiredToken);
    }
    /*
     * Check window location hash fragment or local storage session for access token.
     * Parse and set the token if the access token is present,
     * otherwise initiate implicit flow.
     *
     * @param {string} redirectUri The redirect URI after login is complete
     * @param {boolean} lazyAuth When true, allows application to handle when to login ( by default: false which will require login as soon as the application initializes)
     * @param {boolean} allowLocalExpiredToken When true, expired tokens are not removed and does not invoke login (allows token to be used even when expired for offline mode and service workers).
     */
    checkForToken(redirectUri, lazyAuth, allowLocalExpiredToken) {
        // console.log('redirect uri', redirectUri);
        let hash = window.location.hash;
        // Check if URL has token (redirected back from oauth)
        if (hash && hash.indexOf('access_token') > -1) {
            // We have a token in the URL, parse it
            this.parseToken(hash);
        }
        else if (this.useLocalStore && !navigator.onLine) {
            // Only use local storage if application is offline
            // this is to refresh expired tokens before check token is enabled, when there is connectivity
            // Check if local storage has a token
            let tokenStore = localStorage.getItem(this.LOCAL_STORAGE_KEY);
            // Parse the token
            if (tokenStore) {
                try {
                    tokenStore = JSON.parse(tokenStore);
                    this.initAuthFromSession();
                }
                catch (err) {
                    // Failed to parse the token, remove the old token and get a new token by logging in again
                    console.log('Failed to read session token - reinitializing');
                    this.tokenDetails = undefined;
                    localStorage.removeItem(this.LOCAL_STORAGE_KEY);
                    this.initImplicitFlow(redirectUri);
                }
            }
            else {
                // no token was found initiate login
                this.initImplicitFlow(redirectUri);
            }
            // Check if token is expired if it is not allowed
            if (!allowLocalExpiredToken && this.isTokenExpired(this.tokenDetails)) {
                localStorage.removeItem(this.LOCAL_STORAGE_KEY);
                this.initImplicitFlow(redirectUri);
            }
        }
        else if (hash && hash.indexOf('error') > -1) {
            alert('Error occurred during authentication.');
            return;
        }
        else {
            // login if lazy auth not enabled as we need a token
            if (!lazyAuth) {
                this.initImplicitFlow(redirectUri);
            }
        }
    }
    isTokenExpired(token) {
        let expiryDate;
        let now = moment();
        if (token && token.exp) {
            expiryDate = moment.unix(token.exp);
            if (now.isBefore(expiryDate)) {
                return false;
            }
        }
        return true;
    }
    /*
     * Parse token from a hash fragment
     * Example:
     *    #access_token=ABC&token_type=bearer&state=&expires_in=43199&scope=WFIM.GET_WILDFIRE_INCIDENT%20WFORG.GET_ORG_UNITS%&jti=3a642b53-d90e-4ee3-a00c-5cd780155225
     */
    parseToken(hash) {
        if (hash.startsWith('#')) {
            hash = hash.substr(1);
        }
        let responseParameters = (hash).split("&");
        let parameterMap = [];
        for (let i = 0; i < responseParameters.length; i++) {
            parameterMap[responseParameters[i].split("=")[0]] = responseParameters[i].split("=")[1];
        }
        if (parameterMap['access_token'] !== undefined && parameterMap['access_token'] !== null) {
            location.hash = '';
            this.initAuth(parameterMap);
        }
    }
    /*
     * Set authentication configuration and initiate implicit flow
     */
    initImplicitFlow(redirectUri) {
        const configuration = this.appConfigService.getConfig();
        let authConfig = {
            oidc: false,
            issuer: configuration.application.baseUrl,
            loginUrl: configuration.webade.oauth2Url,
            redirectUri: redirectUri ? redirectUri : window.location.href,
            clientId: configuration.webade.clientId,
            scope: configuration.webade.authScopes
        };
        // console.log('authConfig', authConfig);
        const oauthService = this.injector.get(OAuthService);
        oauthService.configure(authConfig);
        oauthService.initImplicitFlow();
    }
    /*
     * Set authentication configuration and initiate refresh token implicit flow
     */
    initRefreshTokenImplicitFlow(authorizeURL, storageKey, errorCallback) {
        const options = 'resizable=yes,scrollbars=yes,statusbar=yes,status=yes';
        let refreshWindow = window.open(authorizeURL, null, options);
        let refreshAsync = new AsyncSubject();
        let refreshInterval = setInterval(() => {
            if (!refreshWindow) {
                errorCallback('Session Expired. Unable to open refresh window. Please allow pop-ups.');
                refreshWindow = window.open(authorizeURL, null, options);
            }
            if (refreshWindow && refreshWindow.closed) {
                clearInterval(refreshInterval);
                let newToken = window.localStorage.getItem(`${storageKey}`);
                newToken = JSON.parse(newToken);
                window.localStorage.removeItem(`${storageKey}`);
                this.updateToken(newToken);
                refreshAsync.next(newToken);
                refreshAsync.complete();
            }
        }, 500);
        return refreshAsync.asObservable();
    }
    /*
     * initialize authentication from session in application, emit to subscribers
     */
    initAuthFromSession() {
        try {
            let localOauth = localStorage.getItem(this.LOCAL_STORAGE_KEY);
            localOauth = JSON.parse(localOauth);
            this.oauth = localOauth;
            this.initAndEmit();
        }
        catch (err) {
            localStorage.removeItem(this.LOCAL_STORAGE_KEY);
            console.log('Failed to handle token payload', this.oauth);
            this.handleError(err, 'Failed to handle token');
        }
    }
    /*
     * initialize authentication response in application, emit to subscribers
     */
    initAuth(response) {
        if (response) {
            try {
                if (this.useLocalStore) {
                    let tokenStore = {
                        access_token: response.access_token,
                        expires_in: response.expires_in
                    };
                    localStorage.setItem(this.LOCAL_STORAGE_KEY, JSON.stringify(tokenStore));
                }
                this.oauth = response;
                this.initAndEmit();
            }
            catch (err) {
                if (this.useLocalStore) {
                    localStorage.removeItem(this.LOCAL_STORAGE_KEY);
                }
                console.log('Failed to handle token payload', this.oauth);
                this.handleError(err, 'Failed to handle token');
            }
        }
    }
    /*
     * Initialize all token service attributes and emit
     */
    initAndEmit() {
        // console.log('init and emit', this.appConfigService.getConfig());
        if (this.appConfigService.getConfig().webade.enableCheckToken) {
            let baseUrl = this.appConfigService.getConfig().application.baseUrl;
            if (!baseUrl.endsWith('/')) {
                baseUrl = baseUrl.concat('/');
            }
            let checkTokenUrl = `${baseUrl}${this.appConfigService.getConfig().webade.checkTokenUrl}`;
            const headers = new HttpHeaders({
                'Authorization': `Bearer ${this.oauth.access_token}`,
            });
            // console.log('checkTokenUrl', checkTokenUrl);
            setTimeout(() => {
                let http = new HttpClient(this.injector.get(HttpHandler));
                http.get(checkTokenUrl, { headers }).toPromise()
                    .then((response) => {
                    this.tokenDetails = response;
                    // console.log('access_token', this.oauth.access_token);
                    this.authToken.next(this.oauth.access_token);
                    this.authToken.complete();
                    // console.log('tokenDetails', this.tokenDetails);
                    this.credentials.next(this.tokenDetails);
                    this.credentials.complete();
                })
                    , catchError(error => {
                        console.log(error);
                        alert(`App initialization Failed ${error.status}. Status(Check token failed)`);
                        return error;
                    });
            });
        }
        else {
            //Split for JWT
            const oauthInfo = this.oauth.access_token.split('.');
            // console.log('oauthInfo', oauthInfo);
            if (oauthInfo.length > 1) {
                this.tokenDetails = JSON.parse(atob(oauthInfo[1]));
            }
            // console.log('access_token2', this.oauth.access_token);
            this.authToken.next(this.oauth.access_token);
            this.authToken.complete();
            // console.log('tokenDetails2', this.tokenDetails);
            this.credentials.next(this.tokenDetails);
            this.credentials.complete();
        }
    }
    updateToken(oauthToken) {
        this.oauth = oauthToken;
        this.initAndEmit();
    }
    getOauthToken() {
        return (this.oauth) ? this.oauth.access_token : null;
    }
    getTokenDetails() {
        return (this.tokenDetails) ? this.tokenDetails : null;
    }
    doesUserHaveApplicationPermissions(scopes) {
        if (this.tokenDetails && this.tokenDetails.scope && this.tokenDetails.scope.length > 0) {
            if (scopes) {
                for (let i = 0; i < scopes.length; i++) {
                    if (this.tokenDetails.scope.indexOf(scopes[i]) == -1) {
                        return false;
                    }
                }
                return true;
            }
        }
        return false;
    }
    clearLocalStorageToken() {
        localStorage.removeItem(this.LOCAL_STORAGE_KEY);
    }
    handleError(err, message) {
        console.error('Unexpected error', err);
        alert(message ? message + ' ' + err : '' + err);
        throw err;
    }
}
TokenService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TokenService_Factory() { return new TokenService(i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i1.AppConfigService)); }, token: TokenService, providedIn: "root" });
TokenService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
TokenService.ctorParameters = () => [
    { type: Injector },
    { type: AppConfigService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW4uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUtdWkvc3JjL2xpYi9zZXJ2aWNlcy90b2tlbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEtBQUssY0FBYyxNQUFNLFFBQVEsQ0FBQztBQUN6QyxPQUFPLEVBQUMsWUFBWSxFQUFhLE1BQU0sTUFBTSxDQUFDO0FBQzlDLFdBQVc7QUFDWCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUN0RCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7OztBQUUxQyxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUM7QUFFOUIsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUM7QUFLeEMsTUFBTSxPQUFPLFlBQVk7SUFXdkIsWUFBb0IsUUFBa0IsRUFBWSxnQkFBa0M7UUFDbkYscUVBQXFFO1FBRGxELGFBQVEsR0FBUixRQUFRLENBQVU7UUFBWSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBVDVFLHNCQUFpQixHQUFHLHVCQUF1QixDQUFDO1FBQzVDLGtCQUFhLEdBQVksS0FBSyxDQUFDO1FBSS9CLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN0QyxjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUN4Qyx1QkFBa0IsR0FBb0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0RSxxQkFBZ0IsR0FBdUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZ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QUFDO0lBQ3hELENBQUM7SUFFTSxrQ0FBa0MsQ0FBQyxNQUFpQjtRQUN6RCxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN0RixJQUFJLE1BQU0sRUFBRTtnQkFDVixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDcEMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7d0JBQ3BELE9BQU8sS0FBSyxDQUFDO3FCQUNkO2lCQUNKO2dCQUNELE9BQU8sSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVNLHNCQUFzQjtRQUMzQixZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFTyxXQUFXLENBQUMsR0FBRyxFQUFFLE9BQVE7UUFDL0IsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2QyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sR0FBRyxDQUFDO0lBQ1osQ0FBQzs7OztZQTdURixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWZtQixRQUFRO1lBTXBCLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgSW5qZWN0b3J9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBIYW5kbGVyLCBIdHRwSGVhZGVyc30gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XG5pbXBvcnQge09BdXRoU2VydmljZX0gZnJvbSBcImFuZ3VsYXItb2F1dGgyLW9pZGNcIjtcbmltcG9ydCAqIGFzIG1vbWVudEluc3RhbmNlIGZyb20gXCJtb21lbnRcIjtcbmltcG9ydCB7QXN5bmNTdWJqZWN0LCBPYnNlcnZhYmxlfSBmcm9tIFwicnhqc1wiO1xuLy8gU2VydmljZXNcbmltcG9ydCB7QXBwQ29uZmlnU2VydmljZX0gZnJvbSBcIi4vYXBwLWNvbmZpZy5zZXJ2aWNlXCI7XG5pbXBvcnQge2NhdGNoRXJyb3J9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuXG5jb25zdCBtb21lbnQgPSBtb21lbnRJbnN0YW5jZTtcblxuY29uc3QgT0FVVEhfTE9DQUxfU1RPUkFHRV9LRVkgPSAnb2F1dGgnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgVG9rZW5TZXJ2aWNlIHtcbiAgXG4gIHByaXZhdGUgTE9DQUxfU1RPUkFHRV9LRVkgPSBPQVVUSF9MT0NBTF9TVE9SQUdFX0tFWTtcbiAgcHJpdmF0ZSB1c2VMb2NhbFN0b3JlOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgb2F1dGg6IGFueTtcbiAgcHJpdmF0ZSB0b2tlbkRldGFpbHM6IGFueTtcblxuICBwcml2YXRlIGNyZWRlbnRpYWxzID0gbmV3IEFzeW5jU3ViamVjdDxhbnk+KCk7XG4gIHByaXZhdGUgYXV0aFRva2VuID0gbmV3IEFzeW5jU3ViamVjdDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBjcmVkZW50aWFsc0VtaXR0ZXI6IE9ic2VydmFibGU8YW55PiA9IHRoaXMuY3JlZGVudGlhbHMuYXNPYnNlcnZhYmxlKCk7XG4gIHB1YmxpYyBhdXRoVG9rZW5FbWl0dGVyOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmF1dGhUb2tlbi5hc09ic2VydmFibGUoKTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByb3RlY3RlZCBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlKSB7XG4gICAvL2NvbnNvbGUubG9nKFwiaW5pdGluZyB0b2tlbiBzZXJ2aWNlXCIsIGFwcENvbmZpZ1NlcnZpY2UuZ2V0Q29uZmlnKCkpO1xuICAgIFxuICAgIGNvbnN0IGxhenlBdXRoZW50aWNhdGU6IGJvb2xlYW4gPSBhcHBDb25maWdTZXJ2aWNlLmdldENvbmZpZygpLmFwcGxpY2F0aW9uLmxhenlBdXRoZW50aWNhdGU7XG4gICAgY29uc3QgZW5hYmxlTG9jYWxTdG9yYWdlVG9rZW46IGJvb2xlYW4gPSBhcHBDb25maWdTZXJ2aWNlLmdldENvbmZpZygpLmFwcGxpY2F0aW9uLmVuYWJsZUxvY2FsU3RvcmFnZVRva2VuO1xuICAgIGNvbnN0IGxvY2FsU3RvcmFnZVRva2VuS2V5OiBzdHJpbmcgPSBhcHBDb25maWdTZXJ2aWNlLmdldENvbmZpZygpLmFwcGxpY2F0aW9uLmxvY2FsU3RvcmFnZVRva2VuS2V5O1xuICAgIGNvbnN0IGFsbG93TG9jYWxFeHBpcmVkVG9rZW46IGJvb2xlYW4gPSBhcHBDb25maWdTZXJ2aWNlLmdldENvbmZpZygpLmFwcGxpY2F0aW9uLmFsbG93TG9jYWxFeHBpcmVkVG9rZW47XG4gICAgXG4gICAgaWYobG9jYWxTdG9yYWdlVG9rZW5LZXkpe1xuICAgICAgdGhpcy5MT0NBTF9TVE9SQUdFX0tFWSA9IGxvY2FsU3RvcmFnZVRva2VuS2V5O1xuICAgIH1cbiAgICBcbiAgICBpZihlbmFibGVMb2NhbFN0b3JhZ2VUb2tlbil7XG4gICAgICB0aGlzLnVzZUxvY2FsU3RvcmUgPSB0cnVlO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLmNoZWNrRm9yVG9rZW4odW5kZWZpbmVkLCBsYXp5QXV0aGVudGljYXRlLCBhbGxvd0xvY2FsRXhwaXJlZFRva2VuKTtcbiAgfVxuXG4gIC8qXG4gICAqIENoZWNrIHdpbmRvdyBsb2NhdGlvbiBoYXNoIGZyYWdtZW50IG9yIGxvY2FsIHN0b3JhZ2Ugc2Vzc2lvbiBmb3IgYWNjZXNzIHRva2VuLlxuICAgKiBQYXJzZSBhbmQgc2V0IHRoZSB0b2tlbiBpZiB0aGUgYWNjZXNzIHRva2VuIGlzIHByZXNlbnQsXG4gICAqIG90aGVyd2lzZSBpbml0aWF0ZSBpbXBsaWNpdCBmbG93LlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcmVkaXJlY3RVcmkgVGhlIHJlZGlyZWN0IFVSSSBhZnRlciBsb2dpbiBpcyBjb21wbGV0ZVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGxhenlBdXRoIFdoZW4gdHJ1ZSwgYWxsb3dzIGFwcGxpY2F0aW9uIHRvIGhhbmRsZSB3aGVuIHRvIGxvZ2luICggYnkgZGVmYXVsdDogZmFsc2Ugd2hpY2ggd2lsbCByZXF1aXJlIGxvZ2luIGFzIHNvb24gYXMgdGhlIGFwcGxpY2F0aW9uIGluaXRpYWxpemVzKVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFsbG93TG9jYWxFeHBpcmVkVG9rZW4gV2hlbiB0cnVlLCBleHBpcmVkIHRva2VucyBhcmUgbm90IHJlbW92ZWQgYW5kIGRvZXMgbm90IGludm9rZSBsb2dpbiAoYWxsb3dzIHRva2VuIHRvIGJlIHVzZWQgZXZlbiB3aGVuIGV4cGlyZWQgZm9yIG9mZmxpbmUgbW9kZSBhbmQgc2VydmljZSB3b3JrZXJzKS5cbiAgICovXG4gIHB1YmxpYyBjaGVja0ZvclRva2VuKHJlZGlyZWN0VXJpPzogc3RyaW5nLCBsYXp5QXV0aD86IGJvb2xlYW4sIGFsbG93TG9jYWxFeHBpcmVkVG9rZW4/OiBib29sZWFuKSB7XG4gICAvLyBjb25zb2xlLmxvZygncmVkaXJlY3QgdXJpJywgcmVkaXJlY3RVcmkpO1xuICAgIGxldCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgVVJMIGhhcyB0b2tlbiAocmVkaXJlY3RlZCBiYWNrIGZyb20gb2F1dGgpXG4gICAgaWYgKGhhc2ggJiYgaGFzaC5pbmRleE9mKCdhY2Nlc3NfdG9rZW4nKSA+IC0xKSB7XG4gICAgICBcbiAgICAgIC8vIFdlIGhhdmUgYSB0b2tlbiBpbiB0aGUgVVJMLCBwYXJzZSBpdFxuICAgICAgdGhpcy5wYXJzZVRva2VuKGhhc2gpO1xuICAgICAgXG4gICAgfSBlbHNlIGlmICh0aGlzLnVzZUxvY2FsU3RvcmUgJiYgIW5hdmlnYXRvci5vbkxpbmUpIHtcbiAgICAgIC8vIE9ubHkgdXNlIGxvY2FsIHN0b3JhZ2UgaWYgYXBwbGljYXRpb24gaXMgb2ZmbGluZVxuICAgICAgLy8gdGhpcyBpcyB0byByZWZyZXNoIGV4cGlyZWQgdG9rZW5zIGJlZm9yZSBjaGVjayB0b2tlbiBpcyBlbmFibGVkLCB3aGVuIHRoZXJlIGlzIGNvbm5lY3Rpdml0eVxuICAgICAgXG4gICAgICAvLyBDaGVjayBpZiBsb2NhbCBzdG9yYWdlIGhhcyBhIHRva2VuXG4gICAgICBsZXQgdG9rZW5TdG9yZTogYW55ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5MT0NBTF9TVE9SQUdFX0tFWSk7XG4gICAgICBcbiAgICAgIC8vIFBhcnNlIHRoZSB0b2tlblxuICAgICAgaWYgKHRva2VuU3RvcmUpIHtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdG9rZW5TdG9yZSA9IEpTT04ucGFyc2UodG9rZW5TdG9yZSk7XG4gICAgICAgICAgdGhpcy5pbml0QXV0aEZyb21TZXNzaW9uKCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIEZhaWxlZCB0byBwYXJzZSB0aGUgdG9rZW4sIHJlbW92ZSB0aGUgb2xkIHRva2VuIGFuZCBnZXQgYSBuZXcgdG9rZW4gYnkgbG9nZ2luZyBpbiBhZ2FpblxuICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gcmVhZCBzZXNzaW9uIHRva2VuIC0gcmVpbml0aWFsaXppbmcnKTtcbiAgICAgICAgICB0aGlzLnRva2VuRGV0YWlscyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLkxPQ0FMX1NUT1JBR0VfS0VZKTtcbiAgICAgICAgICB0aGlzLmluaXRJbXBsaWNpdEZsb3cocmVkaXJlY3RVcmkpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgfWVsc2V7XG4gICAgICAgIC8vIG5vIHRva2VuIHdhcyBmb3VuZCBpbml0aWF0ZSBsb2dpblxuICAgICAgICB0aGlzLmluaXRJbXBsaWNpdEZsb3cocmVkaXJlY3RVcmkpXG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIHRva2VuIGlzIGV4cGlyZWQgaWYgaXQgaXMgbm90IGFsbG93ZWRcbiAgICAgIGlmICghYWxsb3dMb2NhbEV4cGlyZWRUb2tlbiAmJiB0aGlzLmlzVG9rZW5FeHBpcmVkKHRoaXMudG9rZW5EZXRhaWxzKSkge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLkxPQ0FMX1NUT1JBR0VfS0VZKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuaW5pdEltcGxpY2l0RmxvdyhyZWRpcmVjdFVyaSk7XG4gICAgICB9XG4gICAgICBcbiAgICB9IGVsc2UgaWYgKGhhc2ggJiYgaGFzaC5pbmRleE9mKCdlcnJvcicpID4gLTEpIHtcbiAgICAgIFxuICAgICAgYWxlcnQoJ0Vycm9yIG9jY3VycmVkIGR1cmluZyBhdXRoZW50aWNhdGlvbi4nKTtcbiAgICAgIHJldHVybjtcbiAgICAgIFxuICAgIH0gZWxzZSB7XG4gICAgICBcbiAgICAgIC8vIGxvZ2luIGlmIGxhenkgYXV0aCBub3QgZW5hYmxlZCBhcyB3ZSBuZWVkIGEgdG9rZW5cbiAgICAgIGlmICghbGF6eUF1dGgpIHtcbiAgICAgICAgdGhpcy5pbml0SW1wbGljaXRGbG93KHJlZGlyZWN0VXJpKTtcbiAgICAgIH1cbiAgICAgIFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpc1Rva2VuRXhwaXJlZCh0b2tlbik6IGJvb2xlYW4ge1xuICAgIGxldCBleHBpcnlEYXRlO1xuICAgIGxldCBub3cgPSBtb21lbnQoKTtcbiAgICBpZiAodG9rZW4gJiYgdG9rZW4uZXhwKSB7XG4gICAgICBleHBpcnlEYXRlID0gbW9tZW50LnVuaXgodG9rZW4uZXhwKTtcbiAgICAgIGlmIChub3cuaXNCZWZvcmUoZXhwaXJ5RGF0ZSkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qXG4gICAqIFBhcnNlIHRva2VuIGZyb20gYSBoYXNoIGZyYWdtZW50XG4gICAqIEV4YW1wbGU6XG4gICAqICAgICNhY2Nlc3NfdG9rZW49QUJDJnRva2VuX3R5cGU9YmVhcmVyJnN0YXRlPSZleHBpcmVzX2luPTQzMTk5JnNjb3BlPVdGSU0uR0VUX1dJTERGSVJFX0lOQ0lERU5UJTIwV0ZPUkcuR0VUX09SR19VTklUUyUmanRpPTNhNjQyYjUzLWQ5MGUtNGVlMy1hMDBjLTVjZDc4MDE1NTIyNVxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZVRva2VuKGhhc2gpIHtcbiAgICBpZiAoaGFzaC5zdGFydHNXaXRoKCcjJykpIHtcbiAgICAgIGhhc2ggPSBoYXNoLnN1YnN0cigxKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzcG9uc2VQYXJhbWV0ZXJzID0gKGhhc2gpLnNwbGl0KFwiJlwiKTtcbiAgICBsZXQgcGFyYW1ldGVyTWFwID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNwb25zZVBhcmFtZXRlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHBhcmFtZXRlck1hcFsgcmVzcG9uc2VQYXJhbWV0ZXJzWyBpIF0uc3BsaXQoXCI9XCIpWyAwIF0gXSA9IHJlc3BvbnNlUGFyYW1ldGVyc1sgaSBdLnNwbGl0KFwiPVwiKVsgMSBdO1xuICAgIH1cblxuICAgIGlmIChwYXJhbWV0ZXJNYXBbICdhY2Nlc3NfdG9rZW4nIF0gIT09IHVuZGVmaW5lZCAmJiBwYXJhbWV0ZXJNYXBbICdhY2Nlc3NfdG9rZW4nIF0gIT09IG51bGwpIHtcbiAgICAgIGxvY2F0aW9uLmhhc2ggPSAnJztcbiAgICAgIHRoaXMuaW5pdEF1dGgocGFyYW1ldGVyTWFwKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBTZXQgYXV0aGVudGljYXRpb24gY29uZmlndXJhdGlvbiBhbmQgaW5pdGlhdGUgaW1wbGljaXQgZmxvd1xuICAgKi9cbiAgcHJpdmF0ZSBpbml0SW1wbGljaXRGbG93KHJlZGlyZWN0VXJpPzogc3RyaW5nKSB7XG4gICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHRoaXMuYXBwQ29uZmlnU2VydmljZS5nZXRDb25maWcoKTtcbiAgICBsZXQgYXV0aENvbmZpZyA9IHtcbiAgICAgIG9pZGM6IGZhbHNlLFxuICAgICAgaXNzdWVyOiBjb25maWd1cmF0aW9uLmFwcGxpY2F0aW9uLmJhc2VVcmwsXG4gICAgICBsb2dpblVybDogY29uZmlndXJhdGlvbi53ZWJhZGUub2F1dGgyVXJsLFxuICAgICAgcmVkaXJlY3RVcmk6IHJlZGlyZWN0VXJpID8gcmVkaXJlY3RVcmkgOiB3aW5kb3cubG9jYXRpb24uaHJlZixcbiAgICAgIGNsaWVudElkOiBjb25maWd1cmF0aW9uLndlYmFkZS5jbGllbnRJZCxcbiAgICAgIHNjb3BlOiBjb25maWd1cmF0aW9uLndlYmFkZS5hdXRoU2NvcGVzXG4gICAgfTtcblxuICAgLy8gY29uc29sZS5sb2coJ2F1dGhDb25maWcnLCBhdXRoQ29uZmlnKTtcbiAgICBjb25zdCBvYXV0aFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChPQXV0aFNlcnZpY2UpO1xuICAgIG9hdXRoU2VydmljZS5jb25maWd1cmUoYXV0aENvbmZpZyk7XG4gICAgb2F1dGhTZXJ2aWNlLmluaXRJbXBsaWNpdEZsb3coKTtcbiAgfVxuXG4gICAgLypcbiAgICAgKiBTZXQgYXV0aGVudGljYXRpb24gY29uZmlndXJhdGlvbiBhbmQgaW5pdGlhdGUgcmVmcmVzaCB0b2tlbiBpbXBsaWNpdCBmbG93XG4gICAgICovXG4gICAgcHVibGljIGluaXRSZWZyZXNoVG9rZW5JbXBsaWNpdEZsb3coYXV0aG9yaXplVVJMOiBzdHJpbmcsIHN0b3JhZ2VLZXk6IHN0cmluZywgZXJyb3JDYWxsYmFjazogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9ICdyZXNpemFibGU9eWVzLHNjcm9sbGJhcnM9eWVzLHN0YXR1c2Jhcj15ZXMsc3RhdHVzPXllcyc7XG4gICAgICAgIGxldCByZWZyZXNoV2luZG93ID0gd2luZG93Lm9wZW4oYXV0aG9yaXplVVJMLCBudWxsLCBvcHRpb25zKTtcbiAgICAgICAgbGV0IHJlZnJlc2hBc3luYyA9IG5ldyBBc3luY1N1YmplY3QoKTtcblxuICAgICAgICBsZXQgcmVmcmVzaEludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZWZyZXNoV2luZG93KSB7XG4gICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnU2Vzc2lvbiBFeHBpcmVkLiBVbmFibGUgdG8gb3BlbiByZWZyZXNoIHdpbmRvdy4gUGxlYXNlIGFsbG93IHBvcC11cHMuJyk7XG4gICAgICAgICAgICAgICAgcmVmcmVzaFdpbmRvdyA9IHdpbmRvdy5vcGVuKGF1dGhvcml6ZVVSTCwgbnVsbCwgb3B0aW9ucyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWZyZXNoV2luZG93ICYmIHJlZnJlc2hXaW5kb3cuY2xvc2VkKSB7XG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChyZWZyZXNoSW50ZXJ2YWwpO1xuICAgICAgICAgICAgICAgIGxldCBuZXdUb2tlbiA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShgJHtzdG9yYWdlS2V5fWApO1xuICAgICAgICAgICAgICAgIG5ld1Rva2VuID0gSlNPTi5wYXJzZShuZXdUb2tlbik7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGAke3N0b3JhZ2VLZXl9YCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUb2tlbihuZXdUb2tlbik7XG4gICAgICAgICAgICAgICAgcmVmcmVzaEFzeW5jLm5leHQobmV3VG9rZW4pO1xuICAgICAgICAgICAgICAgIHJlZnJlc2hBc3luYy5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCA1MDApO1xuXG4gICAgICAgIHJldHVybiByZWZyZXNoQXN5bmMuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gIC8qXG4gICAqIGluaXRpYWxpemUgYXV0aGVudGljYXRpb24gZnJvbSBzZXNzaW9uIGluIGFwcGxpY2F0aW9uLCBlbWl0IHRvIHN1YnNjcmliZXJzXG4gICAqL1xuICBwcml2YXRlIGluaXRBdXRoRnJvbVNlc3Npb24oKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBsb2NhbE9hdXRoID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5MT0NBTF9TVE9SQUdFX0tFWSk7XG4gICAgICBsb2NhbE9hdXRoID0gSlNPTi5wYXJzZShsb2NhbE9hdXRoKTtcbiAgICAgIHRoaXMub2F1dGggPSBsb2NhbE9hdXRoO1xuICAgICAgdGhpcy5pbml0QW5kRW1pdCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5MT0NBTF9TVE9SQUdFX0tFWSk7XG4gICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGhhbmRsZSB0b2tlbiBwYXlsb2FkJywgdGhpcy5vYXV0aCk7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVyciwgJ0ZhaWxlZCB0byBoYW5kbGUgdG9rZW4nKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBpbml0aWFsaXplIGF1dGhlbnRpY2F0aW9uIHJlc3BvbnNlIGluIGFwcGxpY2F0aW9uLCBlbWl0IHRvIHN1YnNjcmliZXJzXG4gICAqL1xuICBwdWJsaWMgaW5pdEF1dGgocmVzcG9uc2UpIHtcbiAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICh0aGlzLnVzZUxvY2FsU3RvcmUpIHtcbiAgICAgICAgICBsZXQgdG9rZW5TdG9yZSA9IHtcbiAgICAgICAgICAgIGFjY2Vzc190b2tlbjogcmVzcG9uc2UuYWNjZXNzX3Rva2VuLFxuICAgICAgICAgICAgZXhwaXJlc19pbjogcmVzcG9uc2UuZXhwaXJlc19pblxuICAgICAgICAgIH07XG4gICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5MT0NBTF9TVE9SQUdFX0tFWSwgSlNPTi5zdHJpbmdpZnkodG9rZW5TdG9yZSkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub2F1dGggPSByZXNwb25zZTtcbiAgICAgICAgdGhpcy5pbml0QW5kRW1pdCgpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmICh0aGlzLnVzZUxvY2FsU3RvcmUpIHtcbiAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLkxPQ0FMX1NUT1JBR0VfS0VZKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGhhbmRsZSB0b2tlbiBwYXlsb2FkJywgdGhpcy5vYXV0aCk7XG4gICAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyLCAnRmFpbGVkIHRvIGhhbmRsZSB0b2tlbicpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAqIEluaXRpYWxpemUgYWxsIHRva2VuIHNlcnZpY2UgYXR0cmlidXRlcyBhbmQgZW1pdFxuICAgKi9cblxuICBwcml2YXRlIGluaXRBbmRFbWl0KCkge1xuICAgLy8gY29uc29sZS5sb2coJ2luaXQgYW5kIGVtaXQnLCB0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0Q29uZmlnKCkpO1xuICAgIGlmICh0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0Q29uZmlnKCkud2ViYWRlLmVuYWJsZUNoZWNrVG9rZW4pIHtcbiAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5hcHBDb25maWdTZXJ2aWNlLmdldENvbmZpZygpLmFwcGxpY2F0aW9uLmJhc2VVcmw7XG4gICAgICBpZiAoIWJhc2VVcmwuZW5kc1dpdGgoJy8nKSkge1xuICAgICAgICBiYXNlVXJsID0gYmFzZVVybC5jb25jYXQoJy8nKTtcbiAgICAgIH1cbiAgICAgIGxldCBjaGVja1Rva2VuVXJsID0gYCR7YmFzZVVybH0ke3RoaXMuYXBwQ29uZmlnU2VydmljZS5nZXRDb25maWcoKS53ZWJhZGUuY2hlY2tUb2tlblVybH1gO1xuXG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7dGhpcy5vYXV0aC5hY2Nlc3NfdG9rZW59YCxcbiAgICAgIH0pO1xuICAgICAvLyBjb25zb2xlLmxvZygnY2hlY2tUb2tlblVybCcsIGNoZWNrVG9rZW5VcmwpO1xuICAgICAgXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgbGV0IGh0dHAgPSBuZXcgSHR0cENsaWVudCh0aGlzLmluamVjdG9yLmdldChIdHRwSGFuZGxlcikpO1xuICBcbiAgICAgICAgaHR0cC5nZXQoY2hlY2tUb2tlblVybCwge2hlYWRlcnN9KS50b1Byb21pc2UoKVxuICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgIHRoaXMudG9rZW5EZXRhaWxzID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnYWNjZXNzX3Rva2VuJywgdGhpcy5vYXV0aC5hY2Nlc3NfdG9rZW4pO1xuICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoVG9rZW4ubmV4dCh0aGlzLm9hdXRoLmFjY2Vzc190b2tlbik7XG4gICAgICAgICAgICAgICAgICB0aGlzLmF1dGhUb2tlbi5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3Rva2VuRGV0YWlscycsIHRoaXMudG9rZW5EZXRhaWxzKTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuY3JlZGVudGlhbHMubmV4dCh0aGlzLnRva2VuRGV0YWlscyk7XG4gICAgICAgICAgICAgICAgICB0aGlzLmNyZWRlbnRpYWxzLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICwgY2F0Y2hFcnJvciggZXJyb3IgPT4ge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgIGFsZXJ0KGBBcHAgaW5pdGlhbGl6YXRpb24gRmFpbGVkICR7ZXJyb3Iuc3RhdHVzfS4gU3RhdHVzKENoZWNrIHRva2VuIGZhaWxlZClgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIFxuICAgICAgLy9TcGxpdCBmb3IgSldUXG4gICAgICBjb25zdCBvYXV0aEluZm86IHN0cmluZ1tdID0gdGhpcy5vYXV0aC5hY2Nlc3NfdG9rZW4uc3BsaXQoJy4nKTtcbiAgICAgLy8gY29uc29sZS5sb2coJ29hdXRoSW5mbycsIG9hdXRoSW5mbyk7XG4gICAgICBcbiAgICAgIGlmKG9hdXRoSW5mby5sZW5ndGggPiAxKXtcbiAgICAgICAgdGhpcy50b2tlbkRldGFpbHMgPSBKU09OLnBhcnNlKGF0b2Iob2F1dGhJbmZvWyAxIF0pKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAvLyBjb25zb2xlLmxvZygnYWNjZXNzX3Rva2VuMicsIHRoaXMub2F1dGguYWNjZXNzX3Rva2VuKTtcbiAgICAgIHRoaXMuYXV0aFRva2VuLm5leHQodGhpcy5vYXV0aC5hY2Nlc3NfdG9rZW4pO1xuICAgICAgdGhpcy5hdXRoVG9rZW4uY29tcGxldGUoKTtcbiAgICAgLy8gY29uc29sZS5sb2coJ3Rva2VuRGV0YWlsczInLCB0aGlzLnRva2VuRGV0YWlscyk7XG4gICAgICB0aGlzLmNyZWRlbnRpYWxzLm5leHQodGhpcy50b2tlbkRldGFpbHMpO1xuICAgICAgdGhpcy5jcmVkZW50aWFscy5jb21wbGV0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVRva2VuKG9hdXRoVG9rZW4pIHtcbiAgICB0aGlzLm9hdXRoID0gb2F1dGhUb2tlbjtcbiAgICB0aGlzLmluaXRBbmRFbWl0KCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0T2F1dGhUb2tlbigpIHtcbiAgICByZXR1cm4gKHRoaXMub2F1dGgpID8gdGhpcy5vYXV0aC5hY2Nlc3NfdG9rZW4gOiBudWxsO1xuICB9XG5cbiAgcHVibGljIGdldFRva2VuRGV0YWlscygpIHtcbiAgICByZXR1cm4gKHRoaXMudG9rZW5EZXRhaWxzKSA/IHRoaXMudG9rZW5EZXRhaWxzIDogbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBkb2VzVXNlckhhdmVBcHBsaWNhdGlvblBlcm1pc3Npb25zKHNjb3Blcz86IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMudG9rZW5EZXRhaWxzICYmIHRoaXMudG9rZW5EZXRhaWxzLnNjb3BlICYmIHRoaXMudG9rZW5EZXRhaWxzLnNjb3BlLmxlbmd0aCA+IDApIHtcbiAgICAgIGlmIChzY29wZXMpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY29wZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRva2VuRGV0YWlscy5zY29wZS5pbmRleE9mKHNjb3Blc1tpXSkgPT0gLTEpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgXG4gIHB1YmxpYyBjbGVhckxvY2FsU3RvcmFnZVRva2VuKCkge1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuTE9DQUxfU1RPUkFHRV9LRVkpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnIsIG1lc3NhZ2U/KSB7XG4gICAgY29uc29sZS5lcnJvcignVW5leHBlY3RlZCBlcnJvcicsIGVycik7XG4gICAgYWxlcnQobWVzc2FnZSA/IG1lc3NhZ2UgKyAnICcgKyBlcnIgOiAnJyArIGVycik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbn1cbiJdfQ==