/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EventEmitter, Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { fromEvent, timer } from 'rxjs';
import { debounceTime, delay, retryWhen, startWith, switchMap, tap } from 'rxjs/operators';
import { HttpClient } from '@angular/common/http';
import * as _ from 'lodash';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * Instance of this interface is used to report current connection status.
 * @record
 */
export function ConnectionState() { }
if (false) {
    /**
     * "True" if browser has network connection. Determined by Window objects "online" / "offline" events.
     * @type {?}
     */
    ConnectionState.prototype.hasNetworkConnection;
    /**
     * "True" if browser has Internet access. Determined by heartbeat system which periodically makes request to heartbeat Url.
     * @type {?}
     */
    ConnectionState.prototype.hasInternetAccess;
}
/**
 * Instance of this interface could be used to configure "ConnectionService".
 * @record
 */
export function ConnectionServiceOptions() { }
if (false) {
    /**
     * Controls the Internet connectivity heartbeat system. Default value is 'true'.
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.enableHeartbeat;
    /**
     * Url used for checking Internet connectivity, heartbeat system periodically makes "HEAD" requests to this URL to determine Internet
     * connection status. Default value is "//server.test-cors.org".
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.heartbeatUrl;
    /**
     * Callback function to used for executing heartbeat requests. Defaults to HttpClient.request(...) function.
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.heartbeatExecutor;
    /**
     * Interval used to check Internet connectivity specified in milliseconds. Default value is "30000".
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.heartbeatInterval;
    /**
     * Interval used to retry Internet connectivity checks when an error is detected (when no Internet connection). Default value is "1000".
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.heartbeatRetryInterval;
    /**
     * HTTP method used for requesting heartbeat Url. Default is 'head'.
     * @type {?|undefined}
     */
    ConnectionServiceOptions.prototype.requestMethod;
}
/**
 * InjectionToken for specifing ConnectionService options.
 * @type {?}
 */
export var ConnectionServiceOptionsToken = new InjectionToken('ConnectionServiceOptionsToken');
var ConnectionService = /** @class */ (function () {
    function ConnectionService(http, options) {
        var _this = this;
        this.http = http;
        this.stateChangeEventEmitter = new EventEmitter();
        this.currentState = {
            hasInternetAccess: false,
            hasNetworkConnection: window.navigator.onLine
        };
        this.serviceOptions = _.defaults({}, options, ConnectionService.DEFAULT_OPTIONS, {
            heartbeatExecutor: (/**
             * @return {?}
             */
            function () { return _this.http.request(_this.serviceOptions.requestMethod, _this.serviceOptions.heartbeatUrl, { responseType: 'text' }); }),
        });
        this.checkNetworkState();
        this.checkInternetState();
    }
    Object.defineProperty(ConnectionService.prototype, "options", {
        /**
         * Current ConnectionService options. Notice that changing values of the returned object has not effect on service execution.
         * You should use "updateOptions" function.
         */
        get: /**
         * Current ConnectionService options. Notice that changing values of the returned object has not effect on service execution.
         * You should use "updateOptions" function.
         * @return {?}
         */
        function () {
            return _.clone(this.serviceOptions);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @return {?}
     */
    ConnectionService.prototype.checkInternetState = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (!_.isNil(this.httpSubscription)) {
            this.httpSubscription.unsubscribe();
        }
        if (this.serviceOptions.enableHeartbeat) {
            this.httpSubscription = timer(0, this.serviceOptions.heartbeatInterval)
                .pipe(switchMap((/**
             * @return {?}
             */
            function () { return _this.serviceOptions.heartbeatExecutor(_this.serviceOptions); })), retryWhen((/**
             * @param {?} errors
             * @return {?}
             */
            function (errors) {
                return errors.pipe(
                // log error message
                tap((/**
                 * @param {?} val
                 * @return {?}
                 */
                function (val) {
                    console.error('Http error:', val);
                    _this.currentState.hasInternetAccess = false;
                    _this.emitEvent();
                })), 
                // restart after 5 seconds
                delay(_this.serviceOptions.heartbeatRetryInterval));
            })))
                .subscribe((/**
             * @param {?} result
             * @return {?}
             */
            function (result) {
                _this.currentState.hasInternetAccess = true;
                _this.emitEvent();
            }));
        }
        else {
            this.currentState.hasInternetAccess = false;
            this.emitEvent();
        }
    };
    /**
     * @private
     * @return {?}
     */
    ConnectionService.prototype.checkNetworkState = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.onlineSubscription = fromEvent(window, 'online').subscribe((/**
         * @return {?}
         */
        function () {
            _this.currentState.hasNetworkConnection = true;
            _this.checkInternetState();
            _this.emitEvent();
        }));
        this.offlineSubscription = fromEvent(window, 'offline').subscribe((/**
         * @return {?}
         */
        function () {
            _this.currentState.hasNetworkConnection = false;
            _this.checkInternetState();
            _this.emitEvent();
        }));
    };
    /**
     * @private
     * @return {?}
     */
    ConnectionService.prototype.emitEvent = /**
     * @private
     * @return {?}
     */
    function () {
        this.stateChangeEventEmitter.emit(this.currentState);
    };
    /**
     * @return {?}
     */
    ConnectionService.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        try {
            this.offlineSubscription.unsubscribe();
            this.onlineSubscription.unsubscribe();
            this.httpSubscription.unsubscribe();
        }
        catch (e) {
        }
    };
    /**
     * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
     * function will not report current status of the connections when initially subscribed.
     * @param reportCurrentState Report current state when initial subscription. Default is "true"
     */
    /**
     * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
     * function will not report current status of the connections when initially subscribed.
     * @param {?=} reportCurrentState Report current state when initial subscription. Default is "true"
     * @return {?}
     */
    ConnectionService.prototype.monitor = /**
     * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
     * function will not report current status of the connections when initially subscribed.
     * @param {?=} reportCurrentState Report current state when initial subscription. Default is "true"
     * @return {?}
     */
    function (reportCurrentState) {
        if (reportCurrentState === void 0) { reportCurrentState = true; }
        return reportCurrentState ?
            this.stateChangeEventEmitter.pipe(debounceTime(300), startWith(this.currentState))
            :
                this.stateChangeEventEmitter.pipe(debounceTime(300));
    };
    /**
     * Update options of the service. You could specify partial options object. Values that are not specified will use default / previous
     * option values.
     * @param options Partial option values.
     */
    /**
     * Update options of the service. You could specify partial options object. Values that are not specified will use default / previous
     * option values.
     * @param {?} options Partial option values.
     * @return {?}
     */
    ConnectionService.prototype.updateOptions = /**
     * Update options of the service. You could specify partial options object. Values that are not specified will use default / previous
     * option values.
     * @param {?} options Partial option values.
     * @return {?}
     */
    function (options) {
        this.serviceOptions = _.defaults({}, options, this.serviceOptions);
        this.checkInternetState();
    };
    ConnectionService.DEFAULT_OPTIONS = {
        enableHeartbeat: true,
        heartbeatUrl: '//server.test-cors.org/server?id=' + Date.now() + '&enable=true&status=200&credentials=false',
        heartbeatInterval: 30000,
        heartbeatRetryInterval: 1000,
        requestMethod: 'head',
    };
    ConnectionService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ConnectionService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: undefined, decorators: [{ type: Inject, args: [ConnectionServiceOptionsToken,] }, { type: Optional }] }
    ]; };
    /** @nocollapse */ ConnectionService.ngInjectableDef = i0.defineInjectable({ factory: function ConnectionService_Factory() { return new ConnectionService(i0.inject(i1.HttpClient), i0.inject(ConnectionServiceOptionsToken, 8)); }, token: ConnectionService, providedIn: "root" });
    return ConnectionService;
}());
export { ConnectionService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ConnectionService.DEFAULT_OPTIONS;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.stateChangeEventEmitter;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.currentState;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.offlineSubscription;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.onlineSubscription;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.httpSubscription;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.serviceOptions;
    /**
     * @type {?}
     * @private
     */
    ConnectionService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi1zZXJ2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtY29ubmVjdGlvbi1zZXJ2aWNlLyIsInNvdXJjZXMiOlsibGliL2Nvbm5lY3Rpb24tc2VydmljZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFhLFFBQVEsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNwRyxPQUFPLEVBQUMsU0FBUyxFQUE0QixLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekYsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sS0FBSyxDQUFDLE1BQU0sUUFBUSxDQUFDOzs7Ozs7O0FBSzVCLHFDQVNDOzs7Ozs7SUFMQywrQ0FBOEI7Ozs7O0lBSTlCLDRDQUEyQjs7Ozs7O0FBTTdCLDhDQTJCQzs7Ozs7O0lBdkJDLG1EQUEwQjs7Ozs7O0lBSzFCLGdEQUFzQjs7Ozs7SUFJdEIscURBQTRFOzs7OztJQUk1RSxxREFBMkI7Ozs7O0lBSTNCLDBEQUFnQzs7Ozs7SUFJaEMsaURBQW9EOzs7Ozs7QUFPdEQsTUFBTSxLQUFPLDZCQUE2QixHQUE2QyxJQUFJLGNBQWMsQ0FBQywrQkFBK0IsQ0FBQztBQUUxSTtJQStCRSwyQkFBb0IsSUFBZ0IsRUFBcUQsT0FBaUM7UUFBMUgsaUJBZUM7UUFmbUIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQW5CNUIsNEJBQXVCLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFFOUQsaUJBQVksR0FBb0I7WUFDdEMsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixvQkFBb0IsRUFBRSxNQUFNLENBQUMsU0FBUyxD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QUUsSUFBSTtRQUNyQixZQUFZLEVBQUUsbUNBQW1DLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLDJDQUEyQztRQUM1RyxpQkFBaUIsRUFBRSxLQUFLO1FBQ3hCLHNCQUFzQixFQUFFLElBQUk7UUFDNUIsYUFBYSxFQUFFLE1BQU07S0FDdEIsQ0FBQzs7Z0JBVkgsVUFBVSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7OztnQkF4RE8sVUFBVTtnREFxRnVCLE1BQU0sU0FBQyw2QkFBNkIsY0FBRyxRQUFROzs7NEJBeEZ4RjtDQWdNQyxBQXZJRCxJQXVJQztTQXBJWSxpQkFBaUI7Ozs7OztJQUM1QixrQ0FNRTs7Ozs7SUFFRixvREFBc0U7Ozs7O0lBRXRFLHlDQUdFOzs7OztJQUNGLGdEQUEwQzs7Ozs7SUFDMUMsK0NBQXlDOzs7OztJQUN6Qyw2Q0FBdUM7Ozs7O0lBQ3ZDLDJDQUFpRDs7Ozs7SUFVckMsaUNBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9uRGVzdHJveSwgT3B0aW9uYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtmcm9tRXZlbnQsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiwgdGltZXJ9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtkZWJvdW5jZVRpbWUsIGRlbGF5LCByZXRyeVdoZW4sIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuXG4vKipcbiAqIEluc3RhbmNlIG9mIHRoaXMgaW50ZXJmYWNlIGlzIHVzZWQgdG8gcmVwb3J0IGN1cnJlbnQgY29ubmVjdGlvbiBzdGF0dXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvblN0YXRlIHtcbiAgLyoqXG4gICAqIFwiVHJ1ZVwiIGlmIGJyb3dzZXIgaGFzIG5ldHdvcmsgY29ubmVjdGlvbi4gRGV0ZXJtaW5lZCBieSBXaW5kb3cgb2JqZWN0cyBcIm9ubGluZVwiIC8gXCJvZmZsaW5lXCIgZXZlbnRzLlxuICAgKi9cbiAgaGFzTmV0d29ya0Nvbm5lY3Rpb246IGJvb2xlYW47XG4gIC8qKlxuICAgKiBcIlRydWVcIiBpZiBicm93c2VyIGhhcyBJbnRlcm5ldCBhY2Nlc3MuIERldGVybWluZWQgYnkgaGVhcnRiZWF0IHN5c3RlbSB3aGljaCBwZXJpb2RpY2FsbHkgbWFrZXMgcmVxdWVzdCB0byBoZWFydGJlYXQgVXJsLlxuICAgKi9cbiAgaGFzSW50ZXJuZXRBY2Nlc3M6IGJvb2xlYW47XG59XG5cbi8qKlxuICogSW5zdGFuY2Ugb2YgdGhpcyBpbnRlcmZhY2UgY291bGQgYmUgdXNlZCB0byBjb25maWd1cmUgXCJDb25uZWN0aW9uU2VydmljZVwiLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBDb250cm9scyB0aGUgSW50ZXJuZXQgY29ubmVjdGl2aXR5IGhlYXJ0YmVhdCBzeXN0ZW0uIERlZmF1bHQgdmFsdWUgaXMgJ3RydWUnLlxuICAgKi9cbiAgZW5hYmxlSGVhcnRiZWF0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFVybCB1c2VkIGZvciBjaGVja2luZyBJbnRlcm5ldCBjb25uZWN0aXZpdHksIGhlYXJ0YmVhdCBzeXN0ZW0gcGVyaW9kaWNhbGx5IG1ha2VzIFwiSEVBRFwiIHJlcXVlc3RzIHRvIHRoaXMgVVJMIHRvIGRldGVybWluZSBJbnRlcm5ldFxuICAgKiBjb25uZWN0aW9uIHN0YXR1cy4gRGVmYXVsdCB2YWx1ZSBpcyBcIi8vc2VydmVyLnRlc3QtY29ycy5vcmdcIi5cbiAgICovXG4gIGhlYXJ0YmVhdFVybD86IHN0cmluZztcbiAgLyoqXG4gICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIHVzZWQgZm9yIGV4ZWN1dGluZyBoZWFydGJlYXQgcmVxdWVzdHMuIERlZmF1bHRzIHRvIEh0dHBDbGllbnQucmVxdWVzdCguLi4pIGZ1bmN0aW9uLlxuICAgKi9cbiAgaGVhcnRiZWF0RXhlY3V0b3I/OiAob3B0aW9ucz86IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucykgPT4gT2JzZXJ2YWJsZTxhbnk+O1xuICAvKipcbiAgICogSW50ZXJ2YWwgdXNlZCB0byBjaGVjayBJbnRlcm5ldCBjb25uZWN0aXZpdHkgc3BlY2lmaWVkIGluIG1pbGxpc2Vjb25kcy4gRGVmYXVsdCB2YWx1ZSBpcyBcIjMwMDAwXCIuXG4gICAqL1xuICBoZWFydGJlYXRJbnRlcnZhbD86IG51bWJlcjtcbiAgLyoqXG4gICAqIEludGVydmFsIHVzZWQgdG8gcmV0cnkgSW50ZXJuZXQgY29ubmVjdGl2aXR5IGNoZWNrcyB3aGVuIGFuIGVycm9yIGlzIGRldGVjdGVkICh3aGVuIG5vIEludGVybmV0IGNvbm5lY3Rpb24pLiBEZWZhdWx0IHZhbHVlIGlzIFwiMTAwMFwiLlxuICAgKi9cbiAgaGVhcnRiZWF0UmV0cnlJbnRlcnZhbD86IG51bWJlcjtcbiAgLyoqXG4gICAqIEhUVFAgbWV0aG9kIHVzZWQgZm9yIHJlcXVlc3RpbmcgaGVhcnRiZWF0IFVybC4gRGVmYXVsdCBpcyAnaGVhZCcuXG4gICAqL1xuICByZXF1ZXN0TWV0aG9kPzogJ2dldCcgfCAncG9zdCcgfCAnaGVhZCcgfCAnb3B0aW9ucyc7XG5cbn1cblxuLyoqXG4gKiBJbmplY3Rpb25Ub2tlbiBmb3Igc3BlY2lmaW5nIENvbm5lY3Rpb25TZXJ2aWNlIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBjb25zdCBDb25uZWN0aW9uU2VydmljZU9wdGlvbnNUb2tlbjogSW5qZWN0aW9uVG9rZW48Q29ubmVjdGlvblNlcnZpY2VPcHRpb25zPiA9IG5ldyBJbmplY3Rpb25Ub2tlbignQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW4nKTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvblNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX09QVElPTlM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyA9IHtcbiAgICBlbmFibGVIZWFydGJlYXQ6IHRydWUsXG4gICAgaGVhcnRiZWF0VXJsOiAnLy9zZXJ2ZXIudGVzdC1jb3JzLm9yZy9zZXJ2ZXI/aWQ9JyArIERhdGUubm93KCkgKyAnJmVuYWJsZT10cnVlJnN0YXR1cz0yMDAmY3JlZGVudGlhbHM9ZmFsc2UnLFxuICAgIGhlYXJ0YmVhdEludGVydmFsOiAzMDAwMCxcbiAgICBoZWFydGJlYXRSZXRyeUludGVydmFsOiAxMDAwLFxuICAgIHJlcXVlc3RNZXRob2Q6ICdoZWFkJyxcbiAgfTtcblxuICBwcml2YXRlIHN0YXRlQ2hhbmdlRXZlbnRFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcjxDb25uZWN0aW9uU3RhdGU+KCk7XG5cbiAgcHJpdmF0ZSBjdXJyZW50U3RhdGU6IENvbm5lY3Rpb25TdGF0ZSA9IHtcbiAgICBoYXNJbnRlcm5ldEFjY2VzczogZmFsc2UsXG4gICAgaGFzTmV0d29ya0Nvbm5lY3Rpb246IHdpbmRvdy5uYXZpZ2F0b3Iub25MaW5lXG4gIH07XG4gIHByaXZhdGUgb2ZmbGluZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIG9ubGluZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIGh0dHBTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBzZXJ2aWNlT3B0aW9uczogQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBDdXJyZW50IENvbm5lY3Rpb25TZXJ2aWNlIG9wdGlvbnMuIE5vdGljZSB0aGF0IGNoYW5naW5nIHZhbHVlcyBvZiB0aGUgcmV0dXJuZWQgb2JqZWN0IGhhcyBub3QgZWZmZWN0IG9uIHNlcnZpY2UgZXhlY3V0aW9uLlxuICAgKiBZb3Ugc2hvdWxkIHVzZSBcInVwZGF0ZU9wdGlvbnNcIiBmdW5jdGlvbi5cbiAgICovXG4gIGdldCBvcHRpb25zKCk6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyB7XG4gICAgcmV0dXJuIF8uY2xvbmUodGhpcy5zZXJ2aWNlT3B0aW9ucyk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIEBJbmplY3QoQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW4pIEBPcHRpb25hbCgpIG9wdGlvbnM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucykge1xuICAgIHRoaXMuc2VydmljZU9wdGlvbnMgPSBfLmRlZmF1bHRzKFxuICAgICAge30sXG4gICAgICBvcHRpb25zLFxuICAgICAgQ29ubmVjdGlvblNlcnZpY2UuREVGQVVMVF9PUFRJT05TLFxuICAgICAge1xuICAgICAgICBoZWFydGJlYXRFeGVjdXRvcjogKCkgPT4gdGhpcy5odHRwLnJlcXVlc3QoXG4gICAgICAgICAgdGhpcy5zZXJ2aWNlT3B0aW9ucy5yZXF1ZXN0TWV0aG9kLFxuICAgICAgICAgIHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0VXJsLFxuICAgICAgICAgIHtyZXNwb25zZVR5cGU6ICd0ZXh0J31cbiAgICAgICAgKSxcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5jaGVja05ldHdvcmtTdGF0ZSgpO1xuICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrSW50ZXJuZXRTdGF0ZSgpIHtcblxuICAgIGlmICghXy5pc05pbCh0aGlzLmh0dHBTdWJzY3JpcHRpb24pKSB7XG4gICAgICB0aGlzLmh0dHBTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zZXJ2aWNlT3B0aW9ucy5lbmFibGVIZWFydGJlYXQpIHtcbiAgICAgIHRoaXMuaHR0cFN1YnNjcmlwdGlvbiA9IHRpbWVyKDAsIHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0SW50ZXJ2YWwpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnNlcnZpY2VPcHRpb25zLmhlYXJ0YmVhdEV4ZWN1dG9yKHRoaXMuc2VydmljZU9wdGlvbnMpKSxcbiAgICAgICAgICByZXRyeVdoZW4oZXJyb3JzID0+XG4gICAgICAgICAgICBlcnJvcnMucGlwZShcbiAgICAgICAgICAgICAgLy8gbG9nIGVycm9yIG1lc3NhZ2VcbiAgICAgICAgICAgICAgdGFwKHZhbCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignSHR0cCBlcnJvcjonLCB2YWwpO1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc0ludGVybmV0QWNjZXNzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0RXZlbnQoKTtcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIC8vIHJlc3RhcnQgYWZ0ZXIgNSBzZWNvbmRzXG4gICAgICAgICAgICAgIGRlbGF5KHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0UmV0cnlJbnRlcnZhbClcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc0ludGVybmV0QWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLmVtaXRFdmVudCgpO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzSW50ZXJuZXRBY2Nlc3MgPSBmYWxzZTtcbiAgICAgIHRoaXMuZW1pdEV2ZW50KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja05ldHdvcmtTdGF0ZSgpIHtcbiAgICB0aGlzLm9ubGluZVN1YnNjcmlwdGlvbiA9IGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzTmV0d29ya0Nvbm5lY3Rpb24gPSB0cnVlO1xuICAgICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcbiAgICAgIHRoaXMuZW1pdEV2ZW50KCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLm9mZmxpbmVTdWJzY3JpcHRpb24gPSBmcm9tRXZlbnQod2luZG93LCAnb2ZmbGluZScpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNOZXR3b3JrQ29ubmVjdGlvbiA9IGZhbHNlO1xuICAgICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcbiAgICAgIHRoaXMuZW1pdEV2ZW50KCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRFdmVudCgpIHtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlRXZlbnRFbWl0dGVyLmVtaXQodGhpcy5jdXJyZW50U3RhdGUpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMub2ZmbGluZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5vbmxpbmVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMuaHR0cFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTW9uaXRvciBOZXR3b3JrICYgSW50ZXJuZXQgY29ubmVjdGlvbiBzdGF0dXMgYnkgc3Vic2NyaWJpbmcgdG8gdGhpcyBvYnNlcnZlci4gSWYgeW91IHNldCBcInJlcG9ydEN1cnJlbnRTdGF0ZVwiIHRvIFwiZmFsc2VcIiB0aGVuXG4gICAqIGZ1bmN0aW9uIHdpbGwgbm90IHJlcG9ydCBjdXJyZW50IHN0YXR1cyBvZiB0aGUgY29ubmVjdGlvbnMgd2hlbiBpbml0aWFsbHkgc3Vic2NyaWJlZC5cbiAgICogQHBhcmFtIHJlcG9ydEN1cnJlbnRTdGF0ZSBSZXBvcnQgY3VycmVudCBzdGF0ZSB3aGVuIGluaXRpYWwgc3Vic2NyaXB0aW9uLiBEZWZhdWx0IGlzIFwidHJ1ZVwiXG4gICAqL1xuICBtb25pdG9yKHJlcG9ydEN1cnJlbnRTdGF0ZSA9IHRydWUpOiBPYnNlcnZhYmxlPENvbm5lY3Rpb25TdGF0ZT4ge1xuICAgIHJldHVybiByZXBvcnRDdXJyZW50U3RhdGUgP1xuICAgICAgdGhpcy5zdGF0ZUNoYW5nZUV2ZW50RW1pdHRlci5waXBlKFxuICAgICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgICAgc3RhcnRXaXRoKHRoaXMuY3VycmVudFN0YXRlKSxcbiAgICAgIClcbiAgICAgIDpcbiAgICAgIHRoaXMuc3RhdGVDaGFuZ2VFdmVudEVtaXR0ZXIucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMClcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIG9wdGlvbnMgb2YgdGhlIHNlcnZpY2UuIFlvdSBjb3VsZCBzcGVjaWZ5IHBhcnRpYWwgb3B0aW9ucyBvYmplY3QuIFZhbHVlcyB0aGF0IGFyZSBub3Qgc3BlY2lmaWVkIHdpbGwgdXNlIGRlZmF1bHQgLyBwcmV2aW91c1xuICAgKiBvcHRpb24gdmFsdWVzLlxuICAgKiBAcGFyYW0gb3B0aW9ucyBQYXJ0aWFsIG9wdGlvbiB2YWx1ZXMuXG4gICAqL1xuICB1cGRhdGVPcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8Q29ubmVjdGlvblNlcnZpY2VPcHRpb25zPikge1xuICAgIHRoaXMuc2VydmljZU9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCB0aGlzLnNlcnZpY2VPcHRpb25zKTtcbiAgICB0aGlzLmNoZWNrSW50ZXJuZXRTdGF0ZSgpO1xuICB9XG5cbn1cbiJdfQ==