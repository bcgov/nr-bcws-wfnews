var Util={},baseUrl;Util.stopProp=function(t){L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousewheel",L.DomEvent.stopPropagation),L.DomEvent.on(t,"click",L.DomEvent.stopPropagation)},Util.setLibraryBaseURL=function(t){"/"!=(baseUrl=new URL(t,document.location).toString()).substr(-1)&&(baseUrl+="/")},Util.resolveLibraryRelativeURL=function(t){return new URL(t,baseUrl).toString()},Util.setLibraryBaseURL("."),Util.marker=function(t,e){return L.marker(Util.toLatLng(t),{icon:e})},Util.toLatLng=function(t){return t?[t[1],t[0]]:t},Util.toLonLat=function(t){return t?[t.lng,t.lat]:null};var DIRECTION_IND=["N","NE","E","SE","S","SW","W","NW","N"];function map(t,e){for(var i=[],n=0;n<t.length;n++){var a=e(t[n],n);null!=a&&i.push(a)}return i}function find(t,e){for(var i=0;i<t.length;i++){var n=e(t[i],i);if(n)return n}return null}function infoProps$1(t,e,i){return e?infoPropsFromAttr(t,e,i):infoPropsRaw(t)}function infoPropsFromAttr(t,e,i){for(var n=[],a=0;a<e.length;a++){var o=e[a].name,r=e[a].format;!r&&o&&(r="${"+o+"}");var s=null;r&&(s=infoPropDisplayValue(t,r,i)),n.push({name:e[a].title,value:s,description:e[a].description,action:e[a].action})}return n}function sexagesimalFraction(t,e,i){var n=Math.sign(t);t=Math.abs(t);for(var a=[],o=1;o<e;o++){var r=Math.floor(t);t=60*(t-r),a.push(r)}return a.push(t),i(n,a)}function unSexagesimal(t){if("number"==typeof t)return t;if(/^-?\d*(\.\d*)?$/.test(t))return 0+t;var e=0,i=1,n=1;return/[NSEWnsew]$/.test(t)&&(n=/[SWsw]$/.test(t)?-1:1,t=t.slice(0,-1)),t.split(/[DMSdms'"\s]+/).forEach(function(t){e+=t/i,i*=60}),e*n}function latDir(t){return[" S",""," N"][t+1]}function lonDir(t){return[" W",""," E"][t+1]}Util.direction=function(t,e){var i=Util.bearing(t,e),n=Math.floor((i+22.5)/45);return DIRECTION_IND[n]},Util.bearing=function(t,e){var i=Util.toRadians(t[0]),n=Util.toRadians(t[1]),a=Util.toRadians(e[0]),o=Util.toRadians(e[1]),r=Math.sin(a-i)*Math.cos(o),s=Math.cos(n)*Math.sin(o)-Math.sin(n)*Math.cos(o)*Math.cos(a-i),l=Util.toDegrees(Math.atan2(r,s));return l<0&&(l=360-Math.abs(l)),l},Util.toRadians=function(t){return t*(Math.PI/180)},Util.toDegrees=function(t){return t*(180/Math.PI)},Util.getParamString=function(t,e,i){var n=[];for(var a in t)n.push(encodeURIComponent(i?a.toUpperCase():a)+"="+encodeURIComponent(t[a]));var o="";return e&&(o=e+(-1===e.indexOf("?")?"?":"&")),o+n.join("&")},Util.map=function(t,e){return map(t,e)},Util.find=function(t,e){return find(t,e)},Util.partition=function(t,e){if(0==t.length)return[];if(1==t.length)return[t];for(var i=t[0],n=[i],a=[n],o=1;o<t.length;o+=1)e(i,t[o])?n.push(i=t[o]):a.push(n=[i=t[o]]);return a},Util.Timer=function(t){this.timeout=null,this.delay=t},Util.Timer.prototype.start=function(t){this.cancel(),this.timeout=setTimeout(t,this.delay)},Util.Timer.prototype.cancel=function(){this.timeout&&clearTimeout(this.timeout),this.timeout=null},Util.infoHtml=function(t,e,i){var n=infoProps$1(t,e),a=$('<div class="'+(i.className?i.className:"wfml-info-content")+'">');i.title&&$('<div class="wfml-info-title">').text(i.title).appendTo(a);for(var o=0;o<n.length;o++){var r=$('<div  class="wfml-info-line">').appendTo(a);$('<span class="wfml-info-name">').text(n[o].name).attr("title",n[o].description).appendTo(r),$('<span class="wfml-info-value">').text(n[o].value).appendTo(r)}return a.get(0)};var TIME_FORMAT=Intl.DateTimeFormat("en-CA",{timeZone:void 0,hour12:!1,year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short"}),DATE_FORMAT=Intl.DateTimeFormat("en-CA",{timeZone:void 0,hour12:!1,year:"numeric",month:"numeric",day:"numeric"}),FORMATTERS={DD:function(t){return sexagesimalFraction(unSexagesimal(t),1,function(t,e){return(t<0?"-":"")+e[0].toFixed(3)+"°"})},DM:function(t){return sexagesimalFraction(unSexagesimal(t),2,function(t,e){return(t<0?"-":"")+e[0]+"° "+e[1].toFixed(3)+"′"})},DMS:function(t){return sexagesimalFraction(unSexagesimal(t),3,function(t,e){return(t<0?"-":"")+e[0]+"° "+e[1]+"′ "+e[2].toFixed(3)+"″"})},DDLat:function(t){return sexagesimalFraction(unSexagesimal(t),1,function(t,e){return e[0].toFixed(3)+"°"+latDir(t)})},DMLat:function(t){return sexagesimalFraction(unSexagesimal(t),2,function(t,e){return e[0]+"° "+e[1].toFixed(3)+"′"+latDir(t)})},DMSLat:function(t){return sexagesimalFraction(unSexagesimal(t),3,function(t,e){return e[0]+"° "+e[1]+"′ "+e[2].toFixed(3)+"″"+latDir(t)})},DDLon:function(t){return sexagesimalFraction(unSexagesimal(t),1,function(t,e){return e[0].toFixed(3)+"°"+lonDir(t)})},DMLon:function(t){return sexagesimalFraction(unSexagesimal(t),2,function(t,e){return e[0]+"° "+e[1].toFixed(3)+"′"+lonDir(t)})},DMSLon:function(t){return sexagesimalFraction(unSexagesimal(t),3,function(t,e){return e[0]+"° "+e[1]+"′ "+e[2].toFixed(3)+"″"+lonDir(t)})},LatLon:function(t,e){return[{value:t,dir:latDir},{value:e,dir:lonDir}].map(function(t){return sexagesimalFraction(unSexagesimal(t.value),2,function(e,i){return i[0]+"° "+i[1].toFixed(3)+"′ "+t.dir(e)})}).join(" ")},TimeStampMilli:function(t){var e=new Date(1*t);return isNaN(e)?t:TIME_FORMAT.format(e)},TimeStampSec:function(t){var e=new Date(1e3*t);return isNaN(e)?t:TIME_FORMAT.format(e)},IsoTime:function(t){var e=new Date(t);return isNaN(e)?t:TIME_FORMAT.format(e)},IsoDate:function(t){var e=new Date(t.replace(/Z$/,""));return isNaN(e)?t:DATE_FORMAT.format(e)},USDate:function(t){var e=new Date(t.replace(/(\d\d)\/(\d\d)\/(\d\d\d\d)/,function(t,e,i,n){return n+"-"+e+"-"+i}));return isNaN(e)?t:DATE_FORMAT.format(e)},EUDate:function(t){var e=new Date(t.replace(/(\d\d)\/(\d\d)\/(\d\d\d\d)/,function(t,e,i,n){return n+"-"+i+"-"+e}));return isNaN(e)?t:DATE_FORMAT.format(e)},LightningPolarityName:function(t){return t?"Positive":"Negative"},LightningPolaritySymbol:function(t){return t?"🞣":"⭘"},FirstPresent:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return t.find(function(t){return!(null==t||null==t)})},Phone:function(t,e,i){return(e=e.trim())?(e=e.replace(/^(\d{3})(\d{4})$/,"$1-$2"),t&&(e=t+"-"+e),i&&(e=e+" (ext "+i+")"),e):"N/A"},Name:function(t,e){return[e,t].filter(function(t){return t}).join(", ")}};function infoPropDisplayValue(t,e,i){var n=t;return i&&(n=Object.assign({},t),Object.keys(i).forEach(function(t){n["parameter."+t]=i[t]})),e.replace(/\$\{\s*(.*?)\s*(?:\|\s*(.*?)\s*(?:\|\s*(.*?)\s*)?)?\}/gi,function(t,e,i,a){a||(a="");var o=(e=e.split(";")).map(function(t){return n[t]});if(e.some(function(t){return!n.hasOwnProperty(t)}))return"##MISSING##";if(o.every(function(t){return null==t}))return a;if(i){var r=FORMATTERS[i];if(r)return r.apply(void 0,o);throw"Unknown formatter "+i}return o.join("")})}function infoPropsRaw(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push({name:i,value:t[i]});return e}function cqlInExpr(t){return t.name.split(",").map(Util.cqlAttribute).join(",")+" IN ("+Util.map(t.values,Util.cqlString).join(",")+")"}function cqlLikeExpr(t){var e=t.name.split(",").map(Util.cqlAttribute),i=" ILIKE '%"+t.like+"%'",n=Util.map(e,function(t){return t+i});return Util.cqlCombineFilters(n," OR ",!0,"EXCLUDE")}function sldFill(t){var e="";return t.fillClr&&(e+='<CssParameter name="fill">'+sldExpr(t.fillClr)+"</CssParameter>"),t.fillOpacity&&(e+='<CssParameter name="fill-opacity">'+t.fillOpacity+"</CssParameter>"),e.length>0&&(e="<Fill>"+e+"</Fill>"),e}function sldStroke(t){var e="";return t.strokeClr&&(e+='<CssParameter name="stroke">'+t.strokeClr+"</CssParameter>"),t.strokeWidth&&(e+='<CssParameter name="stroke-width">'+t.strokeWidth+"</CssParameter>"),e.length>0&&(e="<Stroke>"+e+"</Stroke>"),e}function sldText(t){var e="";t.label&&(e+="<Label><ogc:PropertyName>"+t.label+"</ogc:PropertyName></Label>");var i="";t.fontFamily&&(i+='<CssParameter name="font-family">'+t.fontFamily+"</CssParameter>"),t.fontStyle&&(i+='<CssParameter name="font-style">'+t.fontStyle+"</CssParameter>"),t.fontWeight&&(i+='<CssParameter name="font-weight">'+t.fontWeight+"</CssParameter>"),t.fontSize&&(i+='<CssParameter name="font-size">'+t.fontSize+"</CssParameter>"),i.length>0&&(e+="<Font>"+i+"</Font>");var n="",a="";return t.anchorX&&(a+="<AnchorPointX>"+t.anchorX+"</AnchorPointX>"),t.anchorY&&(a+="<AnchorPointY>"+t.anchorY+"</AnchorPointY>"),a.length>0&&(n+="<AnchorPoint>"+a+"</AnchorPoint>"),n.length>0&&(e+="<LabelPlacement><PointPlacement>"+n+"</PointPlacement></LabelPlacement>"),e.length>0&&(e="<TextSymbolizer>"+e+"</TextSymbolizer>"),e}function sldExpr(t){return t instanceof String?t:t instanceof Number?t:t.op&&"recode"===t.op?sldRecode(t):t}function sldRecode(t){var e="",i='<ogc:Function name="Recode">',n="<ogc:PropertyName>"+t.name+"</ogc:PropertyName>";i+=n;for(var a=0;a<t.map.length;a++)i+="<ogc:Literal>"+t.map[a].data+"</ogc:Literal>",i+="<ogc:Literal>"+t.map[a].value+"</ogc:Literal>";return e=i+="</ogc:Function>",t.else&&(e='<ogc:Function name="if_then_else"><ogc:Function name="in">'+n+sldDataList(t.map)+"</ogc:Function>"+i+"<ogc:Literal>"+t.else+"</ogc:Literal></ogc:Function>"),e}function sldDataList(t){for(var e="",i=0;i<t.length;i++)e+="<ogc:Literal>"+t[i].data+"</ogc:Literal>";return e}Util.featureSetHtml=function(t,e,i,n){var a,o=$('<div class="wfml-feature-set">'),r=$('<div class="wfml-feature-list">').appendTo(o),s=$('<div class="wfml-feature-panel">').appendTo(o);return t.forEach(function(t){t.features.forEach(function(o,l){var c=(t.layer.setTitle||t.layer.title)+" #"+(l+1);t.layer.titleFormat?c=infoPropDisplayValue(o.properties,t.layer.titleFormat,t.layer.parameter):t.layer.titleAttribute&&(c=o.properties[t.layer.titleAttribute]);var h=function(){r.find(".wfml-picked-feature").removeClass("wfml-picked-feature"),u.addClass("wfml-picked-feature"),s.empty(),s.append(Util.featureHtml(o.properties,t.layer,t.layer.title,i)),n&&t.marker&&n(t.marker)},u=$('<span class="wfml-feature-title">').appendTo(r).text(c).click(h);a&&e!=o.featureId||(a=h)})}),a(),o.get(0)},Util.featureHtml=function(t,e,i,n){var a=$('<div class="wfml-info-content">');i&&a.append($('<div class="wfml-info-title">').text(i));var o=infoProps$1(t,e.attributes,e.parameter);return a.append(o.map(function(i){return i.action&&!i.value?$('<div class="wfml-info-line">').append($('<span class="wfml-info-action">').text(i.name).click(n(i.action,t,e))):$('<div class="wfml-info-line">').append($('<span class="wfml-info-name">').text(i.name).attr("title",i.description)).append($('<span class="wfml-info-value">').text(i.value))})),a.get(0)},Util.toCQL=function(t){var e;if(!t||0==t.length)return"";var i=Util.map(t,function(t){return t.like?cqlLikeExpr(t):cqlInExpr(t)});return console.log(i),(e=this).cqlAnd.apply(e,i)},Util.cqlAttribute=function(t){return'"'+t.replace(/"/g,'""')+'"'},Util.cqlString=function(t){return"'"+t.replace(/'/g,"''")+"'"},Util.cqlCombineFilters=function(t,e,i,n){var a=t.filter(function(t){return t});return 0==a.length?n:1==a.length?a[0]:a.map(i?function(t){return t}:function(t){return"("+t+")"}).join(e)},Util.cqlAnd=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.cqlCombineFilters(t," AND ",!1,"INCLUDE")},Util.cqlOr=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.cqlCombineFilters(t," OR ",!1,"EXCLUDE")},Util.cqlLayerFilters=function(t){for(var e=[],i=arguments.length-1;i-- >0;)e[i]=arguments[i+1];return e.map(t).join(";")},Util.toSLD=function(t,e){return'<?xml version="1.0" encoding="ISO-8859-1"?><StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><NamedLayer><Name>'+t+"</Name><UserStyle><FeatureTypeStyle><Rule><PolygonSymbolizer>"+sldFill(e)+sldStroke(e)+"</PolygonSymbolizer>"+sldText(e)+"</Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>"};var DOTS_PER_INCH=90,INCHES_PER_M=39.37,WEBMERC_RESOLUTION=[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135,.29858214169740677,.14929107084870338,.07464553542435169,.037322767712175846,.018661383856087923,.009330691928043961,.004665345964021981];Util.scaleForZoom=function(t){return WEBMERC_RESOLUTION[t]*INCHES_PER_M*DOTS_PER_INCH},Util.zoomForScale=function(t,e){for(var i=t/INCHES_PER_M/DOTS_PER_INCH,n=0,a=0;a<WEBMERC_RESOLUTION.length;a++)if(WEBMERC_RESOLUTION[a]<i){n=a;break}return!e&&n>0?n-1:n},Util.workPool=function(t){var e=[],i=[];return{add:function(n){e.push(n),function n(){if(0!=e.length&&!(i.length>=t)){var a=e.shift();i.push(a);var o=function(){i.splice(i.indexOf(a),1),n()};a().then(o,o)}}()}}},Util.type=function(t){var e=typeof t;return"object"!=e?e:Array.isArray(t)?"array":null===t?"null":"object"},Util.hash=function(t){return("0000000"+(walk(2166136261,t)>>>0).toString(16)).substr(-8)};var typeCode={undefined:"\0",null:"",boolean:"",number:"",string:"",function:"",array:"",object:"\n"};function walk(t,e){var i=Util.type(e);switch(i){case"string":return addBits(t,e);case"array":for(var n in t=addBits(t,typeCode[i]),e)t=walk(t,e[n]);return t;case"object":t=addBits(t,typeCode[i]);var a=Object.keys(e).sort();for(var o in a){var r=a[o];t=walk(t=addBits(t,r),e[r])}return t;case"undefined":case"null":return addBits(t,typeCode[i]);default:return addBits(t,typeCode[i]+String(e))}}function addBits(t,e){for(var i=0,n=e.length;i<n;i+=1)t^=e.charCodeAt(i),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t}Util.addFeatureId=function(t){switch(t.type){case"FeatureCollection":return t.features.forEach(Util.addFeatureId),t;case"Feature":return t.featureId?t:(t.featureId=Util.hash(t.properties),t);case"GeometryCollection":case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return t;default:throw new Error("unknown geojson type: '"+t.type)}};var EPSILON=1e-4,Search=function(t){this.map=t,this.data=new SearchData};Search.prototype.data=function(){return this.data},Search.prototype.clear=function(){return this.crosshairs(),this.crosshairs2(),this.arrow(),this.data.init()},Search.prototype.setMaximumDistance=function(t){return this.data.setMaximumDistance(t)},Search.prototype.setAnchor=function(t){return this.crosshairs(t),this.crosshairs2(),this.arrow(),this.data.setAnchor(t)},Search.prototype.zoom=function(){var t=this.map.zoom()+4;this.map.zoom(this.data.anchorLocation(),t)},Search.prototype.pan=function(){this.map.pan(this.data.anchorLocation())},Search.prototype.showCandidate=function(t){if(this.crosshairs2(),this.arrow(),t){this.crosshairs2(t);var e=this.data.anchorLocation();e&&this.arrow(e,t)}},Search.prototype.setResultHandler=function(t){this.data.setResultHandler(t)},Search.prototype.findPlace=function(t){return this.data.findPlace(t)},Search.prototype.findRoad=function(t){return this.data.findRoad(t)},Search.prototype.findIntersection=function(t,e){return this.data.findIntersection(t,e)},Search.prototype.crosshairs=function(t){this.map.indicator("crosshairs",t,"crosshairs")},Search.prototype.crosshairs2=function(t){this.map.indicator("crosshairs2",t?t.loc:null,"crosshairs",{style:{opacity:.6,fillOpacity:0,weight:2,color:"#08f",radius:20}})},Search.prototype.arrow=function(t,e){if(t){var i=e.name+" - "+Search.formatDistance(e.dist,"km");this.map.indicator("arrow",t,"arrow",{target:e.loc,label:i})}else this.map.indicator("arrow")},Search.toLatLng=function(t){return t instanceof Array?new L.LatLng(t[1],t[0]):new L.LatLng(t.loc[1],t.loc[0])},Search.formatDDM=function(t){t=Math.abs(t);var e=Math.abs(Math.trunc(t));return e+" "+(60*(t-e)).toFixed(3)},Search.formatDistance=function(t,e){return null==t?"n/a":t<10?t.toFixed(1)+" "+e:t.toFixed(0)+" "+e};var SearchData=function(){this.init(),this.maxDistance=null,this.callback=null};SearchData.prototype.init=function(){return this.searchState={placeText:null,places:[],roadText:null,roads:[],intersectionsText:null,intersections:[]},this.anchorPt=null,this.updateResults()},SearchData.prototype.setResultHandler=function(t){null!=t&&"function"!=typeof t||(this.callback=t)},SearchData.prototype.setMaximumDistance=function(t){return this.maxDistance=t,this.updateResults()},SearchData.prototype.setAnchor=function(t){return this.anchorPt=t,this.updateResults()},SearchData.prototype.anchorLocation=function(){return this.anchorPt},SearchData.prototype.findPlace=function(t){return this.searchState.places=[],this.searchState.placeText=t,this.updateResults()},SearchData.prototype.findRoad=function(t){return this.searchState.roads=[],this.searchState.roadText=t,this.searchState.intersections=[],this.searchState.intersectionsText=null,this.updateResults()},SearchData.prototype.findIntersection=function(t,e){return this.searchState.intersections=[],this.searchState.intersectionsText=[t,e],this.searchState.roads=[],this.searchState.roadText=null,this.updateResults()},SearchData.prototype.updateResults=function(){var t=this;return this.callback?Promise.resolve().then(function(){return searchPlaces(t)}).then(function(){return searchRoads(t)}).then(function(){return searchOccupants(t)}).then(function(){return searchAddresses(t)}).then(function(){return searchIntersections(t)}).then(function(){t.callback&&t.callback.call(null,Object.assign({anchorPt:t.anchorPt,maxDistance:t.maxDistance},t.searchState))},function(e){t.callback&&t.callback.call(null,Object.assign({error:e,anchorPt:t.anchorPt,maxDistance:t.maxDistance},t.searchState))}):Promise.resolve()};var fetchCache={};function fetchData(t){return fetchCache[t]?fetchCache[t]:fetchCache[t]=fetch(t,{credentials:"same-origin"}).then(function(e){if(e.ok)return e.json();throw new Error("fetching "+t+": "+e.statusText)})}function searchPlaces(t){if(t.searchState.placeText)return fetchData(Util.resolveLibraryRelativeURL("data/wf-search-places.json")).then(function(e){t.searchState.places=sortData(searchData(e,t.searchState.placeText,!1,t.anchorPt))}).catch(function(t){console.warn("place match:",t)});t.searchState.places=[]}function searchRoads(t){if(t.searchState.roadText)return fetchData(Util.resolveLibraryRelativeURL("data/wf-search-roads.json")).then(function(e){t.searchState.roads=sortData(searchData(e,t.searchState.roadText,!1,t.anchorPt,t.maxDistance))}).catch(function(t){console.warn("road match:",t)});t.searchState.roads=[]}function searchData(t,e,i,n,a){var o=[];if(e.length<=0)return o;for(var r=e.toLowerCase(),s=" "+r,l=0;l<t.length;l++){var c=t[l];if(match(c.n,r,s,i)){var h={name:c.n,type:c.t,dist:null,loc:[c.x,c.y]};if(setAnchorData(n,h),a&&h.dist>a)continue;o.push(h)}}return o}function match(t,e,i,n){var a=t.toLowerCase(),o=a.startsWith(e);if(!n)return o;var r=a.indexOf(i)>-1;return o||r}function sortData(t){return t.sort(function(t,e){return null==t.dist||null==e.dist?t.name>e.name?1:-1:t.dist-e.dist})}function removeDuplicateIntersections(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];i>0&&isDuplicateIntersection(e[e.length-1],n)||e.push(n)}return e}function isDuplicateIntersection(t,e){return t.name===e.name&&!(t.dist&&e.dist&&t.dist-e.dist>1)}function setAnchorData(t,e){t&&(e.dist=distance(t,e)/1e3,e.direction=direction(t,e.loc),e.dist<EPSILON&&(e.isAnchor=!0))}function searchIntersections(t){if(t.searchState.intersectionsText){var e={ver:1.2,maxResults:1e3,outputSRS:4326,addressString:t.searchState.intersectionsText.join(" and "),matchPrecision:"INTERSECTION",autoComplete:!0};return new Promise(function(t,i){$.ajax({timeout:1e4,dataType:"jsonp",url:"https://geocoder.api.gov.bc.ca/addresses.geojsonp",data:e}).then(t,i)}).then(function(e){var i=$.map(e.features,function(e){if(e.geometry.coordinates&&"BC"!=e.properties.fullAddress&&e.properties.intersectionName){var i={name:e.properties.fullAddress,type:"intersection",dist:null,dir:null,loc:e.geometry.coordinates};return setAnchorData(t.anchorPt,i),i}});t.searchState.intersections=removeDuplicateIntersections(sortData(i))}).catch(function(t){console.warn("intersection match:",t.statusText)})}t.searchState.intersections=[]}function searchAddresses(t){if(!(t.searchState.roads.length>0)&&t.searchState.roadText&&t.searchState.roadText.trim()){var e={ver:1.2,maxResults:100,outputSRS:4326,addressString:t.searchState.roadText,autoComplete:!0};return new Promise(function(t,i){$.ajax({timeout:1e4,dataType:"jsonp",url:"https://geocoder.api.gov.bc.ca/addresses.geojsonp",data:e}).then(t,i)}).then(function(e){var i=$.map(e.features,function(e){if(e.geometry.coordinates&&"BC"!=e.properties.fullAddress){var i={name:e.properties.fullAddress,type:null,dist:null,dir:null,loc:e.geometry.coordinates};return setAnchorData(t.anchorPt,i),i}});t.searchState.roads=removeDuplicateIntersections(sortData(i))}).catch(function(t){console.warn("address match:",t.statusText)})}}function searchOccupants(t){if(!(t.searchState.places.length>0)&&t.searchState.placeText&&t.searchState.placeText.trim()){var e={ver:1.2,maxResults:100,outputSRS:4326,addressString:t.searchState.placeText,autoComplete:!0};return new Promise(function(t,i){$.ajax({timeout:1e4,dataType:"jsonp",url:"https://geocoder.api.gov.bc.ca/occupants/addresses.geojsonp",data:e}).then(t,i)}).then(function(e){var i=$.map(e.features,function(e){if(e.geometry.coordinates&&"BC"!=e.properties.fullAddress){var i={name:e.properties.fullAddress,type:null,dist:null,dir:null,loc:e.geometry.coordinates};return setAnchorData(t.anchorPt,i),i}});t.searchState.places=removeDuplicateIntersections(sortData(i))}).catch(function(t){console.warn("occupant match:",t.statusText)})}}function distance(t,e){return t&&e?Search.toLatLng(t).distanceTo(Search.toLatLng(e)):0}function direction(t,e){return t&&e?Util.direction(t,e):""}var ZOOM_LEVEL=12,ICON={highlightPoint:"img/highlight.png",editPoint:"img/edit-point.png",editPointShaded:"img/edit-point-shaded.png",selectPoint:"img/select-point-marker.svg"},Map=function(t){var e=this;this.mapId=t,this.view={center:[-123,55],level:5},this.icon={highlight:L.icon({iconUrl:Util.resolveLibraryRelativeURL(ICON.highlightPoint),iconAnchor:[16,16]}),edit:L.icon({iconUrl:Util.resolveLibraryRelativeURL(ICON.editPoint),iconAnchor:[16,16]}),editOrig:L.icon({iconUrl:Util.resolveLibraryRelativeURL(ICON.editPointShaded),iconAnchor:[16,16]}),selectPoint:L.icon({iconUrl:Util.resolveLibraryRelativeURL(ICON.selectPoint),iconAnchor:[15,27]})},this.layer={},this.callback={click:null,loadStart:null,loadEnd:null,selectpoint:null},this.selectPointBuffer=null,this.control={},this.search=new Search(this),this.clickHandler=null,this.hoverHandler=null,this.hoverTimer=new Util.Timer(300),this.findProgress=L.marker([0,0],{icon:L.divIcon({iconSize:[30,30],iconAnchor:[15,15],className:"wfml-find-icon",html:'<div class="wfml-find-animation"><div class="wfml-find-lens wfml-find-shadow"></div><div class="wfml-find-handle wfml-find-shadow"></div><div class="wfml-find-lens"></div><div class="wfml-find-handle"></div></div>'})}),this.findTooltip=L.marker([0,0],{icon:L.divIcon({iconSize:[30,30],iconAnchor:[15,15],className:"wfml-find-icon",html:'<div class="wfml-find-trans"><div class="wfml-find-lens wfml-find-shadow"></div><div class="wfml-find-handle wfml-find-shadow"></div><div class="wfml-find-lens"></div><div class="wfml-find-handle"></div></div>'})}).on("popupclose tooltipclose",function(){e.findTooltip.remove()}),this.stateChangeTimer=new Util.Timer(500),this.handler={}};function isNumber(t){return!isNaN(parseFloat(t))}Map.VERSION="0.3.0",Map.prototype.scale=function(){return Util.scaleForZoom(this.leafMap.getZoom())},Map.prototype.setBasemap=function(t){isNumber(t)||(t=this._baseMaps.findIndex(function(e){return e.key==t})),t<0||!this._baseMaps[t]||(this.currentBase&&this.leafMap.removeLayer(this.currentBase.layer),this.currentBase=this._baseMaps[t],this.leafMap.addLayer(this.currentBase.layer),this.changedState())},Map.prototype.setClickHandler=function(t){this.clickHandler=t},Map.prototype.onClick=function(t){if(this.clickHandler){var e=this.toolMgr.getActiveTool("main");e&&e.isClickHandler||this.clickHandler.call(null,t)}},Map.prototype.setHoverHandler=function(t,e){this.hoverHandler=t,e&&(this.hoverTimer=new Util.Timer(e))},Map.prototype.onHover=function(t){var e=this,i=this.toolMgr.getActiveTool("main");i&&i.isHoverHandler||this.hoverTimer.start(function(){var i=e.toolMgr.getActiveTool("main");i&&i.isHoverHandler||e.hoverHandler&&e.hoverHandler.call(null,[t.latlng.lng,t.latlng.lat])})},Map.prototype.findFeatures=function(t){var e=this;if(e.findProgress.remove(),e.findTooltip.remove(),this.findTask&&this.findTask.cancel(),t){var i={},n=function(t,n,a){return function(){var o=e.getHandler("feature",t,"action");o&&o(n,a,i)}};this.findTask=this.layerMgr.findFeatures(t.containerPoint),this.findProgress.remove().addTo(e.leafMap).setLatLng(t.latlng).on("click",function(){e.findTask.cancel(),e.findProgress.remove()}).bindTooltipDelayed("Searching for features"),this.findTask.onResult().then(function(a){if(e.findProgress.remove(),0!=a.length){var o=Util.featureSetHtml(a,null,n);e.findTooltip.addTo(e.leafMap).setLatLng(t.latlng).bindPopup(o,{autoPanPaddingTopLeft:[50,50],offset:[0,0]}).openPopup().unbindTooltip(),i.popup=e.findTooltip}else e.findTooltip.addTo(e.leafMap).setLatLng(t.latlng).bindTooltip("No features found").unbindPopup()}).catch(function(t){e.findProgress.remove(),console.debug(t)})}},Map.prototype.extent=function(){var t=this.leafMap.getBounds();return[t.getWest(),t.getSouth(),t.getEast(),t.getNorth()]},Map.prototype.resize=function(){this.leafMap.invalidateSize()},Map.prototype.zoomFull=function(){return this.zoom(this.view.center,this.view.level),this.leafMap.getZoom()},Map.prototype.zoomLevel=function(t){this.leafMap.setZoom(t)},Map.prototype.zoomIn=function(t){return this.leafMap.zoomIn(t),this.leafMap.getZoom()},Map.prototype.zoom=function(t,e){return t?(e=e||ZOOM_LEVEL,t.length<=2?this.leafMap.setView(Util.toLatLng(t),e):this.leafMap.fitBounds([[t[1],t[0]],[t[3],t[2]]]),this.leafMap.getZoom()):this.leafMap.getZoom()},Map.prototype.zoomExtent=function(t){this.leafMap.fitBounds(t)},Map.prototype.pan=function(t){t&&this.leafMap.panTo(Util.toLatLng(t))},Map.prototype.cursor=function(t){var e=t||"";document.getElementById(this.mapId).style.cursor=e},Map.prototype.selectPoint=function(t){if(!t)return this.indicator("selectPoint"),void(this.selectPointBuffer=null);this.selectPointBuffer=t,this.indicator("selectPoint",t,"selectPoint"),this.callback.selectpoint&&this.callback.selectpoint(t)},Map.prototype.primary=function(t){if(this.layer.primary&&this.leafMap.removeLayer(this.layer.primary),this.layer.primary=null,t){var e=this.layerMgr.find(t);e&&(this.layer.primary=L.tileLayer.wms(e.overlay.url,{layers:e.layers,format:e.overlay.format,zIndex:1e3,transparent:!0}),this.layer.primary.addTo(this.leafMap))}},Map.prototype.primaryFilter=function(t){if(this.layer.primary){var e=Util.toCQL(t);delete this.layer.primary.wmsParams.cql_filter,e.length>0&&(this.layer.primary.wmsParams.cql_filter=e),this.layer.primary.redraw()}},Map.prototype.editStart=function(t,e){this.editor=new PointEditor(this,t,e)},Map.prototype.editStop=function(){this.editor&&this.editor.stop(),this.editor=null},Map.prototype.infoPopup=function(t,e){if(this.callback.infoPopup&&this.leafMap.off("click",this.callback.infoPopup),t){var i=this;this.callback.infoPopup=function(n){var a=i.layerMgr.find(t);a&&a.visible()&&a.identify(n.containerPoint).then(function(o){if(o){e&&(o=e(t,o));var r=a.infoPopupHTML(o);i.leafMap.openPopup(r,n.latlng)}})},this.leafMap.on("click",this.callback.infoPopup)}},Map.prototype.sidebarShow=function(t,e,i){return this._sidebar.show(t,e,i)},Map.prototype.createElement=function(t,e){return L.DomUtil.create(t,e,L.DomUtil.get(this.mapId))},Map.prototype.indicator=function(t,e,i,n){this.layer[t]||(this.layer[t]=L.layerGroup().addTo(this.leafMap)),this.layer[t].clearLayers(),e&&this._graphic(i,e,n).addTo(this.layer[t])},Map.prototype._graphic=function(t,e,i){return GRAPHIC[t]?((i=i||{}).map=this,GRAPHIC[t](e,i)):null};var GRAPHIC={arrow:function(t,e){if(e.target)return L.arrow([t[1],t[0]],[e.target[1],e.target[0]],{title:e.label})},crosshairs:function(t,e){return L.crosshairs([t[1],t[0]],e)},selectPoint:function(t,e){return Util.marker(t,e.map.icon.selectPoint)}};function PointEditor(t,e,i){var n=this;this.map=t,this.callback=i,this.startLoc=e,this.isStartShown=!1,this.map.layer.markers.clearLayers(),this.currMarker=null,e&&(this.currMarker=Util.marker(e,t.icon.edit),this.currMarker.addTo(t.layer.markers)),this.clickFn=function(t){n.update([t.latlng.lng,t.latlng.lat])},t.leafMap.on("click",this.clickFn),this.map.cursor("crosshair")}Map.prototype.getState=function(){var t=this.leafMap.getBounds(),e=this.leafMap.getCenter(),i=[];this.layerMgr.forEachLayer(function(t,e){e&&i.push({id:e.getId(),visible:e.visible()})});var n=this.toolMgr.tools.reduce(function(t,e){return null!=e.getState()&&(t[e.id]=e.getState()),t},{});return{version:2,timestamp:Date.now(),center:[e.lat,e.lng],zoom:this.leafMap.getZoom(),extent:[[t.getSouth(),t.getWest()],[t.getNorth(),t.getEast()]],layers:i,base:this.currentBase.key,tools:n}},Map.prototype.setState=function(t){var e=this;if(t.version>2)throw new Error("cannot handle this state object");var i=this.saveState;this.saveState=null;try{this.leafMap.fitBounds(t.extent),this.leafMap.setZoom(t.zoom,{animate:!1}),this.leafMap.panTo(t.center,{animate:!1}),t.layers.forEach(function(t){var i=e.layerMgr.find(t.id);i&&i.visible(t.visible,!1)}),e.layerMgr.update(),Object.entries(t.tools).forEach(function(t){e.toolMgr.toolRegistry[t[0]].setState(t[1])}),this.setBasemap(t.base)}catch(t){console.error("setState:",t),this.saveState=i}},Map.prototype.changedState=function(){var t=this;this.saveState&&this.stateChangeTimer.start(function(){t.saveState&&t.saveState()})},Map.prototype.persistState=function(t,e){var i=this;if(t){e=Object.assign({onLoad:function(){},onSave:function(){}},e);try{var n=JSON.parse(window.localStorage.getItem("WFML-"+t));!1!==e.onLoad(n)&&i.setState(n)}catch(t){console.error("loadState:",t)}this.saveState=function(){try{var n=i.getState();!1!==e.onSave(n)&&window.localStorage.setItem("WFML-"+t,JSON.stringify(n))}catch(t){console.error("saveState:",t)}}}else this.saveState=null},Map.prototype.setHandler=function(t,e,i,n){this.handler[t]||(this.handler[t]={}),this.handler[t][e]||(this.handler[t][e]={}),this.handler[t][e][i]=n},Map.prototype.getHandler=function(t,e,i){return this.handler[t]&&this.handler[t][e]&&this.handler[t][e][i]},Map.prototype.sidebar=function(){return this._sidebar},PointEditor.prototype.update=function(t){!this.isStartShown&&this.startLoc&&(Util.marker(this.startLoc,this.map.icon.editOrig).addTo(this.map.layer.markers),this.isStartShown=!0),this.currMarker&&this.map.layer.markers.removeLayer(this.currMarker),this.currMarker=Util.marker(t,this.map.icon.edit),this.currMarker.addTo(this.map.layer.markers),this.callback(t)},PointEditor.prototype.stop=function(){this.map.layer.markers.clearLayers(),this.map.leafMap.off("click",this.clickFn),this.map.cursor()};var Sidebar=function(t){this.map=t,this.sidebarInstances=[]};Sidebar.prototype.render=function(t){L.DomUtil.empty(this._content),L.DomUtil.empty(this._toolbar),L.DomUtil.get("wfml-sidebar-title").textContent=t},Sidebar.prototype.content=function(){return this._content},Sidebar.prototype.toolbar=function(){return this._toolbar},Sidebar.prototype.create=function(t,e,i,n){var a=this,o=L.DomUtil.create("div","wfml-sidebar wfml-sidebar-hidden",L.DomUtil.get(this.map.mapId));o.style.width=(i||200)+"px";var r=L.DomUtil.create("div","wfml-sidebar-top",o),s=L.DomUtil.create("div","wfml-sidebar-bottom",o),l=L.DomUtil.create("div","wfml-sidebar-header",r),c=L.DomUtil.create("span","wfml-sidebar-left-tools",l);L.DomUtil.create("span","",l).textContent=e;var h=L.DomUtil.create("span","wfml-sidebar-right-tools",l);L.DomUtil.create("div","wfml-sidebar-close",h).addEventListener("click",function(){a.show(p,!1),n&&n()});var u=L.DomUtil.create("div","wfml-sidebar-content",s);Util.stopProp(o);var p={id:t,div:o,header:r,toolbar:c,content:u};return this.sidebarInstances.push(p),p};var SIDEBAR_CLZ_HIDE="wfml-sidebar-hidden";Sidebar.prototype.hideAll=function(){this.sidebarInstances.forEach(function(t){L.DomUtil.addClass(t.div,SIDEBAR_CLZ_HIDE)})},Sidebar.prototype.show=function(t,e){return L.DomUtil.hasClass(t.div,SIDEBAR_CLZ_HIDE)||(e=!1),e?(this.hideAll(),L.DomUtil.removeClass(t.div,SIDEBAR_CLZ_HIDE)):L.DomUtil.addClass(t.div,SIDEBAR_CLZ_HIDE),e};var LayerGroupView=function(t){this.title=t.title,this.updateOverlays=t.updateOverlays||function(){},this.isVisible=!0,this.mixed=null,this.child=[],this.parent=null};function computeChildrenVisMix(t){for(var e=!1,i=!1,n=!1,a=0;a<t.length;a++){var o=t[a];o.visible()&&(e=!0),o.visible()||(i=!0),o.isMixed()&&(n=!0)}var r=!!n||e&&i;return{mixed:r,isVisible:!r&&e}}LayerGroupView.prototype.isFolder=function(){return!0},LayerGroupView.prototype.parent=function(){return this.parent},LayerGroupView.prototype.children=function(){return this.child},LayerGroupView.prototype.findChild=function(t){for(var e=0;e<this.child.length;e++){var i=this.child[e];if(i.title==t)return i}return null},LayerGroupView.prototype.findExpand=function(t,e){if(e||(e=0),0==t.length)return this;var i=t[e],n=this.findChild(i);return n||(n=this.addGroup(i)),t.length==e+1?n:n.findExpand(t,e+1)},LayerGroupView.prototype.addGroup=function(t){return this.addChild(new LayerGroupView({title:t,updateOverlays:this.updateOverlays}))},LayerGroupView.prototype.addLayer=function(t){return this.addChild(new LayerView(t))},LayerGroupView.prototype.addChild=function(t){return this.child.push(t),t.parent=this,t},LayerGroupView.prototype.visible=function(t){if(null==t)return this.isVisible;var e=!!t!=this.isVisible;this.isVisible=!!t;for(var i=0;i<this.child.length;i++){this.child[i].visible(!!t);var n=this.child[i];n.visible(n.inMutex?t&&n.mutexDefaultVisible:t)}e&&this.fireChange()},LayerGroupView.prototype.isMixed=function(){return this.mixed},LayerGroupView.prototype.computeMixed=function(){for(var t=0;t<this.child.length;t++){var e=this.child[t];e.isFolder()&&e.computeMixed()}var i=computeChildrenVisMix(this.child);this.mixed=i.mixed,this.isVisible=i.isVisible},LayerGroupView.prototype.updateMixed=function(){var t=computeChildrenVisMix(this.child),e=t.mixed!=this.mixed||t.isVisible!=this.isVisible;this.mixed=t.mixed,this.isVisible=t.isVisible,e&&this.fireChange(),this.parent&&this.parent.updateMixed()},LayerGroupView.prototype.onChange=function(t){this.onChangeFn=t},LayerGroupView.prototype.fireChange=function(){this.onChangeFn&&this.onChangeFn(this)};var LayerView=function(t){this.layer=t,this.title=t.title,this.inMutex=t.inMutex,this.mutexDefaultVisible=t.mutexDefaultVisible;var e=this;this.layer.onChange(function(){e.fireChange(),e.parent.updateMixed()})};LayerView.prototype.isFolder=function(){return!1},LayerView.prototype.isMixed=function(){return!1},LayerView.prototype.layer=function(){return this.layer},LayerView.prototype.visible=function(t){if(null==t)return this.layer.visible();var e=this.layer.visible();this.layer.visible(!!t),e!=this.layer.visible()&&this.fireChange(),this.parent.updateMixed()},LayerView.prototype.onChange=function(t){this.onChangeFn=t},LayerView.prototype.fireChange=function(){this.onChangeFn&&this.onChangeFn(this)},LayerView.prototype.updateOverlays=function(){this.parent.updateOverlays()};var DateRange=function(t,e){if(!(t instanceof Date||t instanceof Interval))throw"start must be a Date or an Interval but was "+t;if(t instanceof Interval&&t.value<=0)throw"start must be positive";if(this.start=t,!(e instanceof Date||e==PRESENT))throw"end must be a Date or PRESENT but was "+e;this.end=e};function partsEqual(t,e){return t==PRESENT&&e==PRESENT||!!(t instanceof Interval&&t.equals(e))||t instanceof Date&&e instanceof Date&&t.valueOf()==e.valueOf()}DateRange.prototype.getWms=function(){return(this.start instanceof Interval?this.start.getWms():this.start.toISOString())+"/"+(this.end==PRESENT?"PRESENT":this.end.toISOString())},DateRange.prototype.getCqlEpochSeconds=function(t,e){var i=this.epochSeconds(e);return Util.cqlAttribute(t)+" BETWEEN "+i.start+" AND "+i.end},DateRange.prototype.getCqlIsoDate=function(t,e){var i=this.fix(e);return Util.cqlAttribute(t)+" DURING "+i.getWms()},DateRange.prototype.getCql=function(t){if("cql"!==t.temporal&&console.warn("Generating temporal CQL for layer ${layer.id} with temporal type ${layer.temporal}"),!t.temporalAttribute)throw"Attempted to generate CQL for layer "+t.id+" but it has no temporalAttribute";switch(t.temporalAttribute.unit){case"iso-8601":return this.getCqlIsoDate(t.temporalAttribute.name);case"seconds":return this.getCqlEpochSeconds(t.temporalAttribute.name);default:throw"Unknown temporal attribute unit "+t.temporalAttribute.unit}},DateRange.prototype.equals=function(t){return!(!t instanceof DateRange)&&!!t&&partsEqual(this.start,t.start)&&partsEqual(this.end,t.end)},DateRange.prototype.fix=function(t){t=t||new Date;var e=this.end==PRESENT?t:this.end,i=this.start instanceof Interval?this.start.before(e):this.start;return new DateRange(i,e)},DateRange.prototype.epochSeconds=function(t){var e=this.fix(t);return{start:Math.floor(e.start.getTime()/1e3),end:Math.ceil(e.end.getTime()/1e3)}},DateRange.parseWmsDate=function(t){if("PRESENT"==t)return PRESENT;if("P"==t[0])return Interval.parseWms(t);var e=new Date(t);if(isNaN(e.valueOf()))throw"Invalid date "+t;return e},DateRange.parseWms=function(t){return null==t?t:new(Function.prototype.bind.apply(DateRange,[null].concat(t.split("/").map(function(t){return DateRange.parseWmsDate(t)}))))};var Units=Object.freeze({DAYS:Object.freeze({name:"days",seconds:86400,field:"Date",suffix:"D",subDay:!1}),HOURS:Object.freeze({name:"hours",seconds:3600,field:"Hours",suffix:"H",subDay:!0}),MINUTES:Object.freeze({name:"minutes",seconds:60,field:"Minutes",suffix:"M",subDay:!0}),SECONDS:Object.freeze({name:"seconds",seconds:1,field:"Seconds",suffix:"S",subDay:!0})}),INTERVAL_UNITS=Object.freeze(Object.entries(Units).map(function(t){return t[1]})),INTERVAL_WMS_REGEX=/^P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)(?:\.\d+)?S)?)?$/,Interval=function(t,e){if(null==t||isNaN(t))throw"Time value for interval must be a number but was "+t;if(this.value=t,!INTERVAL_UNITS.includes(e))throw e+" is not a valid time unit "+Object.keys(Units).join(", ");this.unit=e};Interval.prototype.add=function(t,e){void 0===e&&(e=1);var i=new Date(t),n=t["get"+this.unit.field]();return i["set"+this.unit.field](n+this.value*e),i},Interval.prototype.before=function(t){return this.add(t,-1)},Interval.prototype.after=function(t){return this.add(t,1)},Interval.prototype.getWms=function(){return this.unit.subDay?"PT"+this.value+this.unit.suffix:"P"+this.value+this.unit.suffix},Interval.prototype.toString=function(){return"Interval["+this.value+" "+this.unit.name+"]"},Interval.parseWms=function(t){var e=INTERVAL_WMS_REGEX.exec(t),i=INTERVAL_UNITS.map(function(t,i){return{unit:t,value:e[i+1]}}).filter(function(t){return t.value}).map(function(t){return t.value=parseInt(t.value),t});if(1==i.length)return new Interval(i[0].value,i[0].unit);throw"Not a valid Interval "+t},Interval.prototype.equals=function(t){return!(!t instanceof Interval||!t||this.value!=t.value||this.unit!=t.unit)};var Present=function(){},PRESENT=new Present;Present.prototype.toString=function(){return"Present["+(new Date).toISOString()+"]"};var BaseLayer=function(t,e){this.overlay=t,this.callbackOnChange=[],this.enabled=!0,this.title=e.title,this.id=e.id,this.source=e.source,this.folder=e.folder,this.layers=e.layers,this.styles=e.styles,this.scaleMax=e.scaleMax,this.scaleMin=e.scaleMin,this.opacity=e.opacity,this.attributes=e.attributes,this.titleAttribute=e.titleAttribute,this.titleFormat=e.titleFormat,this.setTitle=e.setTitle,this.geometryAttribute=e.geometryAttribute,this.isVisible=null!=e.visible&&e.visible,this.sld=e.sld,this.cqlFilter=e.cqlFilter,this.time=e.time,this.inMutex=e.inMutex,this.mutexDefaultVisible=e.mutexDefaultVisible||this.inMutex&&this.visible,this.handler=e.handler,this.parameter={},this.useBounds=!1!==e.useBounds,1==e.temporal?this.time?this.time.includes("PRESENT"):this.temporal="wms_dimension":0==e.temporal||null==e.temporal||null==e.temporal?this.time?this.time.includes("PRESENT"):this.temporal=null:this.temporal=e.temporal,this.temporalAttribute=e.temporalAttribute,this.legendDef=[{label:null,url:this.legendURL(),width:null}]};BaseLayer.prototype.getId=function(){return this.id?this.id:this.layers},BaseLayer.prototype.onChange=function(t){this.callbackOnChange.push(t)},BaseLayer.prototype._fireChange=function(){for(var t in this.callbackOnChange)this.callbackOnChange[t](this)},BaseLayer.prototype.isDisplayed=function(){return this.isVisible&&this.isInScaleRange()&&this.isEnabled()},BaseLayer.prototype.isTemporal=function(){return!!this.temporal},BaseLayer.prototype.isLive=function(){return"live"==this.temporal||this.temporal&&"fixed"!==this.temporal&&this.overlay.layerMgr.isTimeMoving()},BaseLayer.prototype.isHistorical=function(){return"fixed"==this.temporal||this.temporal&&"live"!==this.temporal&&!this.overlay.layerMgr.isTimeMoving()},BaseLayer.prototype.hasScaleRange=function(){return this.scaleMin||this.scaleMax},BaseLayer.prototype.isInScaleRange=function(){return this.overlay.layerMgr.isInScaleRange(this.scaleMin,this.scaleMax)},BaseLayer.prototype.zoomToScale=function(){this.overlay.layerMgr.zoomToScale(this.scaleMin,this.scaleMax)},BaseLayer.prototype.redraw=function(){this.overlay.update()},BaseLayer.prototype.enable=function(t){!this.enabled!=!t&&(this.enabled=!!t,this._fireChange(),this.overlay.setDirty())},BaseLayer.prototype.isEnabled=function(){return this.enabled},BaseLayer.prototype.legendURL=function(){},BaseLayer.prototype.checkHealth=function(t,e){return Promise.resolve(!0)},BaseLayer.prototype.setParameter=function(t,e){this.parameter[t]=e,this._fireChange()},BaseLayer.prototype.getTitle=function(){return this.title},BaseLayer.prototype.getHandler=function(t){if(this.handler)return this.overlay.layerMgr.wfmlMap.getHandler("layer",this.handler,t)},BaseLayer.prototype.setLegendDef=function(t){return this.legendDef=t,this},BaseLayer.prototype.getLegendDef=function(){return this.legendDef},BaseLayer.prototype.renderLegend=function(t,e){e=Object.assign({},e);var i=this.getLegendDef();if(i&&0!=i.length)return this.title&&!1!==e.title&&(L.DomUtil.create("div","wfml-legend-title",t).innerHTML=this.title),i.forEach(function(e){var i=L.DomUtil.create("div","wfml-legend-entry",t),n=L.DomUtil.create("img","wfml-legend-image",i);n.src=e.url,e.width&&(n.style.width=e.width),e.height&&(n.style.height=e.height),e.label&&(L.DomUtil.create("span","wfml-legend-label",i).innerHTML=e.label)}),!0},BaseLayer.prototype.visible=function(t){if(null==t)return this.isVisible;!!t!=this.isVisible&&(this.isVisible=!!t,this.overlay.setDirty(),this._fireChange())},BaseLayer.prototype.getExtent=function(){};var Layer=function(){BaseLayer.prototype.constructor.apply(this,arguments)};Object.assign(Layer.prototype,BaseLayer.prototype),Layer.prototype.filter=function(t){this.cqlFilter=Util.toCQL(t),this.overlay.update()},Layer.prototype.style=function(t){this.sld=Util.toSLD(this.layers,t),this.overlay.update()},Layer.prototype.legendURL=function(){return Util.getParamString({SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"getlegendgraphic",FORMAT:"image/png",LAYER:this.layers},this.overlay.url+"?")},Layer.prototype.fullCqlFilter=function(){if(this.cqlFilter||"cql"==this.temporal)return Util.cqlAnd(this.cqlFilter,this.overlay.layerMgr.time.getCql(this))},Layer.prototype.identify=function(t){var e=this.overlay.url,i=this.layers,n=this.overlay.leafMap.getSize(),a=this.overlay.leafMap.options.crs,o=this.overlay.leafMap.getBounds(),r=a.project(o.getSouthWest()),s=a.project(o.getNorthEast()),l=r.x+","+r.y+","+s.x+","+s.y,c=this.time;"wms_dimension"==this.temporal&&(c=this.overlay.layerMgr.time.getWms());var h={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",bbox:l,feature_count:20,height:n.y,width:n.x,buffer:10,info_format:"application/json",layers:i,query_layers:i,time:c};return h.cql_filter=this.fullCqlFilter(),h.srs="EPSG:3857",h.x=parseInt(t.x),h.y=parseInt(t.y),$.ajax({method:"GET",url:e,data:h,xhrFields:{}}).then(function(t){if(t&&t.features&&t.features.length>0)return Util.addFeatureId(t).features})},Layer.prototype.infoPopupHTML=function(t){for(var e=infoProps(t[0].properties,this.attributes),i=$('<div class="wfml-info-content">'),n=0;n<e.length;n++){var a=$('<div  class="wfml-info-line">').appendTo(i);$('<span class="wfml-info-name">').text(e[n].name).attr("title",e[n].description).appendTo(a),$('<span class="wfml-info-value">').text(e[n].value).appendTo(a)}return i.get(0)},Layer.prototype.findFeatures=function(t){},Layer.prototype.checkHealth=function(t,e){return this.checkHealthPromise&&this.checkHealthTimestamp+t>Date.now()?this.checkHealthPromise:(this.checkHealthTimestamp=Date.now(),this.checkHealthPromise=Promise.resolve().then(checkDescribeFeature(this,e)).then(checkLegend(this,e)).then(checkMap(this,e)))};var VectorLayer=function(){BaseLayer.prototype.constructor.apply(this,arguments),this.load=this.useBounds?this.loadBounded:this.loadUnbounded,this.legendDef=[]};function checkLegend(t,e){return function(){var i=t.legendURL({_:(new Date).getTime()});return imageRequest(i,e).catch(function(e){throw console.warn("Unable to load legend for "+t.folder.join(" / ")+" / "+t.title+" from\n\n"+i+"\n\n"+e),new Error("Unable to load legend")})}}function checkMap(t,e){return function(){var i={REQUEST:"GetMap",VERSION:"1.1.1",LAYERS:t.layers,STYLES:t.styles||"",FORMAT:"image/png",SRS:"EPSG:3857",WIDTH:615,HEIGHT:896,BBOX:"-13733979.495519932,6176352.248731688,-13732996.563109327,6177449.836684718",TRANSPARENT:!0};"cql"==t.temporal&&(i.CQL_FILTER=DateRange.parseWms("PT24H/PRESENT").getCql(t));var n=Util.getParamString(i,t.overlay.url+"?");return imageRequest(n,e).catch(function(e){throw console.warn("Unable to load map for "+t.folder.join(" / ")+" / "+t.title+" from\n\n"+n+"\n\n"+e),new Error("Unable to load map")})}}function imageRequest(t,e){return new Promise(function(i,n){var a=$("<img>").on("load",function(){o&&clearTimeout(o),i()}).on("error",function(t){o&&clearTimeout(o),n()}).attr("src",t);if(a.get(0).complete)i();else if(e)var o=setTimeout(function(){a.get(0).src="",n("timeout")},e)}).catch(function(i){return new Promise(function(n,a){if("timeout"==i)return a(i);var o=$.get(t,null,null,"text");if(e)var r=setTimeout(function(){o.abort(),a(i)},e);o.done(function(t){r&&clearTimeout(r),i&&(t=i+"\n"+t),a(t)}),o.fail(function(){r&&clearTimeout(r),a(i)})})})}function checkDescribeFeature(t,e){return function(){var i={method:"GET",url:t.overlay.url,data:{service:"WFS",version:"1.0.0",request:"DescribeFeatureType",typename:t.layers,outputformat:"application/json"},xhrFields:{},dataType:"text",timeout:e};return new Promise(function(t,n){var a=$.ajax(i);if(e)var o=setTimeout(function(){a.abort(),n("timeout")},e);a.done(function(e){o&&clearTimeout(o),/\<ServiceExceptionReport/.test(e)&&n(e),t()}),a.fail(function(t,e){o&&clearTimeout(o),"abort"!=e&&n(e)})}).catch(function(e){throw console.warn("Unable to describe feature for "+t.folder.join(" / ")+" / "+t.title+" \n\n"+e),new Error("Unable to describe feature")})}}function makeOverlay(t,e,i){var n;if("wfs"==e.type)n=new VectorOverlay(t,Object.assign({isVisible:!0,opacity:i[0].opacity,handler:i[0].handler,temporal:i[0].temporal},e));else{if(e.type)throw new Error("Unknown service type: "+e.type);n=new Overlay(t,Object.assign({format:"image/png",transparent:!0,isVisible:!0,opacity:i[0].opacity,temporal:i[0].temporal},e))}return i.forEach(function(t){n.addLayer(t)}),n}Object.assign(VectorLayer.prototype,BaseLayer.prototype),VectorLayer.prototype.init=function(t,e,i){var n=this,a=this.getHandler("point")||function(t,e){},o=this.getHandler("feature");this.leafLayer=L.geoJSON(null,{pointToLayer:a&&function(t,e){return L.marker(e,Object.assign({layerId:n.id},a(n,t)))},onEachFeature:function(t,e){o&&o(n,t,e),n.featureClick&&e.on("click",function(t){return n.featureClick(t)})},style:function(t){return t.properties._style||{}}});var r=this.getHandler("filter");this.featuresFilter=r?function(t){return r(n,t)}:function(t){return t};var s=this.getHandler("title");s&&(this.getTitle=function(){return s(n)});var l=this.getHandler("fetchFeatures");l&&(this.fetch=function(t){return{promise:new Promise(function(e,i){return e(l(n,t,n.data))}),abort:function(){}}});var c=this.getHandler("checkHealth");c&&(this.checkHealth=function(t,e){return new Promise(function(i,a){i(c(n,t,e,n.data))})}),this.leafDebugLayer=L.geoJSON(null,{pane:"popupPane",pointToLayer:function(t,e){return L.circleMarker(e,{pane:"popupPane",radius:4,color:"#000000",weight:2,fillColor:"#ffffff",fillOpacity:1})}})},VectorLayer.prototype.setParameter=function(t,e){BaseLayer.prototype.setParameter.apply(this,arguments),this.useBounds||(this.currentFetch&&this.currentFetch.abort(),this.currentFetch=null)},VectorLayer.prototype.setData=function(t){this.data=t},VectorLayer.prototype.onFeatureClick=function(t){this.featureClick=t},VectorLayer.prototype.addData=function(t){this.leafLayer.clearLayers();var e=this.featuresFilter(t);this.leafLayer.addData(e)},VectorLayer.prototype.loadBounded=function(t){var e=this;if(this.currentFetch&&this.currentFetch.abort(),this.isDisplayed())return this.currentFetch=this.fetch(),this.currentFetch.promise.then(function(t){if(e.isDisplayed())return e.addData(Util.addFeatureId(t)),e.leafLayer})},VectorLayer.prototype.loadUnbounded=function(t){var e=this;if(this.isDisplayed())return t&&this.currentFetch&&(this.currentFetch.abort(),this.currentFetch=null),this.currentFetch||(this.currentFetch=this.fetch()),this.currentFetch.promise.then(function(t){if(e.isDisplayed())return e.addData(Util.addFeatureId(t)),e.leafLayer})},VectorLayer.prototype.identify=function(t){var e=this.overlay.layerMgr.leafMap,i=[];return this.leafLayer.eachLayer(function(n){var a,o,r,s,l=n.toGeoJSON();switch(l.geometry.type){case"Point":o=e.latLngToContainerPoint([(a=l.geometry.coordinates)[1],a[0]]),(r=t.x-o.x)*r+(s=t.y-o.y)*s<100&&i.push(l);break;default:console.warn("skip",l.geometry.type)}}),$.Deferred(function(t){return 0==i.length?t.resolve():t.resolve(Util.addFeatureId({type:"FeatureCollection",features:i}).features)})},VectorLayer.prototype.getCqlFilter=function(parameter){var cql=this.cqlFilter;if(cql)return/\$/.test(cql)?(parameter||(parameter=this.parameter),eval("`"+cql+"`")):cql},VectorLayer.prototype.getTemporalFilter=function(){if("cql"==this.overlay.temporal)return this.overlay.layerMgr.time.getCql(this)},VectorLayer.prototype.fetch=function(t){var e=[this.getCqlFilter(),this.getTemporalFilter()];if(this.useBounds){var i=this.overlay.layerMgr.leafMap.getBounds(),n=i.getSouthWest(),a=i.getNorthEast();e.push("bbox("+this.geometryAttribute+","+n.lng+","+n.lat+","+a.lng+","+a.lat+")")}var o=Object.assign({service:"WFS",version:"1.0.0",request:"GetFeature",srsName:"epsg:4326",typename:this.layers,outputformat:"application/json",cql_filter:Util.cqlAnd.apply(Util,e)},t),r=$.ajax({method:"GET",url:this.overlay.url,data:o,xhrFields:{},dataType:"json",timeout:1e5});return{promise:new Promise(function(t,e){return r.then(t,function(t,i){e(i)})}),abort:function(){r.abort()}}},VectorLayer.prototype.checkHealth=function(t,e){return this.checkHealthPromise&&this.checkHealthTimestamp+t>Date.now()?this.checkHealthPromise:(this.checkHealthTimestamp=Date.now(),this.checkHealthPromise=Promise.resolve().then(checkDescribeFeature(this,e)))},VectorLayer.prototype.getExtent=function(){return this.leafLayer.getBounds()};var BaseOverlay=function(t,e){this.layerMgr=t,this.url=e.url,this.opacity=e.opacity,this.temporal=e.temporal,this.layers=[]};BaseOverlay.prototype.setDirty=function(){this.dirty=!0},BaseOverlay.prototype.enabled=function(t){this.enable!=t&&(this.enable=t,this.enable?this.update(!0):this.layerMgr.leafMap.hasLayer(this.leafLayer)&&this.layerMgr.leafMap.removeLayer(this.leafLayer))},BaseOverlay.prototype.visible=function(t){this.layers.forEach(function(e){e.visible(t)}),this.update()};var Overlay=function(t,e){BaseOverlay.prototype.constructor.apply(this,arguments),this.leafMap=t.leafMap,this.format=e.format?e.format:"image/png",this.transparent=!e.transparent||e.transparent,this.tiled=e.tiled};Object.assign(Overlay.prototype,BaseOverlay.prototype),Overlay.prototype.addLayer=function(t){var e=new Layer(this,t);this.layers.push(e)},Overlay.prototype.init=function(t,e){var i=this;this.id=this.layers.map(function(t){return t.id}).join("--");var n={layers:this.layerNames(),format:this.format,zIndex:e,transparent:this.transparent,opacity:this.opacity};this.leafLayer=this.tiled?L.tileLayer.wms(this.url,n):L.nonTiledLayer.wms(this.url,n),this.leafLayer.addTo(this.leafMap),this.update(!0),this.leafLayer.on("loading",function(){i.layerMgr._checkLoading()}),this.leafLayer.on("load",function(){i.layerMgr._checkLoading(),i.salt()});var a=new Util.Timer(300);this.layerMgr.leafMap.on("zoomend moveend",function(){a.start(function(){i.update(!0)})})},Overlay.prototype.isLoading=function(){return this.leafLayer&&this.leafLayer.isLoading()},Overlay.prototype.update=function(t){if(t||this.dirty){this.dirty=!1;var e=this.layerNames();this.leafLayer.wmsParams.layers=e;var i=this.layerStyles();i&&(this.leafLayer.wmsParams.styles=i),this.salt();var n=this.layerFilters();n.length>0?this.leafLayer.wmsParams.cql_filter=n:delete this.leafLayer.wmsParams.cql_filter;var a=this.sldBody();a?this.leafLayer.wmsParams.SLD_BODY=a:delete this.leafLayer.wmsParams.SLD_BODY;var o=this.wmsTime();o?this.leafLayer.wmsParams.TIME=o:delete this.leafLayer.wmsParams.TIME,0==e.length?this.leafMap.removeLayer(this.leafLayer):(this.leafMap.hasLayer(this.leafLayer)||this.leafMap.addLayer(this.leafLayer),this.leafLayer.redraw())}},Overlay.prototype.salt=function(){this.leafLayer.wmsParams.SALT=Math.random()},Overlay.prototype.layerNames=function(){return Util.map(this.layers,function(t){return t.isDisplayed()?t.layers:null}).reverse().join(",")},Overlay.prototype.layerStyles=function(){var t=Util.map(this.layers,function(t){return t.isDisplayed()?t.styles?t.styles:"":null}).reverse().join(",");return t.replace(",","").trim().length<=0?null:t},Overlay.prototype.visible=function(t){this.layers.forEach(function(e){e.isVisible=!0===t}),this.update()},Overlay.prototype.sldBody=function(){return Util.find(this.layers,function(t){return t.sld?t.sld:null})},Overlay.prototype.wmsTime=function(){if("wms_dimension"==this.temporal)return this.layerMgr.time.getWms()},Overlay.prototype.layerFilters=function(){var t=this.layerMgr,e=Util.map(this.layers,function(e){if(e.visible()){var i=e.cqlFilter,n="cql"==e.temporal?t.time.getCql(e):void 0;return i||n?Util.cqlAnd(i,n):null}return null});return 0==e.join("").length?"":Util.map(e,function(t){return t.length>0?t:"INCLUDE"}).reverse().join(";")},Overlay.prototype.getHandler=function(t){};var VectorOverlay=function(t,e){BaseOverlay.prototype.constructor.apply(this,arguments),this.handler=e.handler,this.layer={},this.overMarker=[]};function removeFromLayerGroup(t,e){if(t instanceof L.MarkerClusterGroup)t.removeLayer(e);else if(t instanceof L.LayerGroup){if(t.hasLayer(e))return void t.removeLayer(e);t.eachLayer(function(t){removeFromLayerGroup(t,e)})}}Object.assign(VectorOverlay.prototype,BaseOverlay.prototype),VectorOverlay.prototype.getHandler=function(t){if(this.handler)return this.layerMgr.wfmlMap.getHandler("overlay",this.handler,t)},VectorOverlay.prototype.addLayer=function(t){var e=new VectorLayer(this,t);this.layers.push(e),this.layer[e.id]=e},VectorOverlay.prototype.init=function(t,e){var i=this,n=new Util.Timer(300);this.layerMgr.leafMap.on("zoomend moveend",function(){!1!==i.beforeUpdate()&&n.start(function(){i.update(!0)})}),this.id=this.layers.map(function(t){return t.id}).join("--");var a=this.getHandler("cluster");if(a){var o=Object.assign({zoomToBoundsOnClick:!0,spiderfyDistanceMultiplier:2.25,spiderfyOnMaxZoom:!0,forceSpiderfyOnClick:!1},a(i));o.onCreate&&(o.iconCreateFunction=function(t){var e=t.getAllChildMarkers().map(function(t){return t.feature});return o.onCreate(e)}),this.leafLayer=L.markerClusterGroup(o);var r=function(t,e){var n=(t.getAllChildMarkers?t.getAllChildMarkers():[t]).map(function(t){return{id:t.options.layerId,layer:i.layer[t.options.layerId],features:[t.feature],marker:t}});o.onClick(t,n,e,{Util:Util})};o.onClick&&this.leafLayer.on("clusterclick",function(t){r(t.layer)}),o.onBeforeUpdate&&(this.beforeUpdate=function(){return o.onBeforeUpdate()}),o.onAfterUpdate&&(this.afterUpdate=function(){return o.onAfterUpdate(r)})}else this.leafLayer=L.layerGroup();this.layers.forEach(function(n){n.init(i,t,e)}),this.update(!0),this.leafLayer.on("loading load",function(){i.layerMgr._checkLoading()});var s=this.getHandler("enabled");s&&(this.enabled=s(this,this.enabled))},VectorOverlay.prototype.update=function(t){var e=this;if((t||this.dirty)&&(this.dirty=!1,!1!==this.beforeUpdate())){var i;this.cancelUpdate&&this.cancelUpdate(),this.leafLayer.addTo(this.layerMgr.leafMap),this.cancelUpdate=function(){i||(i=!0)};var n=0,a=this.layers.map(function(a){var o;return n+=1,Promise.resolve().then(function(){if(i)throw new Error("cancelled");return a.leafLayer&&(o=a.leafLayer.getLayers()),a.load(t)}).then(function(t){o&&o.forEach(function(i){t&&t.hasLayer(i)||removeFromLayerGroup(e.leafLayer,i)}),t&&e.leafLayer.addLayer(t)}).catch(function(t){console.debug(a.id,t)}).finally(function(){e.loading=(n-=1)>0,e.layerMgr._checkLoading()})});return e.loading=n>0,e.layerMgr._checkLoading(),Promise.all(a).then(function(){e.afterUpdate(),i=!0})}},VectorOverlay.prototype.isLoading=function(){return this.loading},VectorOverlay.prototype.beforeUpdate=function(){},VectorOverlay.prototype.afterUpdate=function(){};var LayerManager=function(t){this.wfmlMap=t,this.leafMap=t.leafMap,this.overlay=[],this.loading=!1,this.time=DateRange.parseWms("PT24H/PRESENT"),this.onTimeChange=[]};function toArray(t){return t instanceof Array?t:[t]}LayerManager.prototype.init=function(t){var e=this;this.quickFilters=t.quickFilters,this.quickFilters.forEach(function(t){var e=function(){};if(t.layers){var i=t.layers.slice();e=function(t){if(t.layer)return i.some(function(e){return t.layer.id==e})}}var n=function(){};if(t.filter){var a=new RegExp(t.filter,"i");n=function(t){return a.test(t.title)}}t.nodeTest=function(t){return e(t)||n(t)}});var i=[],n=function(t,e,a,o){t.forEach(function(t){"folder"==t.type?n(t.items,e.concat(t.title),t.mutex,Object.assign(JSON.parse(JSON.stringify(o||{})),t.base)):(t.folder=e,t.inMutex=a,i.push(Object.assign({},o,t)))})};n(t.layers,[],!1);var a=Util.partition(i,function(t,e){return t.service==e.service&&t.opacity==e.opacity&&t.handler==e.handler&&t.temporal==e.temporal&&!1!==t.merge&&!1!==e.merge});this.overlay=a.map(function(i){return makeOverlay(e,t.services[i[0].service]||{},i)}),this.identifyIds=(t.hoverIdentify||[]).filter(function(t){var i=e.findById(t);return i||console.warn("identify features can't use layer id '"+t+"', it doesn't match a layer"),!!i});for(var o=2,r=this.overlay.length-1;r>=0;r--)this.overlay[r].init(this.wfmlMap,o),o+=1},LayerManager.prototype.setTime=function(t){this.time=t,this.onTimeChange.forEach(function(t){return t()}),this.redrawTrackingTemporalLayers()},LayerManager.prototype.forEachLayer=function(t){var e=this;this.overlay.forEach(function(i){t.call(e,i),i.layers.forEach(function(n){t.call(e,i,n)})})},LayerManager.prototype.findFeatures=function(t){var e=this;function i(t,e){var i=this;this.ids=t,this.find=e,this.cancelled=!1,this.results=[],this.result=new Promise(function(t,e){i.doNext(t,e)})}return i.prototype.onResult=function(){return this.result},i.prototype.doNext=function(t,e){var i=this;if(!this.ids||0==this.ids.length)return t(this.results);if(this.cancelled)return e(new Error("cancelled"));var n=this.ids.shift();this.find(n).then(function(n){if(i.cancelled)return e(new Error("cancelled"));i.results.push(n),i.doNext(t,e)}).catch(function(){i.doNext(t,e)})},i.prototype.cancel=function(){this.cancelled=!0},new i(this.identifyIds.slice(),function(i){return new Promise(function(n,a){var o=e.findById(i);if(!o.isDisplayed())return a();o.identify(t).fail(a).then(function(t){return t&&0!=t.length?n({id:i,layer:o,features:t}):a()})})})},LayerManager.prototype.find=function(t){return this.findById(t)},LayerManager.prototype.findById=function(t){for(var e=this.overlay.length-1;e>=0;e--)for(var i=this.overlay[e],n=0;n<i.layers.length;n++){var a=i.layers[n];if(a.id&&a.id===t)return a;if(a.layers==t)return a}return null},LayerManager.prototype.update=function(t){for(var e=this.overlay.length-1;e>=0;e--)this.overlay[e].update(t)},LayerManager.prototype.redraw=function(){for(var t=this.overlay.length-1;t>=0;t--){var e=this.overlay[t];e.leafLayer&&e.leafLayer.redraw()}},LayerManager.prototype.isTimeMoving=function(){return this.time&&this.time.end==PRESENT},LayerManager.prototype.redrawTemporalLayers=function(){this.redrawLayers(this.getTemporalLayers())},LayerManager.prototype.redrawTrackingTemporalLayers=function(){this.redrawLayers(this.getTrackingTemporalLayers())},LayerManager.prototype.redrawLiveTemporalLayers=function(){this.redrawLayers(this.getLiveTemporalLayers())},LayerManager.prototype.getTemporalLayers=function(){return this.overlay.flatMap(function(t){return t.layers.filter(function(t){return t.temporal})}).map(function(t){return t.id})},LayerManager.prototype.getTrackingTemporalLayers=function(){return this.overlay.flatMap(function(t){return t.layers.filter(function(t){return t.temporal&&"fixed"!=t.temporal&&"live"!=t.temporal})}).map(function(t){return t.id})},LayerManager.prototype.getLiveTemporalLayers=function(){var t=this.isTimeMoving();return this.overlay.flatMap(function(e){return e.layers.filter(function(e){return e.temporal&&"fixed"!=e.temporal&&t||"live"==e.temporal})}).map(function(t){return t.id})},LayerManager.prototype.liveLayerChangeCallback=function(){},LayerManager.prototype.isInScaleRange=function(t,e){var i=this.wfmlMap.scale();return!(t&&i<t||e&&i>e)},LayerManager.prototype.zoomToScale=function(t,e){var i=this.wfmlMap.scale(),n=null,a=!0;if(t&&i<t&&(n=t,a=!1),e&&i>e&&(n=e,a=!0),n){var o=Util.zoomForScale(n,a);return this.wfmlMap.zoomLevel(o),!0}},LayerManager.prototype._checkLoading=function(){var t=this.loading;this.loading=this.overlay.some(function(t){return t.isLoading()}),this.loading?(t||this.wfmlMap.callback.loadStart&&this.wfmlMap.callback.loadStart(),this.wfmlMap.control.spinner&&this.wfmlMap.control.spinner.enable()):(t&&this.wfmlMap.callback.loadEnd&&this.wfmlMap.callback.loadEnd(),this.wfmlMap.control.spinner&&this.wfmlMap.control.spinner.disable())},LayerManager.prototype.legend=function(){for(var t=[],e=0;e<this.overlay.length;e++)for(var i=this.overlay[e],n=0;n<i.layers.length;n++){var a=i.layers[n];a.isDisplayed()&&t.push(a)}return t},LayerManager.prototype.visible=function(t){for(var e=0;e<this.overlay.length;e++)this.overlay[e].visible(t)},LayerManager.prototype.listView=function(){for(var t=[],e=0;e<this.overlay.length;e++)for(var i=this.overlay[e],n=0;n<i.layers.length;n++)t.push(i.layers[n]);return t},LayerManager.prototype.treeView=function(){for(var t=this,e=new LayerGroupView({updateOverlays:function(){t.update()}}),i=0;i<this.overlay.length;i++)for(var n=this.overlay[i],a=0;a<n.layers.length;a++){var o=n.layers[a];e.findExpand(toArray(o.folder)).addLayer(o)}return e.computeMixed(),e},LayerManager.prototype.enabled=function(t){this.overlay.forEach(function(e){e.enabled(t)})},LayerManager.prototype.redrawLayers=function(t){var e=this;Array.isArray(t)||(t=[t]);var i=[];if(t.forEach(function(t){var n=e.find(t);n&&-1==i.indexOf(n.overlay)&&i.push(n.overlay)}),0!=i.length)return Promise.all(i.map(function(t){return Promise.resolve().then(function(){return t.update(!0)})}))};var ToolManager=function(t){this.map=t,this.leafMap=t.leafMap,this.toolbars={},this.init(t.mapId),this.toolRegistry={},this.tools=[],this.currentToolId={main:null,layer:null}};ToolManager.prototype.init=function(t){this.toolbars.main=L.DomUtil.create("div","wfml-toolbar wfml-toolbar-main",L.DomUtil.get(t)),this.toolbars.layer=L.DomUtil.create("div","wfml-toolbar wfml-toolbar-right",L.DomUtil.get(t))},ToolManager.prototype._add=function(t,e,i){if(t in this.toolRegistry)throw new Error('tool "'+t+'" already exists');e._init(t,this),this.toolRegistry[t]=e,this.tools.push(e),i&&(e.div=L.DomUtil.create("div","wfml-tool",i),L.DomUtil.addClass(e.div,e.className),e.div.title=e.options.title,e.div.addEventListener("click",function(){e.active?e.deactivate():e.activate()}),Util.stopProp(e.div))},ToolManager.prototype.addHidden=function(t,e){this._add(t,e)},ToolManager.prototype.addToMain=function(t,e){this._add(t,e,this.toolbars.main)},ToolManager.prototype.addToLayer=function(t,e){this._add(t,e,this.toolbars.layer)},ToolManager.prototype.setActiveTool=function(t,e){if(null!=t&&!(t in this.toolRegistry))throw new Error('tool "'+t+"\" doesn't exist");var i=this.toolRegistry[t];!1!==e?(this.tools.forEach(function(e){e.group==i.group&&e.id!=t&&e.deactivate()}),this.currentToolId[i.group]=t,i.activate()):(this.currentToolId[i.group]=null,i.deactivate())},ToolManager.prototype.getActiveTool=function(t){if(this.currentToolId[t])return this.toolRegistry[this.currentToolId[t]]};var Tool=function(t){this.isClickHandler=!0,this.isHoverHandler=!0,this.options=t||{},this.className=t.className,this.group=t.group||"main"};Tool.prototype._init=function(t,e){this.id=t,this.mgr=e,this.map=e.map,this.leafMap=e.leafMap,this.active=!1,this.initialize()},Tool.prototype.initialize=function(){},Tool.prototype.activate=function(){return!this.active&&(this.active=!0,this.mgr.setActiveTool(this.id,!0),this.div&&L.DomUtil.addClass(this.div,"wfml-control-active"),this.mapClass&&L.DomUtil.addClass(this.leafMap._container,this.mapClass),!0)},Tool.prototype.deactivate=function(){return!!this.active&&(this.active=!1,this.mgr.setActiveTool(this.id,!1),this.div&&L.DomUtil.removeClass(this.div,"wfml-control-active"),this.mapClass&&L.DomUtil.removeClass(this.leafMap._container,this.mapClass),!0)},Tool.prototype.isActive=function(){return this.active},Tool.prototype.getState=function(){},Tool.prototype.setState=function(t){};var LeafletTool=function(t,e){Tool.call(this,t),this.onDeactivateFn=e};LeafletTool.prototype=Object.create(Tool.prototype),LeafletTool.prototype.deactivate=function(){if(!Tool.prototype.deactivate.apply(this))return!1;this.onDeactivateFn()};var Location={};function formatNumber(t,e,i,n){var a=parseFloat(t.toPrecision(e));if(!i)return a;var o=String(Math.floor(a)),r=a-o;return!n||n<=o.length?o+r.toFixed(i).substr(1):"0".repeat(n-o.length)+o+r.toFixed(i).substr(1)}function parseUTM(t){var e=getUTMCoordinate(t);return e?convertUTM(e):null}Location.format=function(t){return t?e(t[1])+", "+e(t[0]):"";function e(t){return function(t){return t<0?Math.ceil(t):Math.floor(t)}(t)+" "+formatNumber(60*function(t){var e=Math.abs(t);return e-Math.floor(e)}(t),5,3,2)+"'"}},Location.parse=function(t){return parseGeo(t)||parseUTM(t)};var RE_ATOM={start:"^\\s*",separator:"[ \\t,\\|]+",zone:"([zZ]([oO][nN][eE])?[ ])?",end:"\\s*$",numDec:"(\\d+(?:\\.\\d+)?)",numZone:"(\\d+)"},REGEXP_UTM=new RegExp(RE_ATOM.start+RE_ATOM.numDec+RE_ATOM.separator+RE_ATOM.numDec+RE_ATOM.separator+RE_ATOM.zone+RE_ATOM.numZone+RE_ATOM.end);function getUTMCoordinate(t){var e=REGEXP_UTM.exec(t);return e?[parseInt(e[1]),parseInt(e[2]),parseInt(e[5])]:null}var MAX_EASTING=1e6;function convertUTM(t){var e=t[1];if((i=t[0])>MAX_EASTING&&e<MAX_EASTING){var i=t[1];e=t[0]}return transformUTMtoGeo([i,e,t[2]])}var EPSG_GEOGRAPHIC="EPSG:4326";function transformUTMtoGeo(t){Proj4js.defs.UTM="+proj=utm +zone="+t[2];var e=new Proj4js.Proj("UTM"),i=new Proj4js.Proj(EPSG_GEOGRAPHIC),n=new Proj4js.Point(t[0],t[1]);return Proj4js.transform(e,i,n),[n.x,n.y]}function parseGeo(t){var e=new String(t).replace(/\s*,\s*/g," ,").replace(/[news]/gi," ").trim().replace(/([°'"’”])/g,"$1 ").trim().split(/\s+/);try{var i=e.map(function(t,e){var i=t.match(/^([,]?)([-]?\d+[.]?\d*)([°'"’”]?)$/);if(!i)throw new Error("component not valid: "+t);var n=SCALE[i[3]];if(0==e||i[1]){if(n&&"deg"!=n)throw new Error("component scale should be degrees: "+t);n="deg"}var a=parseFloat(i[2]);if(n&&"deg"!=n&&a<0)throw new Error("component should not be negative: "+t);return{val:a,scale:n}})}catch(t){return}if(!(i.length<2||i.length>6))switch(i.length){case 2:return checkRangeFixOrderSign(resolveDMSpair(i.slice(0,1),i.slice(1,2)));case 3:return checkRangeFixOrderSign(resolveDMSpair(i.slice(0,2),i.slice(2,3)))||checkRangeFixOrderSign(resolveDMSpair(i.slice(0,1),i.slice(1,3)));case 4:return checkRangeFixOrderSign(resolveDMSpair(i.slice(0,2),i.slice(2,4)))||checkRangeFixOrderSign(resolveDMSpair(i.slice(0,3),i.slice(3,4)))||checkRangeFixOrderSign(resolveDMSpair(i.slice(0,1),i.slice(1,4)));case 5:return checkRangeFixOrderSign(resolveDMSpair(i.slice(0,3),i.slice(3,5)))||checkRangeFixOrderSign(resolveDMSpair(i.slice(0,2),i.slice(2,5)));case 6:return checkRangeFixOrderSign(resolveDMSpair(i.slice(0,3),i.slice(3,6)))}}var SCALE={"°":"deg","'":"min",'"':"sec","’":"min","”":"sec"},SCALE_FACTOR={deg:1,min:60,sec:3600};function checkRangeFixOrderSign(t){if(t){var e=t[0],i=t[1];return checkRangeFixOrder(e,i)||checkRangeFixOrder(-e,i)||checkRangeFixOrder(e,-i)||checkRangeFixOrder(-e,-i)}}function checkRangeFixOrder(t,e){return checkRange(e,t)||checkRange(t,e)}var LONG_MIN=-200,LONG_MAX=-100,LAT_MIN=0,LAT_MAX=90;function checkRange(t,e){if(!(e>LAT_MAX||e<LAT_MIN||t>LONG_MAX||t<LONG_MIN))return[t,e]}function resolveDMSpair(t,e){var i=resolveDMS.apply(null,t);if(!1===i)return!1;var n=resolveDMS.apply(null,e);return!1!==n&&[i,n]}function resolveDMS(t,e,i){if(null==t)return!1;if(t.scale&&"deg"!=t.scale)return!1;if(null!=e&&e.scale&&"deg"==e.scale)return!1;if(null!=i&&i.scale&&("deg"==i.scale||"min"==i.scale||"sec"==e.scale))return!1;var n=t.val;return null==e?n:!(e.val<0)&&(n+=sameSign(e.val,t.val)/SCALE_FACTOR[e.scale||"min"],null==i?n:!(i.val<0)&&(n+=sameSign(i.val,t.val)/SCALE_FACTOR.sec))}function sameSign(t,e){return e>=0?Math.abs(t):-Math.abs(t)}function test(t,e,i){var n=Location.parse(t);if(n||e){var a="Unable to Parse";if(n)if(e){if(n[0]===e[0]&&n[1]===e[1])return;a="Expected is "+e}else a="Nothing expected";throw new Error('Parsing "'+t+'" failed because: '+a+"; Actual is "+n+(i?" ("+i+")":""))}}test("48°24'59.41\" N 123°30'25.34\" W",[-123.50703888888889,48.41650277777778],"lat long; no spaces after components"),test("48°24'59.41\"N,123°30'25.34\"W",[-123.50703888888889,48.41650277777778],"lat long; no spaces"),test("48 0.0000 -123 0.0000",[-123,48],"lat long with zero minutes"),test("48.440 -123.378",[-123.378,48.44],"lat long DD"),test("48.440, -123.378",[-123.378,48.44]),test("48 26.4' -123 22.68'",[-123.378,48.44]),test("48 26.4', -123 22.68'",[-123.378,48.44]),test("48 26.4 -123 22.68",[-123.378,48.44]),test("48 26.4, -123 22.68",[-123.378,48.44]),test("48 26' 24\" -123 22' 40.8\"",[-123.378,48.44]),test("48 26' 24\", -123 22' 40.8\"",[-123.378,48.44]),test("48 26 24 -123 22 40.8",[-123.378,48.44]),test("48 26 24, -123 22 40.8",[-123.378,48.44]),test("-123.378 48.440",[-123.378,48.44]),test("-123.378, 48.440",[-123.378,48.44]),test("-123 22.68' 48 26.4'",[-123.378,48.44]),test("-123 22.68', 48 26.4'",[-123.378,48.44]),test("-123 22.68 48 26.4",[-123.378,48.44]),test("-123 22.68, 48 26.4",[-123.378,48.44]),test("-123 22' 40.8\" 48 26' 24\"",[-123.378,48.44]),test("-123 22' 40.8\", 48 26' 24\"",[-123.378,48.44]),test("-123 22 40.8 48 26 24",[-123.378,48.44]),test("-123 22 40.8, 48 26 24",[-123.378,48.44]),test("-123 22 40.8, 48 26 24",[-123.378,48.44]),test("48.440N, 123.378W",[-123.378,48.44],"lat long with quadrant letters"),test("588840 5613787 9",[-127.74282465291321,50.669139944269546],"UTM Easting-Northing"),test("588840 5613787 ZONE 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 Zone 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 zone 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 Z 9",[-127.74282465291321,50.669139944269546]),test("588840.5 5613787.5 Z 9",[-127.74282465291321,50.669139944269546]),test("5613787 588840 9",[-127.74282465291321,50.669139944269546],"UTM Northing-Easting"),test("10, 160",[-160,10]),test("10, 100",[-100,10]),test("80, 160",[-160,80]),test("80, 100",[-100,80]),test("48.440 -123.378",[-123.378,48.44]),test(" 48.440 -123.378 ",[-123.378,48.44]),test(" 48.440 -123.378",[-123.378,48.44]),test("",null),test("A",null),test("4",null),test("4.",null),test("48.44",null),test("48.440, ",null),test("48.440 ",null),test("48.440 AB",null),test("588840 5",null),test("588840 5613787",null),test("588840 5613787 Z",null),test("588840 5613787 ZONE ",null),test("588840 5613787 ZONE A",null);var MeasureTool=function(t){Tool.call(this,t),this.mapClass="tool-map-active-measure",this.measurePts=[],this.tentative=null,this.mapListeners={click:this.onClick,dblclick:this.onDblClick,mousemove:this.onMove},this.decimalPlaces=1},measureState={EMPTY:0,IN_PROGRESS:1,DONE:2};function isDrawing(t){var e=t.originalEvent.buttons>0;return isModified(t)&&e}function isModified(t){return!!t.originalEvent.shiftKey}function isPointSame(t,e){return!(e.length<=0)&&t.equals(e[e.length-1])}function locatePtAlong(t,e,i){var n=Util.toLonLat(t),a=Util.toLonLat(e);return[n[0]+(a[0]-n[0])*i,n[1]+(a[1]-n[1])*i]}function computeBearing(t,e){var i=null,n=null;return e?(i=t.length>=1?t[t.length-1]:null,n=e):t.length>=2&&(i=t[t.length-2],n=t[t.length-1]),i&&n?bearing(i,n):0}function bearing(t,e){var i=toRadians(t.lat),n=toRadians(t.lng),a=toRadians(e.lat),o=toRadians(e.lng),r=Math.sin(o-n)*Math.cos(a),s=Math.cos(i)*Math.sin(a)-Math.sin(i)*Math.cos(a)*Math.cos(o-n),l=toDegrees(Math.atan2(r,s));return l<0&&(l=360-Math.abs(l)),l}function toRadians(t){return t*(Math.PI/180)}function toDegrees(t){return t*(180/Math.PI)}MeasureTool.prototype=Object.create(Tool.prototype),MeasureTool.prototype.initialize=function(){this._createDOM(),Util.stopProp(this.panelDiv)},MeasureTool.prototype._createDOM=function(){this.panelDiv=this.map.createElement("div","wfml-tool-measure-panel");var t=L.DomUtil.create("div","wfml-tool-measure-measures",this.panelDiv);this.distText=L.DomUtil.create("div","wfml-tool-measure-text",t),this.bearingText=L.DomUtil.create("div","wfml-tool-measure-text",t),this.areaText=L.DomUtil.create("div","wfml-tool-measure-text",t);var e=L.DomUtil.create("div","wfml-tool-measure-btns",this.panelDiv);this.btnSelectMid=L.DomUtil.create("div","wfml-tool-measure-btn",e),this.inputText=L.DomUtil.create("input","wfml-tool-measure-text-copy",this.panelDiv),this.inputText.readOnly=!0,this.inputText.hidden=!0,L.DomUtil.addClass(this.btnSelectMid,"wfml-tool-measure-selectmid"),this.btnSelectMid.title="Select Midpoint",this.btnSelectEnd=L.DomUtil.create("div","wfml-tool-measure-btn",e),L.DomUtil.addClass(this.btnSelectEnd,"wfml-tool-measure-selectend"),this.btnSelectEnd.title="Select Endpoint";var i=this;this.btnSelectEnd.addEventListener("click",function(){if(i.hasPoint()){var t=i.endPoint();i.map.selectPoint(t),i.copyEndPointToClipboard(t)}}),this.btnSelectMid.addEventListener("click",function(){if(i.hasPoint()){var t=i.midPoint();i.map.selectPoint(t),i.copyEndPointToClipboard(t)}}),this.copyEndPointToClipboard=function(t){var e=Location.format(t);i.inputText.hidden=!1,i.inputText.value=e,i.inputText.select(),document.execCommand("copy"),i.clearSelection(),i.inputText.value="",i.inputText.hidden=!0}},MeasureTool.prototype.clearSelection=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},MeasureTool.prototype.hasPoint=function(){return this.measurePts.length>=1},MeasureTool.prototype.endPoint=function(){return this.hasPoint()?Util.toLonLat(this.measurePts[this.measurePts.length-1]):null},MeasureTool.prototype.midPoint=function(){return this.hasPoint()?this.computeMidpoint(this.measurePts):null},MeasureTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.leafMap.boxZoom.disable(),this.leafMap.doubleClickZoom.disable(),this.leafMap.on(this.mapListeners,this),this.panelDiv.style.display="block",this.measurePts=[],this.distText.textContent="",this.bearingText.textContent="",this.areaText.textContent="",this.inputText.value="",this.map.selectPoint(),this._layer=L.layerGroup().addTo(this.leafMap),!0)},MeasureTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.leafMap.boxZoom.enable(),this.leafMap.doubleClickZoom.enable(),this.leafMap.off(this.mapListeners),this.panelDiv.style.display="none",this.leafMap.removeLayer(this._layer),!0)},MeasureTool.prototype.onClick=function(t){return this.state!=measureState.IN_PROGRESS&&(this.measurePts=[],this._layer.clearLayers(),this.map.selectPoint()),this.state=measureState.IN_PROGRESS,this.addPt(t.latlng)&&this.update(),!1},MeasureTool.prototype.onMove=function(t){if(this.state==measureState.IN_PROGRESS){var e=t.latlng;isDrawing(t)?(this.addPt(e),this.update()):this.update(e)}},MeasureTool.prototype.onDblClick=function(t){return this.state=measureState.DONE,!1},MeasureTool.prototype.addPt=function(t){return!isPointSame(t,this.measurePts)&&(this.measurePts.push(t),!0)},MeasureTool.prototype.update=function(t){this.updateGraphic(this.measurePts,t),this.updateDisplay(this.measurePts,t)},MeasureTool.prototype.updateGraphic=function(t,e){e?(this.tentativeLine&&(this.tentativeLine.remove(),this.tentativeLine=null),t.length>0&&(this.tentativeLine=L.polyline([t[t.length-1],e],{color:"#ff00ff",weight:2,dashArray:"6,6",interactive:!1}),this.tentativeLine.addTo(this._layer))):L.polyline(t,{color:"#ff00ff",weight:2,interactive:!1}).addTo(this._layer)},MeasureTool.prototype.updateDisplay=function(t,e){var i=this.computeDistance(t,e),n=(i/1e3).toFixed(this.decimalPlaces)+" km",a=(i/1e3*.539957).toFixed(this.decimalPlaces)+" nm",o=(i/1e3*.621371).toFixed(this.decimalPlaces)+" mi";this.distText.textContent=n+" / "+o+" / "+a+"  ";var r=computeBearing(t,e);this.bearingText.textContent=r.toFixed(1)+" TN";var s=(computeRingArea(t)/1e4).toFixed(1);this.areaText.textContent=s+" ha"},MeasureTool.prototype.computeDistance=function(t,e){for(var i=0,n=1;n<t.length;n++)i+=this.leafMap.distance(t[n],t[n-1]);return e&&t.length>0&&(i+=this.leafMap.distance(t[t.length-1],e)),i},MeasureTool.prototype.computeMidpoint=function(t){for(var e=this.computeDistance(t)/2,i=0,n=1;n<t.length;n++){var a=this.leafMap.distance(t[n],t[n-1]);if(i+a>e)return locatePtAlong(t[n-1],t[n],(e-i)/a);i+=a}return Util.toLonLat(t[t.length-1])};var GEO_RADIUS=6378137;function computeRingArea(t){var e=t.length,i=0,n=0;if(e>2){for(var a=0;a<e;a++){var o=t[a%e],r=t[(a+1)%e];i+=(rad(t[(a+2)%e].lng)-rad(o.lng))*Math.sin(rad(r.lat))}n=i*GEO_RADIUS*GEO_RADIUS/2}return Math.abs(n)}function rad(t){return t*Math.PI/180}var SelectPointTool=function(t){Tool.call(this,t),this.mapClass="tool-map-active-selectpoint"};SelectPointTool.prototype=Object.create(Tool.prototype),SelectPointTool.prototype.initialize=function(){this.displayDiv=this.map.createElement("div","wfml-tool-selectpoint-panel"),this.inputText=L.DomUtil.create("input","wfml-tool-selectpoint-text",this.displayDiv),Util.stopProp(this.displayDiv)},SelectPointTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.leafMap.on("click",this.onClick,this),this.leafMap.on("mousemove",this.update,this),this.displayDiv.style.display="block",this.map.selectPoint(),!0)},SelectPointTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.leafMap.off("click",this.onClick,this),this.displayDiv.style.display="none",!0)},SelectPointTool.prototype.update=function(t){var e=Util.toLonLat(t.latlng),i=Location.format(e);this.inputText.value=i},SelectPointTool.prototype.onClick=function(t){this.update(t),this.inputText.select(),document.execCommand("copy");var e=Util.toLonLat(t.latlng);this.map.selectPoint(e),this.deactivate()};var IdentifyTool=function(t){Tool.call(this,t),this.mapClass="tool-map-active-identify",this.clickDelay=new Util.Timer(200)};IdentifyTool.prototype=Object.create(Tool.prototype),IdentifyTool.prototype.initialize=function(){var t,e=this,i=new Util.Timer(100);this.mgr.setActiveTool=(t=this.mgr.setActiveTool,function(n,a){t.call(this,n,a),a||i.start(function(){e.mgr.getActiveTool("main")||e.activate()})}),i.start(function(){e.activate()})},IdentifyTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.leafMap.on("click",this.onClick,this),this.leafMap.on("dblclick",this.onDblClick,this),!0)},IdentifyTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.leafMap.off("click",this.onClick,this),this.leafMap.off("dblclick",this.onDblClick,this),this.map.findFeatures(),!0)},IdentifyTool.prototype.onClick=function(t){var e=this;this.clickDelay.start(function(){e.map.findFeatures(t)})},IdentifyTool.prototype.onDblClick=function(t){this.clickDelay.cancel()};var WIDTH=300,TOOLTIP={LAYER_VIS_LAYER:"Click to change layer visibility",LAYER_VIS_FOLDER:"Click to change folder content visibility\nCtrl-click sets all to on",LAYER_FOLDER_EXPAND:"Click to open / close folder\nCtrl-click changes subfolders as well",LAYER_TITLE:"Double-click to zoom to scale range"},LayerListTool=function(t){Tool.call(this,Object.assign({group:"layer"},t)),this.isClickHandler=!1,this.isHoverHandler=!1,this.legendShow=!1,this.filterClear()};function setClass(t,e,i){i?L.DomUtil.addClass(t,e):L.DomUtil.removeClass(t,e)}function setItemTemporal(t){t.layer.isFolder()||(setClass(t.div,"wfml-layerlist-temporal",t.layer.layer.isTemporal()),setClass(t.div,"wfml-layerlist-live",t.layer.layer.isLive()),setClass(t.div,"wfml-layerlist-historical",t.layer.layer.isHistorical()))}function showLegend(t,e){if(t.legendDiv&&(t.legendDiv.style.display="none"),!t.layer.isFolder()&&t.layer.layer.isEnabled()&&e&&t.layer.visible()){if(null==t.legendDiv){var i=L.DomUtil.create("div","wfml-layerlist-legend",t.div);t.layer.layer.renderLegend(i,{title:!1})?t.legendDiv=i:L.DomUtil.remove(i)}t.legendDiv&&(t.legendDiv.style.display="block")}}function setLayerScale(t,e){e.layer.isInScaleRange()?L.DomUtil.removeClass(t,"wfml-layerlist-scale-out"):L.DomUtil.addClass(t,"wfml-layerlist-scale-out")}LayerListTool.prototype=Object.create(Tool.prototype),LayerListTool.prototype.initialize=function(){var t=this,e=this;this.map.leafMap.on("zoom",function(){e.onMapZoom()}),this.sidebar=this.map.sidebar().create("wfml-layerlist","Layer List",WIDTH,function(){e.deactivate()}),this.checkPool=Util.workPool(5),this.create(),this.render(),this.map.layerMgr.onTimeChange.push(function(){return t.setTemporal()})},LayerListTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.map.sidebar().show(this.sidebar,!0),!0)},LayerListTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.map.sidebar().show(this.sidebar,!1),!0)},LayerListTool.prototype.isFilterOn=function(){return this.filter.visible||this.filter.text&&this.filter.text.length>0},LayerListTool.prototype.filterClear=function(){this.filter={text:"",visible:!1}},LayerListTool.prototype.applyFilter=function(t){t?(t.hasOwnProperty("text")&&(this.filter.text=t.text),t.hasOwnProperty("visible")&&(this.filter.visible=t.visible)):this.filterClear(),this.render()},LayerListTool.prototype.isNodeFiltered=function(t){if(!this.filter.visible||t.visible())return this.filterMatches(t.title)},LayerListTool.prototype.filterMatches=function(t){if(!t)return!1;var e=new RegExp(this.filter.text,"i");return t.match(e)},LayerListTool.prototype.create=function(){var t=this,e=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-legend",this.sidebar.toolbar);e.title="Show or hide legend",e.addEventListener("click",function(){t.showLegends(e.classList.toggle("wfml-control-active"))});var i=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-filter",this.sidebar.toolbar);i.title="Filter layers",i.addEventListener("click",function(){var e=i.classList.toggle("wfml-control-active");o.classList.toggle("wfml-layerlist-filterbar-hidden",!e),e?(t.filterClear(),s.value="",c.checked=!1,s.focus()):t.applyFilter()});var n=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-hide",this.sidebar.toolbar);n.title="Hide all layers",n.addEventListener("click",function(){t.setLayersEnabled(!n.classList.toggle("wfml-control-active"))});var a=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-refresh",this.sidebar.toolbar);a.title="Refresh all layers",a.addEventListener("click",function(){t.refreshLayers()}),this.quickFilters=this.map.layerMgr.quickFilters,this.quickFilters&&this.quickFilters.length>0&&(this.quickFilterBar=L.DomUtil.create("div","wfml-layerlist-quick-filter-bar",this.sidebar.header),this.quickFilters.forEach(function(e){var i=L.DomUtil.create("span","wfml-quick-filter wfml-layerlist-vis-off",t.quickFilterBar);i.title="Show or hide "+e.title+" layers",i.addEventListener("click",function(){t.toggleQuickFilter(e)}),e.state=i,L.DomUtil.create("div","wfml-layerlist-state",i),L.DomUtil.create("div","",i).innerText=e.title}));var o=L.DomUtil.create("div","wfml-layerlist-filterbar wfml-layerlist-filterbar-hidden",this.sidebar.header),r=L.DomUtil.create("label","wfml-layerlist-filter-label",o);r.innerText="Filter ";var s=L.DomUtil.create("input","wfml-layerlist-filter-input",r);s.addEventListener("input",function(){t.applyFilter({text:s.value})});var l=L.DomUtil.create("label","",o);l.title="Include only visible layers in filter",L.DomUtil.create("span","wfml-layerlist-filter-visible-icon",l);var c=L.DomUtil.create("input","",l);c.type="checkbox",c.addEventListener("click",function(){t.applyFilter({visible:c.checked})}),this.layerListItemsDiv=L.DomUtil.create("div","wfml-layerlist",this.sidebar.content)},LayerListTool.prototype.matchedQuickFilters=function(t){return this.quickFilters.filter(function(e){return e.nodeTest(t)})},LayerListTool.prototype.connectQuickFilter=function(t){var e=this;this.matchedQuickFilters(t).forEach(function(e){e.layers.push(t)}),t.child&&t.child.forEach(function(t){e.connectQuickFilter(t)})},LayerListTool.prototype.updateQuickFilters=function(){var t=this;this.quickFilters.forEach(function(e){var i=e.layers;if(i&&0!=i.length){var n=i.reduce(function(t,e){return void 0===t?e.visible():t===e.visible()?t:null},void 0);t.setQuickFilterState(e,n)}})},LayerListTool.prototype.setQuickFilterState=function(t,e){!0===e?L.DomUtil.addClass(t.state,"wfml-layerlist-vis-on"):L.DomUtil.removeClass(t.state,"wfml-layerlist-vis-on"),!1===e?L.DomUtil.addClass(t.state,"wfml-layerlist-vis-off"):L.DomUtil.removeClass(t.state,"wfml-layerlist-vis-off"),null==e?L.DomUtil.addClass(t.state,"wfml-layerlist-vis-mixed"):L.DomUtil.removeClass(t.state,"wfml-layerlist-vis-mixed")},LayerListTool.prototype.getQuickFilterState=function(t){return!L.DomUtil.hasClass(t.state,"wfml-layerlist-vis-off")&&(!!L.DomUtil.hasClass(t.state,"wfml-layerlist-vis-on")||null)},LayerListTool.prototype.toggleQuickFilter=function(t){var e=this.getQuickFilterState(t);t.layers.forEach(function(t){t.visible(!e)}),this.updateOverlays()},LayerListTool.prototype.setLayersEnabled=function(t){this.map.layerMgr.enabled(t),t?(L.DomUtil.removeClass(this.layerListItemsDiv,"wfml-layerlist-disabled"),L.DomUtil.removeClass(this.quickFilterBar,"wfml-layerlist-disabled")):(L.DomUtil.addClass(this.layerListItemsDiv,"wfml-layerlist-disabled"),L.DomUtil.addClass(this.quickFilterBar,"wfml-layerlist-disabled"))},LayerListTool.prototype.refreshLayers=function(){this.map.layerMgr.update(!0),this.render()},LayerListTool.prototype.render=function(){var t=this.map.layerMgr.treeView();this.quickFilters.forEach(function(t){t.layers=[]}),this.connectQuickFilter(t),this.isFilterOn()&&this.filterSetState(t),this.listItems=[],L.DomUtil.empty(this.layerListItemsDiv),this.renderFolder(t,0,this.layerListItemsDiv),this.updateQuickFilters(),this.updateOverlays=function(){t.updateOverlays()},this.setTemporal()},LayerListTool.prototype.filterSetState=function(t){var e=!1;if(t.isFolder()){if(t.child)for(var i=0;i<t.child.length;i++)this.filterSetState(t.child[i])&&(e=!0,t.isFilterExpand=!0)}else this.isNodeFiltered(t)&&(e=!0);return t.isFilterVis=e,e},LayerListTool.prototype.setTemporal=function(){this.listItems.forEach(function(t){return setItemTemporal(t)})},LayerListTool.prototype.renderFolder=function(t,e,i){var n=i;if(t.title&&(n=this.renderItem(t,e,i)),t.child)for(var a=0;a<t.child.length;a++)this.renderFolder(t.child[a],e+1,n)},LayerListTool.prototype.renderItem=function(t,e,i){var n=this;if(!this.isFilterOn()||t.isFilterVis){var a=t.isFolder(),o=L.DomUtil.create("div","wfml-layerlist-item "+(a?"wfml-layerlist-folder":"wfml-layerlist-layer"),i);a||t.layer.isEnabled()||L.DomUtil.addClass(o,"wfml-layerlist-disabled");var r=null;if(a){var s=L.DomUtil.create("div","wfml-layerlist-expand",o);s.title=TOOLTIP.LAYER_FOLDER_EXPAND,r=L.DomUtil.create("div","wfml-layerlist-folder-container",i);var l=t.isMixed()||t.visible();this.isFilterOn()&&(l=t.isFilterExpand),f(r,s,l),s.addEventListener("click",function(t){!function(t){var e="none"!==r.style.display;(t.ctrlKey||t.shiftKey)&&function(t,e){for(var i=t.getElementsByClassName("wfml-layerlist-expand"),n=0;n<i.length;n++)i.item(n).classList.toggle("wfml-layerlist-close",!e);var a=t.getElementsByClassName("wfml-layerlist-folder-container");for(n=0;n<a.length;n++)a.item(n).style.display=e?"block":"none"}(r,!e),f(r,s,!e)}(t)})}else this.checkPool.add(function(){return t.layer.checkHealth(18e5,2e4).then(function(e){t.layer.enable(!0),t.layer.redraw()}).catch(function(e){o.title="Health check failed: "+e,t.layer.enable(!1),t.layer.redraw()})});var c=L.DomUtil.create("div","wfml-layerlist-state",o);c.title=a?TOOLTIP.LAYER_VIS_FOLDER:TOOLTIP.LAYER_VIS_LAYER,c.addEventListener("click",function(e){!function(e){if(e.ctrlKey||e.shiftKey)return t.visible(!0),void t.updateOverlays();if(o.classList.contains("wfml-layerlist-vis-mixed"))return t.visible(!1),void t.updateOverlays();var i=o.classList.contains("wfml-layerlist-vis-on");!i&&t.inMutex?(t.parent.visible(!1),t.parent.child.forEach(function(t){t.mutexDefaultVisible=!1}),t.mutexDefaultVisible=!0,t.visible(!0)):t.visible(!i),t.updateOverlays(),d()}(e)});var h=L.DomUtil.create("div","wfml-layerlist-title",o);h.innerText=t.title,h.addEventListener("dblclick",function(e){a||t.layer.zoomToScale()}),!a&&t.layer.hasScaleRange()&&(h.title=TOOLTIP.LAYER_TITLE);var u={layer:t,div:o,titleDiv:h};return p(),t.onChange(function(){p(),n.map.changedState()}),this.listItems.push(u),r}function p(){d(),n.updateQuickFilters(),t.isFolder()||(h.innerText=t.layer.getTitle(),setLayerScale(h,t))}function d(){o.classList.toggle("wfml-layerlist-vis-on",!t.isMixed()&&t.visible()),o.classList.toggle("wfml-layerlist-vis-off",!t.isMixed()&&!t.visible()),o.classList.toggle("wfml-layerlist-vis-mixed",t.isMixed()),o.classList.toggle("wfml-layerlist-disabled",!t.isFolder()&&!t.layer.enabled),showLegend(u,n.legendShow)}function f(t,e,i){t.style.display=i?"block":"none",e.classList.toggle("wfml-layerlist-close",!i)}},LayerListTool.prototype.onMapZoom=function(){this.listItems&&this.listItems.forEach(function(t){t.layer.isFolder()||setLayerScale(t.titleDiv,t.layer)})},LayerListTool.prototype.showLegends=function(t){this.listItems&&(this.legendShow=t,this.listItems.forEach(function(e){showLegend(e,t)}))};var LegendTool=function(t){Tool.call(this,Object.assign({group:"layer"},t)),this.isClickHandler=!1,this.isHoverHandler=!1};function renderLegend(t,e){L.DomUtil.empty(e.content);var i=L.DomUtil.create("div","wfml-legend",e.content);t.layerMgr.legend().forEach(function(t){t.renderLegend(i)})}LegendTool.prototype=Object.create(Tool.prototype),LegendTool.prototype.activate=function(){var t=this;return!!Tool.prototype.activate.apply(this)&&(this.map.sidebars.legend||(this.map.sidebars.legend=this.map.sidebar().create("wfml-legend","Legend",null,function(){t.deactivate()})),renderLegend(this.map,this.map.sidebars.legend),this.map.sidebar().show(this.map.sidebars.legend,!0),!0)},LegendTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.map.sidebar().show(this.map.sidebars.legend,!1),!0)};var BaseMapTool=function(t){Tool.call(this,Object.assign({group:"layer"},t)),this.isClickHandler=!1,this.isHoverHandler=!1};BaseMapTool.prototype=Object.create(Tool.prototype),BaseMapTool.prototype.initialize=function(){var t=this;this.sidebar=this.map.sidebar().create("wfml-basemaps","Base Maps",null,function(){t.deactivate()})},BaseMapTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.render(),this.map.sidebar().show(this.sidebar,!0),!0)},BaseMapTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.map.sidebar().show(this.sidebar,!1),!0)},BaseMapTool.prototype.render=function(){var t=this;L.DomUtil.empty(this.sidebar.content);var e=L.DomUtil.create("div","wfml-basemaps",this.sidebar.content);this.map._baseMaps.forEach(function(i){var n=L.DomUtil.create("div","wfml-basemap-entry",e);L.DomEvent.on(n,"click",function(){t.map.setBasemap(i.key),t.render()}),i.key==t.map.currentBase.key&&L.DomUtil.addClass(n,"wfml-basemap-current"),L.DomUtil.create("div","wfml-basemap-thumbnail",n).style.backgroundImage="url('"+function(t){var e=t.layer._url;return e.substring(0,e.length-11)+"13/2825/1284"}(i)+"')",L.DomUtil.create("div","wfml-basemap-title",n).innerHTML=i.title})};var TimeTool=function(t){Tool.call(this,Object.assign({group:"layer"},t)),this.isClickHandler=!1,this.isHoverHandler=!1};function normalizeTime(t){if(t.includes(":"))return t.padStart(5,"0");t.padStart(4,"0").split(/(.{2})/).filter(function(t){return t}).join(":")}function timeMode(t){if(t.start instanceof Interval&&t.end==PRESENT)return"present";if(t.start instanceof Date&&t.end instanceof Date)return"historical";throw"Unsupported time range"}function fixOutline(t){t.onkeydown=function(){setTimeout(function(){"none"==t.style.outline&&L.DomUtil.restoreOutline()},1)}}function hideIf(t,e,i){e?L.DomUtil.addClass(t,i):L.DomUtil.removeClass(t,i)}TimeTool.prototype=Object.create(Tool.prototype),TimeTool.prototype.now=function(){return new Date},TimeTool.prototype.initialize=function(){var t=this,e=this;this.sidebar=this.map.sidebar().create("wfml-time-range","Time",null,function(){e.deactivate()}),this.times={},this.updateTime(!1),this.map.layerMgr.onTimeChange.push(function(){return t.updateTime()})},TimeTool.prototype.activate=function(){return!!Tool.prototype.activate.apply(this)&&(this.render(),this.map.sidebar().show(this.sidebar,!0),!0)},TimeTool.prototype.deactivate=function(){return!!Tool.prototype.deactivate.apply(this)&&(this.map.sidebar().show(this.sidebar,!1),!0)},TimeTool.prototype.recomputeTime=function(t){if(this.inputValid()){var e=this.computeTime();!t&&e.equals(this.times[this.mode])||(this.times[this.mode]=e,this.map.layerMgr.setTime(e),this.map.changedState())}},TimeTool.prototype.computeTime=function(){if("present"==this.mode)return new DateRange(new Interval(parseInt(this.presentValueInput.value),Units[this.presentUnitInput.value]),PRESENT);if("historical"==this.mode)return new DateRange(new Date(this.historicalStartInput.date.value+"T"+normalizeTime(this.historicalStartInput.time.value)),new Date(this.historicalEndInput.date.value+"T"+normalizeTime(this.historicalEndInput.time.value)));throw"Unsupported time range"},TimeTool.prototype.hasInputs=function(){var t=[this.presentValueInput,this.presentUnitInput,this.historicalStartInput,this.historicalEndInput].map(function(t){return!!t}).filter(function(t,e,i){return i.indexOf(t)===e});if(1===t.length)return t[0];throw"Time tool has not been properly initialized as only some of its inputs are present"},TimeTool.prototype.updateTime=function(t){var e=this.map.layerMgr.time,i=timeMode(e),n=this.mode!=i;this.mode=i;var a=!e.equals(this.times[this.mode]);this.times[this.mode]=e,null==t&&(t=n||a),t&&this.updateInputs()},TimeTool.prototype.getTime=function(){return this.times[this.mode]||("present"==this.mode?this.times.present=DateRange.parseWms("PT24H/PRESENT"):"historical"==this.mode&&(this.times.historical=this.times.present.fix(this.now()))),this.times[this.mode]},TimeTool.prototype.render=function(){var t=this;this.updateTime(!1),this.validityMessages={},L.DomUtil.empty(this.sidebar.content);var e=L.DomUtil.create("div","wfml-time-range",this.sidebar.content),i=L.DomUtil.create("form","wfml-time-mode",e),n=[o("wfml-time-mode-present","mode","present","Present",i,function(){return a()},"present"==this.mode),o("wfml-time-mode-historical","mode","historical","Historical",i,function(){return a()},"historical"==this.mode)];function a(){var e=n.find(function(t){return t.checked}).value;e!=t.mode&&(t.mode=e,t.updateInputs(),t.recomputeTime(!0))}function o(t,e,i,n,a,o,r){void 0===r&&(r=!1);var s=L.DomUtil.create("span",null,a);return function(t,e,i,n){var a=L.DomUtil.create("label","wfml-time-range-mode-label",s);a.setAttribute("for",t),a.textContent=e}(t,n),function(t,e,i,n,a,o){void 0===o&&(o=!1);var r=L.DomUtil.create("input","wfml-time-range-mode-button",s);return r.setAttribute("type","radio"),r.setAttribute("id",t),r.setAttribute("name",e),r.setAttribute("value",i),r.checked=o,r.onclick=a,r.onkeydown=a,r}(t,e,i,0,o,r)}function r(t,e,i){var n={},a=L.DomUtil.create("span",e,t);return n.date=function(t,e){var i=L.DomUtil.create("input","wfml-time-historical-date",a);return i.setAttribute("type","date"),i.setAttribute("required",!0),i.onchange=e,i}(0,i),n.time=function(t,e){var i=L.DomUtil.create("input","wfml-time-historical-time",a);return i.setAttribute("type","text"),i.pattern="(([01]?\\d|2[0123]):[0-5]\\d)|(24:00)",i.setAttribute("required",!0),i.onchange=e,i}(0,i),fixOutline(n.time),n.container=a,n}this.presentSection=L.DomUtil.create("div","wfml-time-range-present",e),function(e){L.DomUtil.create("span",null,e).textContent="Last ",t.presentValueInput=L.DomUtil.create("input","wfml-time-interval-value",e),t.presentValueInput.setAttribute("type","number"),fixOutline(t.presentValueInput);var i=function(){return t.recomputeTime()};t.presentUnitInput=L.DomUtil.create("select","wfml-time-interval-unit",e),Object.entries(Units).forEach(function(e){var i=L.DomUtil.create("option","wfml-time-interval-unit-option",t.presentUnitInput);i.setAttribute("value",e[0]),i.textContent=e[1].name}),t.validityMessages.present=L.DomUtil.create("div","wfml-time-validity",e),t.presentValueInput.onchange=i,t.presentUnitInput.onchange=i}(this.presentSection),this.historicalSection=L.DomUtil.create("div","wfml-time-range-historical",e),function(e){var i=function(){return t.recomputeTime()};t.historicalStartInput=r(e,"wfml-time-historical-start",i);var n=L.DomUtil.create("div",null,e);n.textContent=" until ",n.style="text-align: center;",t.historicalEndInput=r(e,"wfml-time-historical-end",i),t.validityMessages.historical=L.DomUtil.create("div","wfml-time-validity",e)}(this.historicalSection),this.updateInputs()},TimeTool.prototype.forMode=function(t){var e=t[this.mode];if(null==e)throw"Unknown mode "+this.mode;return e()},TimeTool.prototype.updateInputs=function(){var t=this;this.hasInputs()&&(this.forMode({present:function(){return t.updatePresent()},historical:function(){return t.updateHistorical()}}),hideIf(this.presentSection,"present"!=this.mode,"wfml-time-mode-hidden"),hideIf(this.historicalSection,"historical"!=this.mode,"wfml-time-mode-hidden"))},TimeTool.prototype.updatePresent=function(){var t=this.getTime().start;this.presentValueInput.value=t.value,this.presentUnitInput.value=t.unit.name.toUpperCase()},TimeTool.prototype.updateHistorical=function(){var t=this.getTime().start,e=this.getTime().end,i=Intl.DateTimeFormat("en-CA",{timeZone:this.timezone,hour12:!1,year:"numeric",month:"2-digit",day:"2-digit"}),n=Intl.DateTimeFormat("en-CA",{timeZone:this.timezone,hour12:!1,hour:"numeric",minute:"2-digit"});this.historicalStartInput.date.value=i.format(t),this.historicalStartInput.time.value=n.format(t),this.historicalEndInput.date.value=i.format(e),this.historicalEndInput.time.value=n.format(e)};var TIME_WINDOW_SIZE=new Interval(30,Units.DAYS),_initControlPos;function setValidityMessages(t,e){L.DomUtil.empty(t),e.filter(function(t){return!t.checkValidity()}).map(function(t){return t.validationMessage}).filter(function(t,e,i){return i.indexOf(t)==e}).forEach(function(e){L.DomUtil.create("div","wfml-time-message",t).textContent=e})}function formatNumber$1(t,e){var i=Math.floor(t),n=t-i;return i.toLocaleString()+(e&&e>0?n.toFixed(e).substr(1):"")}function buildMap(t,e,i,n){return e.center&&(t.view.center=e.center),e.zoom&&(t.view.level=e.zoom),initLeaflet(t,e,i),n&&Object.keys(n).forEach(function(e){var i=e.split(".");if(3!=i.length)throw new Error("handler keys must have 3 parts separated by .: "+e);t.setHandler(i[0],i[1],i[2],n[e])}),t.zoomFull(),initTools(t,e,i),initBaseMaps(t,e,i),initLayers(t,e,i),initControls(t,e,i),t}function initLeaflet(t,e,i){t.leafMap=L.map(t.mapId,e.leafOpt),t.layer.markers=L.layerGroup().addTo(t.leafMap),t.layer.highlight=L.layerGroup().addTo(t.leafMap),t.leafMap.on("click",function(e){t.onClick([e.latlng.lng,e.latlng.lat])}),t.leafMap.on("mousemove",function(e){t.onHover(e)}),t.leafMap.on("mouseout",function(){t.hoverTimer&&t.hoverTimer.cancel()}),t.leafMap.on("zoomend moveend",function(){t.callback.extentChange&&t.callback.extentChange(),t.changedState()})}function initTools(t,e,i){t.toolMgr=new ToolManager(t)}TimeTool.prototype.historicalValid=function(){var t=this.now(),e=new Date(this.historicalEndInput.date.value),i=new Date(this.historicalStartInput.date.value),n=this.now();n.setMonth(n.getMonth()-6);var a=new Date(Math.max(n.valueOf(),i.valueOf())),o=new Date(Math.min(e.valueOf(),t.valueOf())),r=t;function s(t){return t?t.toISOString().split("T")[0]:null}this.historicalStartInput.date.min=s(n),this.historicalEndInput.date.min=s(a),this.historicalStartInput.date.max=s(o),this.historicalEndInput.date.max=s(r),this.historicalStartInput.time.value=this.historicalStartInput.time.value.replace(/^(\d?\d)(\d\d)$/,function(t,e,i){return e+":"+i}),this.historicalEndInput.time.value=this.historicalEndInput.time.value.replace(/^(\d?\d)(\d\d)$/,function(t,e,i){return e+":"+i});var l=s(i)===s(e)&&parseInt(this.historicalStartInput.time.value.replace(":",""))>=parseInt(this.historicalEndInput.time.value.replace(":",""))?"Start must be before end if they are on the same day":"",c=e-i>TIME_WINDOW_SIZE.value*TIME_WINDOW_SIZE.unit.seconds*1e3?"Range must be less than "+TIME_WINDOW_SIZE.value+" "+TIME_WINDOW_SIZE.unit.name:"";this.historicalStartInput.time.setCustomValidity(l),this.historicalEndInput.time.setCustomValidity(l),this.historicalStartInput.date.setCustomValidity(c),this.historicalEndInput.date.setCustomValidity(c);var h=[this.historicalEndInput,this.historicalStartInput].flatMap(function(t){return["date","time"].map(function(e){return t[e]})});return setValidityMessages(this.validityMessages.historical,h),h.every(function(t){return t.checkValidity()})},TimeTool.prototype.presentValid=function(){var t=TIME_WINDOW_SIZE.before(this.now()),e=(this.now()-t)/1e3,i=Math.ceil(e/Units[this.presentUnitInput.value].seconds);return this.presentValueInput.min=1,this.presentValueInput.max=i,setValidityMessages(this.validityMessages.present,[this.presentValueInput,this.presentUnitInput]),[this.presentValueInput,this.presentUnitInput].every(function(t){return t.checkValidity()})},TimeTool.prototype.inputValid=function(){var t=this;return this.forMode({present:function(){return t.presentValid()},historical:function(){return t.historicalValid()}})},TimeTool.prototype.getState=function(){var t=Object.fromEntries(Object.entries(this.times).filter(function(t){return void 0!==t[1]}).map(function(t){return[t[0],t[1].getWms()]}));return t.mode=this.mode,t},TimeTool.prototype.setState=function(t){var e=this;["present","historical"].forEach(function(i){return e.times[i]=DateRange.parseWms(t[i])}),this.mode=t.mode,this.map.layerMgr.setTime(this.times[this.mode]),this.updateInputs(),this.map.changedState()},L.Map.prototype._initControlPos=(_initControlPos=L.Map.prototype._initControlPos,function(){_initControlPos.apply(this,arguments),this._controlCorners.topcenter=L.DomUtil.create("div","leaflet-top leaflet-center",this._controlContainer),this._controlCorners.bottomcenter=L.DomUtil.create("div","leaflet-bottom leaflet-center",L.DomUtil.create("div","leaflet-control-bottomcenter",this._controlContainer))}),L.Crosshairs=L.LayerGroup.extend({options:{style:{opacity:1,fillOpacity:0,weight:2,color:"#f00",radius:20}},initialize:function(t,e){L.LayerGroup.prototype.initialize.call(this),L.Util.setOptions(this,e),this.loc=L.latLng(t)},onAdd:function(t){for(var e in this._map=t,this.crosshair={circle:L.circleMarker([0,0],this.options.style),longitude_line_north:L.polyline([],this.options.style),longitude_line_south:L.polyline([],this.options.style),latitude_line_east:L.polyline([],this.options.style),latitude_line_west:L.polyline([],this.options.style)},this.crosshair)this.addLayer(this.crosshair[e]);this._setCrosshairs(this.loc),this._show(),this._map.on("moveend",this._setCrosshairs.bind(this)),this.eachLayer(t.addLayer,t)},onRemove:function(t){this._map.off("moveend",this._setCrosshairs),this.eachLayer(this.removeLayer,this)},_show:function(){this.eachLayer(function(t){this._map.addLayer(t)},this)},_hide:function(){this.eachLayer(function(t){this._map.removeLayer(t)},this)},_setCrosshairs:function(){var t=this.loc;if(t&&this._map){this.crosshair.circle.setLatLng(t);var e=this._map.project(t);this.crosshair.longitude_line_north.setLatLngs([this._map.unproject([e.x,e.y-this.options.style.radius]),this._map.unproject([e.x,this._map.getPixelBounds().min.y])]),this.crosshair.longitude_line_south.setLatLngs([this._map.unproject([e.x,e.y+this.options.style.radius]),this._map.unproject([e.x,this._map.getPixelBounds().max.y])]),this.crosshair.latitude_line_east.setLatLngs([this._map.unproject([e.x-this.options.style.radius,e.y]),this._map.unproject([this._map.getPixelBounds().min.x,e.y])]),this.crosshair.latitude_line_west.setLatLngs([this._map.unproject([e.x+this.options.style.radius,e.y]),this._map.unproject([this._map.getPixelBounds().max.x,e.y])])}}}),L.crosshairs=function(t,e){return new L.Crosshairs(t,e)},L.Arrow=L.LayerGroup.extend({options:{title:null,style:{opacity:1,fillOpacity:1,weight:2,fillColor:"#0c0",color:"#080"}},initialize:function(t,e,i){L.LayerGroup.prototype.initialize.call(this),L.Util.setOptions(this,i),this.locStart=L.latLng(t),this.locEnd=L.latLng(e)},onAdd:function(t){for(var e in this._map=t,this.symbol={arrow:L.polygon([],this.options.style)},this.symbol)this.addLayer(this.symbol[e]);this._setArrow(this.locStart,this.locEnd),this._show(),this.eachLayer(t.addLayer,t)},onRemove:function(t){this.eachLayer(this.removeLayer,this)},_show:function(){this.eachLayer(function(t){this._map.addLayer(t)},this)},_hide:function(){this.eachLayer(function(t){this._map.removeLayer(t)},this)},_setArrow:function(){if(this.locStart&&this.locEnd&&this._map){var t=this._map.project(this.locStart),e=this._map.project(this.locEnd),i=(this._map.getPixelBounds(),e.x-t.x),n=e.y-t.y,a=Math.sqrt(i*i+n*n),o=i/a,r=n/a;if(!(100>a)){var s=function(t,e){for(var i=[],n=0;n<e.length;n++)i.push(t.unproject(e[n]));return i}(this._map,function(t,e,i){for(var n=[],a=0;a<t.length;a++)n.push([t[a][0]+e,t[a][1]+i]);return n}([[23*o+3*-r,23*r+3*o],[23*o+3*r,23*r+3*-o],[75*o+5*r,75*r+5*-o],[75*o+15*r,75*r+15*-o],[100*o,100*r],[75*o+15*-r,75*r+15*o],[75*o+5*-r,75*r+5*o]],t.x,t.y)),l=s[4];this.symbol.arrow.setLatLngs(s),this.options.title&&this.options.title.length>0&&(this.symbol.arrow.bindTooltip(this.options.title,{permanent:!0,offset:[0,10],direction:o<=0?"left":"right"}),this.symbol.arrow.openTooltip(l))}}}}),L.arrow=function(t,e,i){return new L.Arrow(t,e,i)},L.Layer.include({showDelay:1200,hideDelay:0,bindTooltipDelayed:function(t,e){return t instanceof L.Tooltip?(L.setOptions(t,e),this._tooltip=t,t._source=this):(this._tooltip&&!e||(this._tooltip=new L.Tooltip(e,this)),this._tooltip.setContent(t)),this._initTooltipInteractionsDelayed(),this._tooltip.options.permanent&&this._map&&this._map.hasLayer(this)&&this.openTooltipWithDelay(),this},_openTooltipDelayed:function(t){this._tooltip&&this._map&&this.openTooltipWithDelay(t.layer||t.target,this._tooltip.options.sticky?t.latlng:void 0)},openTooltipDelayed:function(t,e){if(t instanceof L.Layer||(e=t,t=this),t instanceof L.FeatureGroup)for(var i in this._layers){t=this._layers[i];break}return e||(e=t.getCenter?t.getCenter():t.getLatLng()),this._tooltip&&this._map&&(this._tooltip._source=t,this._tooltip.update(),this._map.openTooltip(this._tooltip,e),this._tooltip.options.interactive&&this._tooltip._container&&(addClass(this._tooltip._container,"leaflet-clickable"),this.addInteractiveTarget(this._tooltip._container))),this},openTooltipWithDelay:function(t,e){this._delay(this.openTooltipDelayed,this,this.showDelay,t,e)},closeTooltipDelayed:function(){return this._tooltip&&(this._tooltip._close(),this._tooltip.options.interactive&&this._tooltip._container&&(removeClass(this._tooltip._container,"leaflet-clickable"),this.removeInteractiveTarget(this._tooltip._container))),this},closeTooltipWithDelay:function(){clearTimeout(this._timeout),this._delay(this.closeTooltipDelayed,this,this.hideDelay)},_delay:function(t,e,i,n,a){var o=this;this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(function(){t.call(e,n,a),delete o._timeout},i)},_initTooltipInteractionsDelayed:function(t){if(t||!this._tooltipHandlersAdded){var e=t?"off":"on",i={remove:this.closeTooltipWithDelay,move:this._moveTooltip};this._tooltip.options.permanent?i.add=this._openTooltipDelayed:(i.mouseover=this._openTooltipDelayed,i.mouseout=this.closeTooltipWithDelay,i.click=this.closeTooltipWithDelay,this._tooltip.options.sticky&&(i.mousemove=this._moveTooltip),L.touch&&(i.click=this._openTooltipDelayed)),this[e](i),this._tooltipHandlersAdded=!t}}}),L.Tooltip.include({_setPosition:function(t){var e=this._map,i=this._container,n=e.latLngToContainerPoint(e.getCenter()),a=e.layerPointToContainerPoint(t),o=this.options.direction,r=i.offsetWidth,s=i.offsetHeight,l=L.point(this.options.offset),c=this._getAnchor();if("auto-all"===o){var h=L.point(2*n.x,2*n.y),u={left:a.x-r-20<0,right:a.x+r+20>h.x,top:a.y-s-20<0,bottom:a.y+s+20>h.y};o="top";var p=[0,-1];u.top?(o="bottom",p=[0,1],u.left?(o="bottom-right",p=[1,1]):u.right&&(o="bottom-left",p=[-1,1])):u.bottom?(o="top",p=[0,-1],u.left?(o="top-right",p=[1,-1]):u.right&&(o="top-left",p=[-1,-1])):u.left?(o="right",p=[1,0]):u.right&&(o="left",p=[-1,0]),l=L.point(p[0]*l.x,p[1]*l.y)}var d=o;"top"===o?t=t.add(L.point(-r/2+l.x,-s+l.y+c.y,!0)):"top-left"===o?t=t.add(L.point(-(r+c.x-l.x),-s+l.y+c.y,!0)):"top-right"===o?t=t.add(L.point(l.x+c.x,-s+l.y+c.y,!0)):"bottom"===o?t=t.subtract(L.point(r/2-l.x,-l.y,!0)):"bottom-left"===o?t=t.subtract(L.point(r+c.x-l.x,-l.y,!0)):"bottom-right"===o?t=t.subtract(L.point(-(l.x+c.x),-l.y,!0)):"center"===o?t=t.subtract(L.point(r/2+l.x,s/2-c.y+l.y,!0)):"right"===o||"auto"===o&&a.x<n.x?(d="right",t=t.add(L.point(l.x+c.x,c.y-s/2+l.y,!0))):(d="left",t=t.subtract(L.point(r+c.x-l.x,s/2-c.y-l.y,!0))),L.DomUtil.removeClass(i,"leaflet-tooltip-right"),L.DomUtil.removeClass(i,"leaflet-tooltip-left"),L.DomUtil.removeClass(i,"leaflet-tooltip-top"),L.DomUtil.removeClass(i,"leaflet-tooltip-bottom"),L.DomUtil.addClass(i,"leaflet-tooltip-"+d),L.DomUtil.setPosition(i,t)}}),L.NonTiledLayer=(L.Layer||L.Class).extend({includes:L.Evented||L.Mixin.Events,emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",options:{attribution:"",opacity:1,zIndex:void 0,minZoom:0,maxZoom:18,pointerEvents:null,errorImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",bounds:L.latLngBounds([-85.05,-180],[85.05,180]),useCanvas:void 0},key:"",initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._map=t,void 0===this._zoomAnimated&&(this._zoomAnimated=L.DomUtil.TRANSITION&&L.Browser.any3d&&!L.Browser.mobileOpera&&this._map.options.zoomAnimation),L.version<"1.0"&&this._map.on(this.getEvents(),this),this._div||(this._div=L.DomUtil.create("div","leaflet-image-layer"),this.options.pointerEvents&&(this._div.style["pointer-events"]=this.options.pointerEvents),void 0!==this.options.zIndex&&(this._div.style.zIndex=this.options.zIndex),void 0!==this.options.opacity&&(this._div.style.opacity=this.options.opacity)),this.getPane().appendChild(this._div);var e=!!window.HTMLCanvasElement;this._useCanvas=void 0===this.options.useCanvas?e:this.options.useCanvas,this._useCanvas?(this._bufferCanvas=this._initCanvas(),this._currentCanvas=this._initCanvas()):(this._bufferImage=this._initImage(),this._currentImage=this._initImage()),this._update()},getPane:function(){return L.Layer?L.Layer.prototype.getPane.call(this):(this._pane=this.options.pane?this.options.pane:this._map.getPanes().overlayPane,this._pane)},onRemove:function(t){L.version<"1.0"&&this._map.off(this.getEvents(),this),this.getPane().removeChild(this._div),this._useCanvas?(this._div.removeChild(this._bufferCanvas),this._div.removeChild(this._currentCanvas),this.isLoading()&&(this._currentCanvas._image.src="")):(this._div.removeChild(this._bufferImage),this._div.removeChild(this._currentImage),this.isLoading()&&(this._currentImage.src=""))},addTo:function(t){return t.addLayer(this),this},_setZoom:function(){this._useCanvas?(this._currentCanvas._bounds&&this._resetImageScale(this._currentCanvas,!0),this._bufferCanvas._bounds&&this._resetImageScale(this._bufferCanvas)):(this._currentImage._bounds&&this._resetImageScale(this._currentImage,!0),this._bufferImage._bounds&&this._resetImageScale(this._bufferImage))},getEvents:function(){var t={moveend:this._update};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),L.version>="1.0"&&(t.zoom=this._setZoom),t},getElement:function(){return this._div},setOpacity:function(t){return this.options.opacity=t,this._div&&L.DomUtil.setOpacity(this._div,this.options.opacity),this},setZIndex:function(t){return t&&(this.options.zIndex=t,this._div&&(this._div.style.zIndex=t)),this},bringToFront:function(){return this._div&&this.getPane().appendChild(this._div),this},bringToBack:function(){return this._div&&this.getPane().insertBefore(this._div,this.getPane().firstChild),this},getAttribution:function(){return this.options.attribution},_initCanvas:function(){var t=L.DomUtil.create("canvas","leaflet-image-layer");return this._div.appendChild(t),t._image=new Image,this._ctx=t.getContext("2d"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(t,"leaflet-zoom-animated"):L.DomUtil.addClass(t,"leaflet-zoom-hide"),L.extend(t._image,{onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)}),t},_initImage:function(){var t=L.DomUtil.create("img","leaflet-image-layer");return this._div.appendChild(t),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(t,"leaflet-zoom-animated"):L.DomUtil.addClass(t,"leaflet-zoom-hide"),L.extend(t,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)}),t},redraw:function(){return this._map&&this._update(),this},_animateZoom:function(t){this._useCanvas?(this._currentCanvas._bounds&&this._animateImage(this._currentCanvas,t),this._bufferCanvas._bounds&&this._animateImage(this._bufferCanvas,t)):(this._currentImage._bounds&&this._animateImage(this._currentImage,t),this._bufferImage._bounds&&this._animateImage(this._bufferImage,t))},_animateImage:function(t,e){if(void 0===L.DomUtil.setTransform){var i=t._scale*(l=this._map).getZoomScale(e.zoom),n=t._bounds.getNorthWest(),a=t._bounds.getSouthEast(),o=l._latLngToNewLayerPoint(n,e.zoom,e.center),r=l._latLngToNewLayerPoint(a,e.zoom,e.center)._subtract(o),s=o._add(r._multiplyBy(.5*(1-1/i)));t.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(s)+" scale("+i+") "}else{var l;i=t._scale*t._sscale*(l=this._map).getZoomScale(e.zoom),n=t._bounds.getNorthWest(),a=t._bounds.getSouthEast(),o=l._latLngToNewLayerPoint(n,e.zoom,e.center),L.DomUtil.setTransform(t,o,i)}t._lastScale=i},_resetImageScale:function(t,e){var i=new L.Bounds(this._map.latLngToLayerPoint(t._bounds.getNorthWest()),this._map.latLngToLayerPoint(t._bounds.getSouthEast())),n=t._orgBounds.getSize().y,a=i.getSize().y/n;t._sscale=a,L.DomUtil.setTransform(t,i.min,a)},_resetImage:function(t){var e=new L.Bounds(this._map.latLngToLayerPoint(t._bounds.getNorthWest()),this._map.latLngToLayerPoint(t._bounds.getSouthEast())),i=e.getSize();L.DomUtil.setPosition(t,e.min),t._orgBounds=e,t._sscale=1,this._useCanvas?(t.width=i.x,t.height=i.y):(t.style.width=i.x+"px",t.style.height=i.y+"px")},_getClippedBounds:function(){var t=this._map.getBounds(),e=t.getSouth(),i=t.getNorth(),n=t.getWest(),a=t.getEast(),o=this.options.bounds.getSouth(),r=this.options.bounds.getNorth(),s=this.options.bounds.getWest(),l=this.options.bounds.getEast();e<o&&(e=o),i>r&&(i=r),n<s&&(n=s),a>l&&(a=l);var c=new L.LatLng(i,n),h=new L.LatLng(e,a);return new L.LatLngBounds(c,h)},_update:function(){var t,e=this._getClippedBounds(),i=this._map.latLngToContainerPoint(e.getNorthWest()),n=this._map.latLngToContainerPoint(e.getSouthEast()),a=n.x-i.x,o=n.y-i.y;if(this._useCanvas?(this._bufferCanvas._scale=this._bufferCanvas._lastScale,this._currentCanvas._scale=this._currentCanvas._lastScale=1,this._bufferCanvas._sscale=1,this._currentCanvas._bounds=e,this._resetImage(this._currentCanvas),t=this._currentCanvas._image,L.DomUtil.setOpacity(t,0)):(this._bufferImage._scale=this._bufferImage._lastScale,this._currentImage._scale=this._currentImage._lastScale=1,this._bufferImage._sscale=1,this._currentImage._bounds=e,this._resetImage(this._currentImage),t=this._currentImage,L.DomUtil.setOpacity(t,0)),this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom||a<32||o<32)return this._div.style.visibility="hidden",t.src=this.emptyImageUrl,this.key=t.key="<empty>",void(t.tag=null);this._loading=!0,this.fire("loading"),this.key=e.getNorthWest()+", "+e.getSouthEast()+", "+a+", "+o,this.getImageUrl?(t.src=this.getImageUrl(e,a,o),t.key=this.key):this.getImageUrlAsync(e,a,o,this.key,function(e,i,n){t.key=e,t.src=i,t.tag=n})},_onImageError:function(t){this._loading=!1,this.fire("error",t),L.DomUtil.addClass(t.target,"invalid"),t.target.src!==this.options.errorImageUrl&&(t.target.src=this.options.errorImageUrl)},_onImageLoad:function(t){(t.target.src===this.options.errorImageUrl||(L.DomUtil.removeClass(t.target,"invalid"),t.target.key&&t.target.key===this.key))&&(this._onImageDone(t),this._loading=!1,this.fire("load",t))},isLoading:function(t){return this._loading},_onImageDone:function(t){if(this._useCanvas)this._renderCanvas(t);else{L.DomUtil.setOpacity(this._currentImage,1),L.DomUtil.setOpacity(this._bufferImage,0),this._addInteraction&&this._currentImage.tag&&this._addInteraction(this._currentImage.tag);var e=this._bufferImage;this._bufferImage=this._currentImage,this._currentImage=e}"<empty>"!==t.target.key&&(this._div.style.visibility="visible")},_renderCanvas:function(t){this._currentCanvas.getContext("2d").drawImage(this._currentCanvas._image,0,0),L.DomUtil.setOpacity(this._currentCanvas,1),L.DomUtil.setOpacity(this._bufferCanvas,0),this._addInteraction&&this._currentCanvas._image.tag&&this._addInteraction(this._currentCanvas._image.tag);var e=this._bufferCanvas;this._bufferCanvas=this._currentCanvas,this._currentCanvas=e}}),L.nonTiledLayer=function(){return new L.NonTiledLayer},L.NonTiledLayer.WMS=L.NonTiledLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},options:{crs:null,uppercase:!1},initialize:function(t,e){this._wmsUrl=t;var i=L.extend({},this.defaultWmsParams);for(var n in e)L.NonTiledLayer.prototype.options.hasOwnProperty(n)||L.Layer&&L.Layer.prototype.options.hasOwnProperty(n)||(i[n]=e[n]);this.wmsParams=i,L.setOptions(this,e)},onAdd:function(t){this._crs=this.options.crs||t.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version),this.wmsParams[this._wmsVersion>=1.3?"crs":"srs"]=this._crs.code,L.NonTiledLayer.prototype.onAdd.call(this,t)},getImageUrl:function(t,e,i){var n=this.wmsParams;n.width=e,n.height=i;var a=this._crs.project(t.getNorthWest()),o=this._crs.project(t.getSouthEast()),r=this._wmsUrl,s=s=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[o.y,a.x,a.y,o.x]:[a.x,o.y,o.x,a.y]).join(",");return r+L.Util.getParamString(this.wmsParams,r,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+s},getBbox:function(){var t=this._getClippedBounds(),e=this._crs.project(t.getNorthWest()),i=this._crs.project(t.getSouthEast()),n=n=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[i.y,e.x,e.y,i.x]:[e.x,i.y,i.x,e.y]).join(",");return n},setParams:function(t,e){return L.extend(this.wmsParams,t),e||this.redraw(),this}}),L.nonTiledLayer.wms=function(t,e){return new L.NonTiledLayer.WMS(t,e)},L.LoadSpinner=L.Control.extend({options:{position:"bottomcenter"},initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control-spinner");return this.div=e,this.div.style.display="none",e},onRemove:function(t){},disable:function(){return this.div.style.display="none",this},enable:function(){return this.div.style.display="block",this}}),L.loadSpinner=function(){return new L.LoadSpinner},L.Control.BoxZoom=L.Control.extend({options:{position:"topleft",title:"Zoom to Box",onFinished:function(){}},initialize:function(t){L.Util.setOptions(this,t)},onAdd:function(t){return this.map=t,this.active=!1,this.controlDiv=L.DomUtil.create("div","wfml-control wfml-control-zoom-box"),this.controlDiv.setAttribute("title",this.options.title),this.controlDiv.control=this,L.DomEvent.on(this.controlDiv,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(this.controlDiv,"click",L.DomEvent.stopPropagation),L.DomEvent.on(this.controlDiv,"click",L.DomEvent.preventDefault),L.DomEvent.on(this.controlDiv,"click",function(){this.control.toggleState()}),this.setShiftKeyHandler(),this.setStateOff(),this.controlDiv},toggleState:function(){this.active?this.setStateOff():this.setStateOn()},setStateOn:function(){this.active=!0,this.map.dragging.disable(),this.map.on("mousedown",this.handleMouseDown,this),this.map.on("boxzoomend",this.setStateOff,this),L.DomUtil.addClass(this.map._container,"leaflet-control-boxzoom-active")},setStateOff:function(){this.active=!1,this.map.off("mousedown",this.handleMouseDown,this),this.map.dragging.enable(),L.DomUtil.removeClass(this.map._container,"leaflet-control-boxzoom-active"),this.options.onFinished()},setShiftKeyHandler:function(){var t=this;function e(e){t.active&&(e.shiftKey?t.setStateOn():t.setStateOff())}window.addEventListener("keydown",e,!1),window.addEventListener("keypress",e,!1),window.addEventListener("keyup",e,!1)},handleMouseDown:function(t){this.map.boxZoom._onMouseDown.call(this.map.boxZoom,{clientX:t.originalEvent.clientX,clientY:t.originalEvent.clientY,which:1,shiftKey:!0})}}),L.control.boxZoom=function(t){return new L.Control.BoxZoom(t)},L.Control.Geolocation=L.Control.extend({options:{position:"topleft"},initialize:function(t){L.Util.setOptions(this,t)},onAdd:function(t){this.control=L.DomUtil.create("div","wfml-control wfml-control-zoom-location"),this.control.setAttribute("title","Zoom to my location"),this.spinner=L.DomUtil.create("div","spinner",this.control);var e=this;return L.DomEvent.on(this.control,"click",function(){e.spinner.style.visibility="visible",t.once("locationfound locationerror",function(){e.spinner.style.visibility="hidden"}),t.locate({setView:!0})}),Util.stopProp(this.control),this.control}}),L.control.geolocation=function(t){return new L.Control.Geolocation(t)},L.Control.ActionButton=L.Control.extend({options:{action:null,className:"no-op",position:"topleft",title:""},initialize:function(t){L.Util.setOptions(this,t)},onAdd:function(t){return this.map=t,this.active=!1,this.controlDiv=L.DomUtil.create("div","wfml-control"),L.DomUtil.addClass(this.controlDiv,this.options.className),this.controlDiv.setAttribute("title",this.options.title),this.controlDiv.control=this,this.options.action&&L.DomEvent.on(this.controlDiv,"click",this.options.action),Util.stopProp(this.controlDiv),this.controlDiv}}),L.control.actionButton=function(t){return new L.Control.ActionButton(t)},L.Control.MiniMap=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{position:"bottomright",toggleDisplay:!1,zoomLevelOffset:-5,zoomLevelFixed:!1,centerFixed:!1,zoomAnimation:!1,autoToggleDisplay:!1,minimized:!1,width:150,height:150,collapsedWidth:19,collapsedHeight:19,aimingRectOptions:{color:"#ff7800",weight:1,clickable:!1},shadowRectOptions:{color:"#000000",weight:1,clickable:!1,opacity:0,fillOpacity:0},strings:{hideText:"Hide MiniMap",showText:"Show MiniMap"},mapOptions:{}},initialize:function(t,e){L.Util.setOptions(this,e),this.options.aimingRectOptions.clickable=!1,this.options.shadowRectOptions.clickable=!1,this._layer=t},onAdd:function(t){this._mainMap=t,this._container=L.DomUtil.create("div","leaflet-control-minimap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation);var e={attributionControl:!1,dragging:!this.options.centerFixed,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),scrollWheelZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),doubleClickZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),boxZoom:!this._isZoomLevelFixed(),crs:t.options.crs};return e=L.Util.extend(this.options.mapOptions,e),this._miniMap=new L.Map(this._container,e),this._miniMap.addLayer(this._layer),this._mainMapMoving=!1,this._miniMapMoving=!1,this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._miniMap.whenReady(L.Util.bind(function(){this._aimingRect=L.rectangle(this._mainMap.getBounds(),this.options.aimingRectOptions).addTo(this._miniMap),this._shadowRect=L.rectangle(this._mainMap.getBounds(),this.options.shadowRectOptions).addTo(this._miniMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._miniMap.on("movestart",this._onMiniMapMoveStarted,this),this._miniMap.on("move",this._onMiniMapMoving,this),this._miniMap.on("moveend",this._onMiniMapMoved,this)},this)),this._container},addTo:function(t){L.Control.prototype.addTo.call(this,t);var e=this.options.centerFixed||this._mainMap.getCenter();return this._miniMap.setView(e,this._decideZoom(!0)),this._setDisplay(this.options.minimized),this},onRemove:function(t){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._miniMap.off("moveend",this._onMiniMapMoved,this),this._miniMap.removeLayer(this._layer)},changeLayer:function(t){this._miniMap.removeLayer(this._layer),this._layer=t,this._miniMap.addLayer(this._layer)},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this._toggleButtonInitialTitleText(),"leaflet-control-minimap-toggle-display leaflet-control-minimap-toggle-display-"+this.options.position,this._container,this._toggleDisplayButtonClicked,this):void 0,this._toggleDisplayButton.style.width=this.options.collapsedWidth+"px",this._toggleDisplayButton.style.height=this.options.collapsedHeight+"px"},_toggleButtonInitialTitleText:function(){return this.options.minimized?this.options.strings.showText:this.options.strings.hideText},_createButton:function(t,e,i,n,a,o){var r=L.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var s=L.DomEvent.stopPropagation;return L.DomEvent.on(r,"click",s).on(r,"mousedown",s).on(r,"dblclick",s).on(r,"click",L.DomEvent.preventDefault).on(r,"click",a,o),r},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?this._restore():this._minimize()},_setDisplay:function(t){t!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width=this.options.collapsedWidth+"px",this._container.style.height=this.options.collapsedHeight+"px",this._toggleDisplayButton.className+=" minimized-"+this.options.position,this._toggleDisplayButton.title=this.options.strings.showText):this._container.style.display="none",this._minimized=!0,this._onToggle()},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace("minimized-"+this.options.position,""),this._toggleDisplayButton.title=this.options.strings.hideText):this._container.style.display="block",this._minimized=!1,this._onToggle()},_onMainMapMoved:function(t){if(this._miniMapMoving)this._miniMapMoving=!1;else{var e=this.options.centerFixed||this._mainMap.getCenter();this._mainMapMoving=!0,this._miniMap.setView(e,this._decideZoom(!0)),this._setDisplay(this._decideMinimized())}this._aimingRect.setBounds(this._mainMap.getBounds())},_onMainMapMoving:function(t){this._aimingRect.setBounds(this._mainMap.getBounds())},_onMiniMapMoveStarted:function(t){if(!this.options.centerFixed){var e=this._aimingRect.getBounds(),i=this._miniMap.latLngToContainerPoint(e.getSouthWest()),n=this._miniMap.latLngToContainerPoint(e.getNorthEast());this._lastAimingRectPosition={sw:i,ne:n}}},_onMiniMapMoving:function(t){this.options.centerFixed||!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setBounds(new L.LatLngBounds(this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.sw),this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.ne))),this._shadowRect.setStyle({opacity:1,fillOpacity:.3}))},_onMiniMapMoved:function(t){this._mainMapMoving?this._mainMapMoving=!1:(this._miniMapMoving=!0,this._mainMap.setView(this._miniMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_isZoomLevelFixed:function(){var t=this.options.zoomLevelFixed;return this._isDefined(t)&&this._isInteger(t)},_decideZoom:function(t){if(this._isZoomLevelFixed())return t?this.options.zoomLevelFixed:this._mainMap.getZoom();if(t)return this._mainMap.getZoom()+this.options.zoomLevelOffset;var e,i=this._miniMap.getZoom()-this._mainMap.getZoom(),n=this._miniMap.getZoom()-this.options.zoomLevelOffset;return i>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._miniMap.getMinZoom()-this.options.zoomLevelOffset?this._miniMap.getZoom()>this._lastMiniMapZoom?(e=this._mainMap.getZoom()+1,this._miniMap.setZoom(this._miniMap.getZoom()-1)):e=this._mainMap.getZoom():e=n,this._lastMiniMapZoom=this._miniMap.getZoom(),e},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?!!this._mainMap.getBounds().contains(this._miniMap.getBounds()):this._minimized},_isInteger:function(t){return"number"==typeof t},_isDefined:function(t){return void 0!==t},_onToggle:function(){L.Util.requestAnimFrame(function(){L.DomEvent.on(this._container,"transitionend",this._fireToggleEvents,this),L.Browser.any3d||L.Util.requestAnimFrame(this._fireToggleEvents,this)},this)},_fireToggleEvents:function(){L.DomEvent.off(this._container,"transitionend",this._fireToggleEvents,this);var t={minimized:this._minimized};this.fire(this._minimized?"minimize":"restore",t),this.fire("toggle",t)}}),L.Control.CursorPosition=L.Control.extend({options:{position:"bottomleft"},initialize:function(t){L.setOptions(this,t),this.location=""},onAdd:function(t){return this.map=t,this.displayDiv=L.DomUtil.create("div","wfml-control-coordinatedisplay"),t.on("mousemove",this._update,this),t.on("zoomend",this._update,this),t.whenReady(this._update,this),Util.stopProp(this.displayDiv),this.displayDiv},onRemove:function(t){},_update:function(t){var e,i=this;e&&clearTimeout(e),e=setTimeout(function(){t.latlng&&(i.location=Location.format(Util.toLonLat(t.latlng)));var e=i.getScale();i.displayDiv.innerHTML='<div class="wfml-scale">1 : '+formatNumber$1(e)+'</div><div class="wfml-location">'+i.location+"</div>"},200)},getScale:function(){return Util.scaleForZoom(this.map.getZoom())}}),L.control.cursorPosition=function(t){return new L.Control.CursorPosition(t)};var BaseMaps={BCBase:{title:"BC Topo",maxZoom:17,url:"https://maps.gov.bc.ca/arcserver/rest/services/Province/web_mercator_cache/MapServer/tile/{z}/{y}/{x}"},BCRoad:{title:"BC Roads",maxZoom:17,url:"https://maps.gov.bc.ca/arcserver/rest/services/Province/roads_wm/MapServer/tile/{z}/{y}/{x}"},EsriTopo:{title:"ESRI Topo",maxZoom:17,url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"},EsriImagery:{title:"ESRI Imagery",maxZoom:17,url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_imagery/MapServer/tile/{z}/{y}/{x}"},EsriStreet:{title:"ESRI Streets",maxZoom:17,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"},EsriLightGray:{title:"ESRI Light Gray",maxZoom:16,url:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"},EsriHillshade:{title:"ESRI Hillshade",maxZoom:12,url:"https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}"}};function initBaseMaps(t,e,i){t._baseMaps=[];for(var n=0;n<e.baseMaps.length;n++){var a=e.baseMaps[n],o=BaseMaps[a];if(o){var r=L.tileLayer(o.url,{id:"basemap-"+n,maxNativeZoom:o.maxZoom||18,zIndex:0});t._baseMaps.push({key:a,title:o.title,layer:r})}}t.currentBase=t._baseMaps[0],t.leafMap.addLayer(t.currentBase.layer)}function initLayers(t,e,i){t.layerMgr=new LayerManager(t),t.layerMgr.init(i)}function initControls(t,e,i){t.control.spinner=L.loadSpinner().addTo(t.leafMap),L.control.actionButton({className:"wfml-control-zoom-full",title:"Zoom to Full Extent",action:function(){t.zoomFull()}}).addTo(t.leafMap),t.control.boxZoom=createBoxZoom(t),t.control.geolocation=L.control.geolocation().addTo(t.leafMap),t.control.coordinateDisplay=L.control.cursorPosition().addTo(t.leafMap),t.control.keymap=createKeymap(t.leafMap).addTo(t.leafMap),t._sidebar=new Sidebar(t),t.sidebars={},t.toolMgr.addToMain("identifyPoint",new IdentifyTool({className:"wfml-tool-identify",title:"Identify"})),t.toolMgr.addToMain("measure",new MeasureTool({className:"wfml-tool-measure",title:"Measure"})),t.toolMgr.addToMain("selectPoint",new SelectPointTool({className:"wfml-tool-selectpoint",title:"Select Point"})),t.toolMgr.addToLayer("layerlist",new LayerListTool({className:"wfml-tool-layerlist",title:"Layer List"})),t.toolMgr.addToLayer("legend",new LegendTool({className:"wfml-tool-legend",title:"Legend"})),t.toolMgr.addToLayer("time",new TimeTool({className:"wfml-tool-time",title:"Time"})),t.toolMgr.addToLayer("basemap",new BaseMapTool({className:"wfml-tool-basemap",title:"Base Maps"}))}function createBoxZoom(t){var e=L.control.boxZoom({onFinished:function(){i&&i.deactivate()}});e.addTo(t.leafMap);var i=new LeafletTool({},function(){e.setStateOff()});return i.div=e.controlDiv,t.toolMgr.addHidden("boxzoom",i),L.DomEvent.on(e.controlDiv,"click",function(){i.activate()}),e}function createKeymap(t){var e=new L.TileLayer(BaseMaps.EsriStreet.url);return new L.Control.MiniMap(e,{xzoomlevelOffset:-5,minZoom:5,maxZoom:13,toggleDisplay:!0,minimized:!0})}var API=function(t){this._map=t,this.map={extent:function(){return t.extent()},resize:function(){t.resize()},redraw:function(){t.layerMgr.redraw()},setTime:function(e){t.layerMgr.setTime(e)}},this.state={get:function(){return t.getState()},set:function(e){return t.setState(e)},persist:function(e,i){return t.persistState(e,i)}},this.basemap={all:function(){return t._baseMaps},switch:function(e){t.setBasemap(e)}},this.navigation={zoom:function(e,i){t.zoom(e,i)},pan:function(e){t.pan(e)}},this.callback={click:function(e){t.setClickHandler(e)},hover:function(e,i){t.setHoverHandler(e,i)},selectPoint:function(e){t.callback.selectpoint=e},loadStart:function(e){t.callback.loadStart=e},loadEnd:function(e){t.callback.loadEnd=e},extentChange:function(e){t.callback.extentChange=e}},this.selectPoint={get:function(){return t.selectPointBuffer},clear:function(){t.selectPoint()}},this.distance={pixels:function(e,i){var n=t.leafMap.latLngToLayerPoint(Util.toLatLng(e)),a=t.leafMap.latLngToLayerPoint(Util.toLatLng(i)),o=n.x-a.x,r=n.y-a.y;return Math.sqrt(o*o+r*r)}},this.highlight={add:function(e){e&&Util.marker(e,t.icon.highlight).addTo(t.layer.highlight)},clear:function(){t.layer.highlight.clearLayers()}},this.layer={treeView:function(){return t.layerMgr.treeView()},legend:function(e,i){if(!e)return t.layerMgr.legend();var n=t.layerMgr.find(e);return n?n.setLegendDef(i):void 0},isValidId:function(e){return!!t.layerMgr.find(e)},onChange:function(e,i){var n=t.layerMgr.find(e);n&&n.onChange(i)},filter:function(e,i){var n=t.layerMgr.find(e);n&&n.filter(i)},infoPopup:function(e,i){t.infoPopup(e,i)},redraw:function(e){return t.layerMgr.redrawLayers(e)},redrawLive:function(){t.layerMgr.redrawLiveTemporalLayers()},style:function(e,i){var n=t.layerMgr.find(e);n&&n.style(i)},visible:function(e,i){if("*"==e)t.layerMgr.visible(i);else{var n=t.layerMgr.find(e);n&&n.visible(i)}},enable:function(e,i){var n=t.layerMgr.find(e);n&&n.enable(i)},setParameter:function(e,i,n){var a=t.layerMgr.find(e);a&&a.setParameter(i,n)},getLive:function(){return t.layerMgr.getLiveTemporalLayers()},setData:function(e,i,n){var a=t.layerMgr.find(e);a&&(a.enable(!!i),a.onFeatureClick(n),a.setData(i))},zoomTo:function(e){var i=t.layerMgr.find(e);if(i){var n=i.getExtent();n&&t.zoomExtent(n,{paddingTopLeft:[50,50]})}}},this.primary={set:function(e){t.primary(e)},redraw:function(){t.layer.primary&&t.layer.primary.redraw()},filter:function(e){t.primaryFilter(e)}},this.edit={start:function(e,i){t.editStart(e,i)},stop:function(){t.editStop()}},this.search={clear:function(){t.search.clear()},setMaximumDistance:function(e){t.search.setMaximumDistance(e)},setAnchor:function(e){t.search.setAnchor(e)},zoomToAnchor:function(){t.search.zoom()},panToAnchor:function(){t.search.pan()},showCandidate:function(e){t.search.showCandidate(e)},setResultHandler:function(e){t.search.setResultHandler(e)},findPlace:function(e){t.search.findPlace(e)},findRoad:function(e){t.search.findRoad(e)},findIntersection:function(e,i){t.search.findIntersection(e,i)}},this.tool={activate:function(e){t.toolMgr.setActiveTool(e)}}},WFML={createMap:function(t,e,i,n){return new API(buildMap(new Map(t),e,i,n))}};WFML.Location=Location,WFML.Search=Search,WFML.Util=Util;export default WFML;
//# sourceMappingURL=wfml.js.map
