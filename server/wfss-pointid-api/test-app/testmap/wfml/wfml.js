// WFML  Ver. 0.3.0

function formatNumber(value,decimalPlaces){var i=Math.floor(value),f=value-i;return i.toLocaleString()+(decimalPlaces&&decimalPlaces>0?f.toFixed(decimalPlaces).substr(1):"")}L.NonTiledLayer=(L.Layer||L.Class).extend({includes:L.Evented||L.Mixin.Events,emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",options:{attribution:"",opacity:1,zIndex:void 0,minZoom:0,maxZoom:18,pointerEvents:null,errorImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",bounds:L.latLngBounds([-85.05,-180],[85.05,180]),useCanvas:void 0},key:"",initialize:function(options){L.setOptions(this,options)},onAdd:function(map){this._map=map,void 0===this._zoomAnimated&&(this._zoomAnimated=L.DomUtil.TRANSITION&&L.Browser.any3d&&!L.Browser.mobileOpera&&this._map.options.zoomAnimation),L.version<"1.0"&&this._map.on(this.getEvents(),this),this._div||(this._div=L.DomUtil.create("div","leaflet-image-layer"),this.options.pointerEvents&&(this._div.style["pointer-events"]=this.options.pointerEvents),void 0!==this.options.zIndex&&(this._div.style.zIndex=this.options.zIndex),void 0!==this.options.opacity&&(this._div.style.opacity=this.options.opacity)),this.getPane().appendChild(this._div);var canvasSupported=!!window.HTMLCanvasElement;void 0===this.options.useCanvas?this._useCanvas=canvasSupported:this._useCanvas=this.options.useCanvas,this._useCanvas?(this._bufferCanvas=this._initCanvas(),this._currentCanvas=this._initCanvas()):(this._bufferImage=this._initImage(),this._currentImage=this._initImage()),this._update()},getPane:function(){return L.Layer?L.Layer.prototype.getPane.call(this):(this.options.pane?this._pane=this.options.pane:this._pane=this._map.getPanes().overlayPane,this._pane)},onRemove:function(map){L.version<"1.0"&&this._map.off(this.getEvents(),this),this.getPane().removeChild(this._div),this._useCanvas?(this._div.removeChild(this._bufferCanvas),this._div.removeChild(this._currentCanvas)):(this._div.removeChild(this._bufferImage),this._div.removeChild(this._currentImage))},addTo:function(map){return map.addLayer(this),this},_setZoom:function(){this._useCanvas?(this._currentCanvas._bounds&&this._resetImageScale(this._currentCanvas,!0),this._bufferCanvas._bounds&&this._resetImageScale(this._bufferCanvas)):(this._currentImage._bounds&&this._resetImageScale(this._currentImage,!0),this._bufferImage._bounds&&this._resetImageScale(this._bufferImage))},getEvents:function(){var events={moveend:this._update};return this._zoomAnimated&&(events.zoomanim=this._animateZoom),L.version>="1.0"&&(events.zoom=this._setZoom),events},getElement:function(){return this._div},setOpacity:function(opacity){return this.options.opacity=opacity,this._div&&L.DomUtil.setOpacity(this._div,this.options.opacity),this},setZIndex:function(zIndex){return zIndex&&(this.options.zIndex=zIndex,this._div&&(this._div.style.zIndex=zIndex)),this},bringToFront:function(){return this._div&&this.getPane().appendChild(this._div),this},bringToBack:function(){return this._div&&this.getPane().insertBefore(this._div,this.getPane().firstChild),this},getAttribution:function(){return this.options.attribution},_initCanvas:function(){var _canvas=L.DomUtil.create("canvas","leaflet-image-layer");return this._div.appendChild(_canvas),_canvas._image=new Image,this._ctx=_canvas.getContext("2d"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(_canvas,"leaflet-zoom-animated"):L.DomUtil.addClass(_canvas,"leaflet-zoom-hide"),L.extend(_canvas._image,{onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)}),_canvas},_initImage:function(){var _image=L.DomUtil.create("img","leaflet-image-layer");return this._div.appendChild(_image),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(_image,"leaflet-zoom-animated"):L.DomUtil.addClass(_image,"leaflet-zoom-hide"),L.extend(_image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)}),_image},redraw:function(){return this._map&&this._update(),this},_animateZoom:function(e){this._useCanvas?(this._currentCanvas._bounds&&this._animateImage(this._currentCanvas,e),this._bufferCanvas._bounds&&this._animateImage(this._bufferCanvas,e)):(this._currentImage._bounds&&this._animateImage(this._currentImage,e),this._bufferImage._bounds&&this._animateImage(this._bufferImage,e))},_animateImage:function(image,e){if(void 0===L.DomUtil.setTransform){var map=this._map,scale=image._scale*map.getZoomScale(e.zoom),nw=image._bounds.getNorthWest(),se=image._bounds.getSouthEast(),topLeft=map._latLngToNewLayerPoint(nw,e.zoom,e.center),size=map._latLngToNewLayerPoint(se,e.zoom,e.center)._subtract(topLeft),origin=topLeft._add(size._multiplyBy(.5*(1-1/scale)));image.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(origin)+" scale("+scale+") "}else{var map=this._map,scale=image._scale*image._sscale*map.getZoomScale(e.zoom),nw=image._bounds.getNorthWest(),se=image._bounds.getSouthEast(),topLeft=map._latLngToNewLayerPoint(nw,e.zoom,e.center);L.DomUtil.setTransform(image,topLeft,scale)}image._lastScale=scale},_resetImageScale:function(image,resetTransform){var bounds=new L.Bounds(this._map.latLngToLayerPoint(image._bounds.getNorthWest()),this._map.latLngToLayerPoint(image._bounds.getSouthEast())),orgSize=image._orgBounds.getSize().y,scaledSize=bounds.getSize().y,scale=scaledSize/orgSize;image._sscale=scale,L.DomUtil.setTransform(image,bounds.min,scale)},_resetImage:function(image){var bounds=new L.Bounds(this._map.latLngToLayerPoint(image._bounds.getNorthWest()),this._map.latLngToLayerPoint(image._bounds.getSouthEast())),size=bounds.getSize();L.DomUtil.setPosition(image,bounds.min),image._orgBounds=bounds,image._sscale=1,this._useCanvas?(image.width=size.x,image.height=size.y):(image.style.width=size.x+"px",image.style.height=size.y+"px")},_getClippedBounds:function(){var wgsBounds=this._map.getBounds(),mSouth=wgsBounds.getSouth(),mNorth=wgsBounds.getNorth(),mWest=wgsBounds.getWest(),mEast=wgsBounds.getEast(),lSouth=this.options.bounds.getSouth(),lNorth=this.options.bounds.getNorth(),lWest=this.options.bounds.getWest(),lEast=this.options.bounds.getEast();mSouth<lSouth&&(mSouth=lSouth),mNorth>lNorth&&(mNorth=lNorth),mWest<lWest&&(mWest=lWest),mEast>lEast&&(mEast=lEast);var world1=new L.LatLng(mNorth,mWest),world2=new L.LatLng(mSouth,mEast);return new L.LatLngBounds(world1,world2)},_update:function(){var i,bounds=this._getClippedBounds(),pix1=this._map.latLngToContainerPoint(bounds.getNorthWest()),pix2=this._map.latLngToContainerPoint(bounds.getSouthEast()),width=pix2.x-pix1.x,height=pix2.y-pix1.y;if(this._useCanvas?(this._bufferCanvas._scale=this._bufferCanvas._lastScale,this._currentCanvas._scale=this._currentCanvas._lastScale=1,this._bufferCanvas._sscale=1,this._currentCanvas._bounds=bounds,this._resetImage(this._currentCanvas),i=this._currentCanvas._image,L.DomUtil.setOpacity(i,0)):(this._bufferImage._scale=this._bufferImage._lastScale,this._currentImage._scale=this._currentImage._lastScale=1,this._bufferImage._sscale=1,this._currentImage._bounds=bounds,this._resetImage(this._currentImage),i=this._currentImage,L.DomUtil.setOpacity(i,0)),this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom||width<32||height<32)return this._div.style.visibility="hidden",i.src=this.emptyImageUrl,this.key=i.key="<empty>",void(i.tag=null);this.fire("loading"),this.key=bounds.getNorthWest()+", "+bounds.getSouthEast()+", "+width+", "+height,this.getImageUrl?(i.src=this.getImageUrl(bounds,width,height),i.key=this.key):this.getImageUrlAsync(bounds,width,height,this.key,function(key,url,tag){i.key=key,i.src=url,i.tag=tag})},_onImageError:function(e){this.fire("error",e),L.DomUtil.addClass(e.target,"invalid"),e.target.src!==this.options.errorImageUrl&&(e.target.src=this.options.errorImageUrl)},_onImageLoad:function(e){(e.target.src===this.options.errorImageUrl||(L.DomUtil.removeClass(e.target,"invalid"),e.target.key&&e.target.key===this.key))&&(this._onImageDone(e),this.fire("load",e))},_onImageDone:function(e){if(this._useCanvas)this._renderCanvas(e);else{L.DomUtil.setOpacity(this._currentImage,1),L.DomUtil.setOpacity(this._bufferImage,0),this._addInteraction&&this._currentImage.tag&&this._addInteraction(this._currentImage.tag);var tmp=this._bufferImage;this._bufferImage=this._currentImage,this._currentImage=tmp}"<empty>"!==e.target.key&&(this._div.style.visibility="visible")},_renderCanvas:function(e){this._currentCanvas.getContext("2d").drawImage(this._currentCanvas._image,0,0),L.DomUtil.setOpacity(this._currentCanvas,1),L.DomUtil.setOpacity(this._bufferCanvas,0),this._addInteraction&&this._currentCanvas._image.tag&&this._addInteraction(this._currentCanvas._image.tag);var tmp=this._bufferCanvas;this._bufferCanvas=this._currentCanvas,this._currentCanvas=tmp}}),L.nonTiledLayer=function(){return new L.NonTiledLayer},L.NonTiledLayer.WMS=L.NonTiledLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},options:{crs:null,uppercase:!1},initialize:function(url,options){this._wmsUrl=url;var wmsParams=L.extend({},this.defaultWmsParams);for(var i in options)L.NonTiledLayer.prototype.options.hasOwnProperty(i)||L.Layer&&L.Layer.prototype.options.hasOwnProperty(i)||(wmsParams[i]=options[i]);this.wmsParams=wmsParams,L.setOptions(this,options)},onAdd:function(map){this._crs=this.options.crs||map.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version);var projectionKey=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[projectionKey]=this._crs.code,L.NonTiledLayer.prototype.onAdd.call(this,map)},getImageUrl:function(bounds,width,height){var wmsParams=this.wmsParams;wmsParams.width=width,wmsParams.height=height;var nw=this._crs.project(bounds.getNorthWest()),se=this._crs.project(bounds.getSouthEast()),url=this._wmsUrl,bbox=bbox=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[se.y,nw.x,nw.y,se.x]:[nw.x,se.y,se.x,nw.y]).join(",");return url+L.Util.getParamString(this.wmsParams,url,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+bbox},getBbox:function(){var bounds=this._getClippedBounds(),nw=this._crs.project(bounds.getNorthWest()),se=this._crs.project(bounds.getSouthEast()),bbox=bbox=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[se.y,nw.x,nw.y,se.x]:[nw.x,se.y,se.x,nw.y]).join(",");return bbox},setParams:function(params,noRedraw){return L.extend(this.wmsParams,params),noRedraw||this.redraw(),this}}),L.nonTiledLayer.wms=function(url,options){return new L.NonTiledLayer.WMS(url,options)},function(){function createBoxZoom(map){var boxZoom=L.control.boxZoom({onFinished:function(){boxZoomTool&&boxZoomTool.deactivate()}});boxZoom.addTo(map.leafMap);var boxZoomTool=new WFML.LeafletTool({},function(){boxZoom.setStateOff()});return boxZoomTool.div=boxZoom.controlDiv,map.toolMgr.addHidden("boxzoom",boxZoomTool),L.DomEvent.on(boxZoom.controlDiv,"click",function(){boxZoomTool.activate()}),boxZoom}function createKeymap(map){var keyBase=WFML.BaseMaps.BCRoad,keyLyr=new L.TileLayer(keyBase.url);return new L.Control.MiniMap(keyLyr,{xzoomlevelOffset:-5,minZoom:5,maxZoom:13,toggleDisplay:!0,minimized:!0})}function renderLegend(map,sidebarInstance){L.DomUtil.empty(sidebarInstance.content);var legendDOM=L.DomUtil.create("div","wfml-legend",sidebarInstance.content),legend=map.layerMgr.legend();if(map.legendContent)for(var ii=0;ii<map.legendContent.length;ii++)addLegendLayer(map.legendContent[ii],legendDOM);for(var i=0;i<legend.length;i++)addLegendLayer(legend[i],legendDOM)}function addLegendLayer(item,legendDiv){if(item.entries){L.DomUtil.create("div","wfml-legend-title",legendDiv).innerHTML=item.title;for(var i=0;i<item.entries.length;i++){var ent=item.entries[i],div=L.DomUtil.create("div","wfml-legend-entry",legendDiv),img=L.DomUtil.create("img","wfml-legend-image",div);img.src=ent.url,ent.width&&(img.style.width=ent.width),ent.height&&(img.style.height=ent.height);var lbl=ent.label;if(lbl){L.DomUtil.create("span","wfml-legend-label",div).innerHTML=lbl}}}}function renderBasemap(map,sidebarInstance){for(var content=L.DomUtil.create("div","wfml-basemaps",sidebarInstance.content),basemaps=map._baseMaps,i=0;i<basemaps.length;i++){addBasemap(map,i,basemaps[i],content)}}function addBasemap(map,i,bm,contentDiv){var div=L.DomUtil.create("div","wfml-basemap-entry",contentDiv);L.DomUtil.create("div","wfml-basemap-thumbnail",div).style.backgroundImage="url('"+basemapThumb(bm)+"')",L.DomUtil.create("div","wfml-basemap-title",div).innerHTML=bm.title,L.DomEvent.on(div,"click",function(){map.setBasemap(i),sideBarShow(map)})}function basemapThumb(bm){var url=bm.layer._url;return url.substring(0,url.length-11)+"13/2825/1284"}function PointEditor(map,lonlat,callback){var self=this;this.map=map,this.callback=callback,this.startLoc=lonlat,this.isStartShown=!1,this.map.layer.markers.clearLayers(),this.currMarker=null,lonlat&&(this.currMarker=WFML.Util.marker(lonlat,map.icon.edit),this.currMarker.addTo(map.layer.markers)),this.clickFn=function(ev){self.update([ev.latlng.lng,ev.latlng.lat])},map.leafMap.on("click",this.clickFn),this.map.cursor("crosshair")}function map(arr,f){for(var result=[],i=0;i<arr.length;i++){var v=f(arr[i],i);null!=v&&result.push(v)}return result}function find(arr,f){for(var i=0;i<arr.length;i++){var v=f(arr[i],i);if(v)return v}return null}WFML={};WFML.Map=function(mapId,mapConfig,overlayConfig){var self=this;this.mapId=mapId,this.mapConf=mapConfig,this.overlayConf=overlayConfig,this.view={},this.view.center=mapConfig.center?mapConfig.center:[-123,55],this.view.level=mapConfig.zoom?mapConfig.zoom:5,this.leafMap=L.map(mapId,mapConfig.leafOpt),this.zoomFull(),this.icon={highlight:L.icon({iconUrl:WFML.Util.absURL(WFML.Img.highlightPoint),iconAnchor:[16,16]}),edit:L.icon({iconUrl:WFML.Util.absURL(WFML.Img.editPoint),iconAnchor:[16,16]}),editOrig:L.icon({iconUrl:WFML.Util.absURL(WFML.Img.editPointShaded),iconAnchor:[16,16]}),selectPoint:L.icon({iconUrl:WFML.Util.absURL(WFML.Img.selectPoint),iconAnchor:[15,27]})},this.layer={},this.layer.markers=L.layerGroup().addTo(this.leafMap),this.layer.highlight=L.layerGroup().addTo(this.leafMap),this.callback={click:null,loadStart:null,loadEnd:null,selectpoint:null},this.selectPointBuffer=null,this.toolMgr=new WFML.ToolManager(this),this.control={},this.search=new WFML.Search(this),this.clickHandler=null,this.leafMap.on("click",function(ev){self.onClick([ev.latlng.lng,ev.latlng.lat])}),this.hoverHandler=null,this.hoverTimer=null,this.leafMap.on("mousemove",function(ev){self.onHover([ev.latlng.lng,ev.latlng.lat])}),this.leafMap.on("mouseout",function(){self.hoverTimer&&self.hoverTimer.cancel()}),this.leafMap.on("zoomend",function(){self.callback.extentChange&&self.callback.extentChange()}),new WFML.MapBuilder(this).build(mapConfig,overlayConfig),this.markerMgr=new WFML.MarkerManager(this);var map=this;this.leafMap.on("keypress",function(evt){var keyevt=evt.originalEvent;keyevt.ctrlKey&&keyevt.shiftKey&&1==keyevt.keyCode&&(console.log("WFML "+WFML.Map.VERSION),map.layerMgr._DEBUG=!map.layerMgr._DEBUG,console.log("Debug "+(map.layerMgr._DEBUG?"ON":"off")))})},WFML.Map.VERSION="0.3.0";var WEBMERC_RESOLUTION=[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135,.29858214169740677,.14929107084870338,.07464553542435169,.037322767712175846,.018661383856087923,.009330691928043961,.004665345964021981];WFML.Map.prototype.scale=function(){var level=this.leafMap.getZoom();return 39.37*WEBMERC_RESOLUTION[level]*90},WFML.Map.prototype.zoomForScale=function(scale,roundDown){for(var scaleRes=scale/39.37/90,level=0,i=0;i<WEBMERC_RESOLUTION.length;i++)if(WEBMERC_RESOLUTION[i]<scaleRes){level=i;break}return!roundDown&&level>0&&level--,level},WFML.Map.prototype.setBasemap=function(i){this.currentBase&&this.leafMap.removeLayer(this.currentBase.layer),this.currentBase=this._baseMaps[i],this.leafMap.addLayer(this.currentBase.layer)},WFML.Map.prototype.setClickHandler=function(callback){this.clickHandler=callback},WFML.Map.prototype.onClick=function(point){this.clickHandler&&(this.toolMgr.getActiveTool()||this.clickHandler.call(null,point))},WFML.Map.prototype.setHoverHandler=function(callback,delay){this.hoverHandler=callback,this.hoverTimer=new WFML.Util.Timer(delay||300)},WFML.Map.prototype.onHover=function(point){var self=this;this.hoverHandler&&(this.toolMgr.getActiveTool()||this.hoverTimer.start(function(){self.toolMgr.getActiveTool()||self.hoverHandler.call(null,point)}))},WFML.Map.prototype.extent=function(){var bnds=this.leafMap.getBounds();return[bnds.getWest(),bnds.getSouth(),bnds.getEast(),bnds.getNorth()]},WFML.Map.prototype.resize=function(){this.leafMap.invalidateSize()},WFML.Map.prototype.zoomFull=function(){return this.zoom(this.view.center,this.view.level),this.leafMap.getZoom()},WFML.Map.prototype.zoomLevel=function(level){this.leafMap.setZoom(level)},WFML.Map.prototype.zoomIn=function(levelDelta){return this.leafMap.zoomIn(levelDelta),this.leafMap.getZoom()},WFML.Map.prototype.zoom=function(lonlat,level){return lonlat?(level=level||12,lonlat.length<=2?this.leafMap.setView(WFML.Util.toLatLng(lonlat),level):this.leafMap.fitBounds([[lonlat[1],lonlat[0]],[lonlat[3],lonlat[2]]]),this.leafMap.getZoom()):this.leafMap.getZoom()},WFML.Map.prototype.pan=function(lonlat){lonlat&&this.leafMap.panTo(WFML.Util.toLatLng(lonlat))},WFML.Map.prototype.cursor=function(name){var curName=name||"";document.getElementById(this.mapId).style.cursor=curName},WFML.Map.prototype.selectPoint=function(pt){if(!pt)return this.indicator("selectPoint"),void(this.selectPointBuffer=null);this.selectPointBuffer=pt,this.indicator("selectPoint",pt,"selectPoint"),this.callback.selectpoint&&this.callback.selectpoint(pt)},WFML.Map.prototype.primary=function(layerKey){if(this.layer.primary&&this.leafMap.removeLayer(this.layer.primary),this.layer.primary=null,layerKey){var lyr=this.layerMgr.find(layerKey);lyr&&(this.layer.primary=L.tileLayer.wms(lyr.overlay.url,{layers:lyr.layers,format:lyr.overlay.format,zIndex:1e3,transparent:!0}),this.layer.primary.addTo(this.leafMap))}},WFML.Map.prototype.primaryFilter=function(filter){if(this.layer.primary){var cqlFilter=WFML.Layer.Util.toCQL(filter);delete this.layer.primary.wmsParams.cql_filter,cqlFilter.length>0&&(this.layer.primary.wmsParams.cql_filter=cqlFilter),this.layer.primary.redraw()}},WFML.Map.prototype.editStart=function(lonlat,callback){this.editor=new PointEditor(this,lonlat,callback)},WFML.Map.prototype.editStop=function(){this.editor&&this.editor.stop(),this.editor=null},WFML.Map.prototype.infoPopup=function(id,featureFilter){if(this.callback.infoPopup&&this.leafMap.off("click",this.callback.infoPopup),id){var self=this;this.callback.infoPopup=function(ev){function handleInfoPopup(features){if(features){featureFilter&&(features=featureFilter(id,features));var content=lyr.infoPopupHTML(features);self.leafMap.openPopup(content,ev.latlng)}}var lyr=self.layerMgr.find(id);lyr&&lyr.visible()&&lyr.identify(ev.containerPoint).then(handleInfoPopup)},this.leafMap.on("click",this.callback.infoPopup)}},WFML.Map.prototype.sidebarShow=function(show,contentClass,width){return this._sidebar.show(show,contentClass,width)},WFML.Map.prototype.createElement=function(domType,clz){return L.DomUtil.create(domType,clz,L.DomUtil.get(this.mapId))},WFML.Map.prototype.indicator=function(lyrId,pt,symbol,opts){if(this.layer[lyrId]||(this.layer[lyrId]=L.layerGroup().addTo(this.leafMap)),this.layer[lyrId].clearLayers(),pt){this._graphic(symbol,pt,opts).addTo(this.layer[lyrId])}},WFML.Map.prototype._graphic=function(symbol,pt,opts){return WFML.GRAPHIC[symbol]?(opts=opts||{},opts.map=this,WFML.GRAPHIC[symbol](pt,opts)):null},WFML.GRAPHIC={arrow:function(pt,opt){if(opt.target){var locStart=[pt[1],pt[0]],locEnd=[opt.target[1],opt.target[0]];return L.arrow(locStart,locEnd,{title:opt.label})}},crosshairs:function(pt,opt){return L.crosshairs([pt[1],pt[0]],opt)},selectPoint:function(pt,opt){return WFML.Util.marker(pt,opt.map.icon.selectPoint)}},WFML.Map.prototype.legendAdd=function(legendContent){this.legendContent=legendContent},WFML.Map.prototype.sidebar=function(){return this._sidebar},WFML.Sidebar=function(map){this.map=map,this.sidebarInstances=[]},WFML.Sidebar.prototype.render=function(title){L.DomUtil.empty(this._content),L.DomUtil.empty(this._toolbar),L.DomUtil.get("wfml-sidebar-title").textContent=title},WFML.Sidebar.prototype.content=function(){return this._content},WFML.Sidebar.prototype.toolbar=function(){return this._toolbar},WFML.Sidebar.prototype.create=function(id,title,width){var self=this,sidebar=L.DomUtil.create("div","wfml-sidebar wfml-sidebar-hidden",L.DomUtil.get(this.map.mapId)),w=width||200;sidebar.style.width=w+"px";var headerContainer=L.DomUtil.create("div","wfml-sidebar-header",sidebar),toolbarDiv=L.DomUtil.create("div","wfml-sidebar-toolbar",headerContainer);L.DomUtil.create("div","wfml-sidebar-title",headerContainer).textContent=title;var sidebar_btns=L.DomUtil.create("div","wfml-sidebar-buttons",headerContainer),sidebar_close=L.DomUtil.create("div","wfml-sidebar-close",sidebar_btns),content=L.DomUtil.create("div","wfml-sidebar-content",sidebar);WFML.Lutil.stopProp(sidebar);var sidebarInstance={id:id,div:sidebar,toolbar:toolbarDiv,content:content};return sidebar_close.addEventListener("click",function(){self.show(sidebarInstance,!1)}),this.sidebarInstances.push(sidebarInstance),sidebarInstance};WFML.Sidebar.prototype.hideAll=function(){this.sidebarInstances.forEach(function(s){L.DomUtil.addClass(s.div,"wfml-sidebar-hidden")})},WFML.Sidebar.prototype.show=function(instance,show){return L.DomUtil.hasClass(instance.div,"wfml-sidebar-hidden")||(show=!1),show?(this.hideAll(),L.DomUtil.removeClass(instance.div,"wfml-sidebar-hidden")):L.DomUtil.addClass(instance.div,"wfml-sidebar-hidden"),show},WFML.MapBuilder=function(wfmlMap){this.wfmlMap=wfmlMap,this.leafMap=wfmlMap.leafMap},WFML.MapBuilder.prototype.build=function(mapConfig,overlayConfig){this.mapConf=mapConfig,this.overlayConf=overlayConfig,this.initBaseMaps(),this.initLayers(),this.initControls()},WFML.MapBuilder.prototype.initBaseMaps=function(){this.wfmlMap._baseMaps=[];for(var i=0;i<this.wfmlMap.mapConf.baseMaps.length;i++){var key=this.wfmlMap.mapConf.baseMaps[i],def=WFML.BaseMaps[key];if(def){var lyr=L.tileLayer(def.url,{id:"basemap-"+i,maxZoom:18,zIndex:0});this.wfmlMap._baseMaps.push({key:key,title:def.title,layer:lyr})}}this.wfmlMap.currentBase=this.wfmlMap._baseMaps[0],this.wfmlMap.leafMap.addLayer(this.wfmlMap.currentBase.layer)},WFML.MapBuilder.prototype.initLayers=function(){this.wfmlMap.layerMgr=new WFML.LayerManager(this.wfmlMap),this.wfmlMap.layerMgr.init(this.overlayConf)},WFML.MapBuilder.prototype.initControls=function(){var map=this.wfmlMap;map.control.spinner=L.loadSpinner().addTo(this.leafMap),L.control.actionButton({className:"wfml-control-zoom-full",title:"Zoom to Full Extent",action:function(){map.zoomFull()}}).addTo(this.leafMap),map.control.boxZoom=createBoxZoom(map),map.control.geolocation=L.control.geolocation().addTo(this.leafMap),map.control.coordinateDisplay=L.control.cursorPosition().addTo(this.leafMap),map.control.keymap=createKeymap(this.leafMap).addTo(this.leafMap),map.toolMgr.addToMain("measure",new WFML.MeasureTool({className:"wfml-tool-measure",title:"Measure"})),map.toolMgr.addToMain("selectPoint",new WFML.SelectPointTool({className:"wfml-tool-selectpoint",title:"Select Point"})),map._sidebar=new WFML.Sidebar(this.wfmlMap),map.sidebars={},map.toolMgr.addToLayer("layerlist",new WFML.LayerListTool({className:"wfml-tool-layerlist",title:"Layer List"})),map.toolMgr.addToLayer("legend",new WFML.ActionTool({className:"wfml-tool-legend",title:"Legend"},function(){map.sidebars.legend||(map.sidebars.legend=map.sidebar().create("wfml-legend","Legend")),renderLegend(map,map.sidebars.legend),map.sidebar().show(map.sidebars.legend,!0)})),map.toolMgr.addToLayer("basemap",new WFML.ActionTool({className:"wfml-tool-basemap",title:"Base Maps"},function(){map.sidebars.basemap||(map.sidebars.basemap=map.sidebar().create("wfml-basemaps","Base Maps"),renderBasemap(map,map.sidebars.basemap)),map.sidebar().show(map.sidebars.basemap,!0)}))},PointEditor.prototype.update=function(lonlat){!this.isStartShown&&this.startLoc&&(WFML.Util.marker(this.startLoc,this.map.icon.editOrig).addTo(this.map.layer.markers),this.isStartShown=!0),this.currMarker&&this.map.layer.markers.removeLayer(this.currMarker),this.currMarker=WFML.Util.marker(lonlat,this.map.icon.edit),this.currMarker.addTo(this.map.layer.markers),this.callback(lonlat)},PointEditor.prototype.stop=function(){this.map.layer.markers.clearLayers(),this.map.leafMap.off("click",this.clickFn),this.map.cursor()},WFML.Lutil={},WFML.Lutil.stopProp=function(div){L.DomEvent.disableClickPropagation(div),L.DomEvent.on(div,"mousewheel",L.DomEvent.stopPropagation),L.DomEvent.on(div,"click",L.DomEvent.stopPropagation)},WFML.Lutil.scale=function(map){var level=map.getZoom();return 39.37*WEBMERC_RESOLUTION[level]*90},WFML.DomUtil={},WFML.DomUtil.hasElementWithClassName=function(elt,clz){return elt.getElementsByClassName(clz).length>0},WFML.Util={},WFML.Util.absURL=function(relPath){return WFML.BASE_URL+"/"+relPath},WFML.Util.marker=function(lonlat,icon){return L.marker(WFML.Util.toLatLng(lonlat),{icon:icon})},WFML.Util.toLatLng=function(lonlat){return lonlat?[lonlat[1],lonlat[0]]:lonlat},WFML.Util.toLonLat=function(latLng){return latLng?[latLng.lng,latLng.lat]:null};var DIRECTION_IND=["N","NE","E","SE","S","SW","W","NW","N"];WFML.Util.direction=function(lnglat1,lnglat2){var bearing=WFML.Util.bearing(lnglat1,lnglat2),index=Math.floor((bearing+22.5)/45);return DIRECTION_IND[index]},WFML.Util.bearing=function(lnglat1,lnglat2){var lon1=WFML.Util.toRadians(lnglat1[0]),lat1=WFML.Util.toRadians(lnglat1[1]),lon2=WFML.Util.toRadians(lnglat2[0]),lat2=WFML.Util.toRadians(lnglat2[1]),y=Math.sin(lon2-lon1)*Math.cos(lat2),x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1),bearing=WFML.Util.toDegrees(Math.atan2(y,x));return bearing<0&&(bearing=360-Math.abs(bearing)),bearing},WFML.Util.toRadians=function(deg){return deg*(Math.PI/180)},WFML.Util.toDegrees=function(rad){return rad*(180/Math.PI)},WFML.Util.getParamString=function(obj,existingUrl,uppercase){var params=[];for(var i in obj)params.push(encodeURIComponent(uppercase?i.toUpperCase():i)+"="+encodeURIComponent(obj[i]));var url="";return existingUrl&&(url=existingUrl+(-1===existingUrl.indexOf("?")?"?":"&")),url+params.join("&")},WFML.Util.map=function(arr,f){return map(arr,f)},WFML.Util.find=function(arr,f){return find(arr,f)},WFML.Util.Timer=function(delay){this.timeout=null,this.delay=delay},WFML.Util.Timer.prototype.start=function(callback){this.cancel(),this.timeout=setTimeout(callback,this.delay)},WFML.Util.Timer.prototype.cancel=function(){this.timeout&&clearTimeout(this.timeout),this.timeout=null}}(),function(){function formatDM(lonlat){function int(value){return value<0?Math.ceil(value):Math.floor(value)}function fraction(value){var absValue=Math.abs(value);return absValue-Math.floor(absValue)}function toDM(value){var degrees=int(value),frac=fraction(value),minutes=60*frac;return degrees.toString()+" "+minutes.toFixed(PRECISION_SECONDS)+"'"}return lonlat?toDM(lonlat[1])+", "+toDM(lonlat[0]):""}function parseLocation(s){var lonlat=parseGeo(s);return lonlat||parseUTM(s)}function parseUTM(s){var utm=getUTMCoordinate(s);return utm?convertUTM(utm):null}function getUTMCoordinate(s){var match=REGEXP_UTM.exec(s);if(match){return[parseInt(match[1]),parseInt(match[2]),parseInt(match[5])]}return null}function convertUTM(num){var easting=num[0],northing=num[1];if(easting>MAX_EASTING&&northing<MAX_EASTING)var easting=num[1],northing=num[0];return transformUTMtoGeo([easting,northing,num[2]])}function transformUTMtoGeo(pt){var utmZone=pt[2];Proj4js.defs.UTM="+proj=utm +zone="+utmZone;var source=new Proj4js.Proj("UTM"),dest=new Proj4js.Proj(EPSG_GEOGRAPHIC),p=new Proj4js.Point(pt[0],pt[1]);return Proj4js.transform(source,dest,p),[p.x,p.y]}function parseGeo(s){var normalizedComma=new String(s).replace(/\s*,\s*/g," ,"),noHemisphere=normalizedComma.replace(/[news]/gi," ").trim(),addSpace=noHemisphere.replace(/([°'"’”])/g,"$1 ").trim(),split=addSpace.split(/\s+/);try{var comps=split.map(function(c,i){var m=c.match(/^([,]?)([-]?\d+[.]?\d*)([°'"’”]?)$/);if(!m)throw new Error("component not valid: "+c);var scale=SCALE[m[3]];if(0==i||m[1]){if(scale&&"deg"!=scale)throw new Error("component scale should be degrees: "+c);scale="deg"}var val=parseFloat(m[2]);if(scale&&"deg"!=scale&&val<0)throw new Error("component should not be negative: "+c);return{val:val,scale:scale}})}catch(e){return}if(!(comps.length<2||comps.length>6))switch(comps.length){case 2:return checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,1),comps.slice(1,2)));case 3:return checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,2),comps.slice(2,3)))||checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,1),comps.slice(1,3)));case 4:return checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,2),comps.slice(2,4)))||checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,3),comps.slice(3,4)))||checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,1),comps.slice(1,4)));case 5:return checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,3),comps.slice(3,5)))||checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,2),comps.slice(2,5)));case 6:return checkRangeFixOrderSign(resolveDMSpair(comps.slice(0,3),comps.slice(3,6)))}}function checkRangeFixOrderSign(p){if(p){var x=p[0],y=p[1];return checkRangeFixOrder(x,y)||checkRangeFixOrder(-x,y)||checkRangeFixOrder(x,-y)||checkRangeFixOrder(-x,-y)}}function checkRangeFixOrder(x,y){return checkRange(y,x)||checkRange(x,y)}function checkRange(long,lat){if(!(lat>LAT_MAX||lat<LAT_MIN||long>LONG_MAX||long<LONG_MIN))return[long,lat]}function resolveDMSpair(compsA,compsB){var dmsA=resolveDMS.apply(null,compsA);if(!1===dmsA)return!1;var dmsB=resolveDMS.apply(null,compsB);return!1!==dmsB&&[dmsA,dmsB]}function resolveDMS(deg,min,sec){if(null==deg)return!1;if(deg.scale&&"deg"!=deg.scale)return!1;if(null!=min&&min.scale&&"deg"==min.scale)return!1;if(null!=sec&&sec.scale&&("deg"==sec.scale||"min"==sec.scale||"sec"==min.scale))return!1;var val=deg.val;return null==min?val:!(min.val<0)&&(val+=sameSign(min.val,deg.val)/SCALE_FACTOR[min.scale||"min"],null==sec?val:!(sec.val<0)&&(val+=sameSign(sec.val,deg.val)/SCALE_FACTOR.sec))}function sameSign(val,proto){return proto>=0?Math.abs(val):-Math.abs(val)}WFML.Location={format:function(lonlat){return formatDM(lonlat)},parse:function(s){return parseLocation(s)}};var PRECISION_SECONDS=3,RE_ATOM={start:"^\\s*",separator:"[ \\t,\\|]+",zone:"([zZ]([oO][nN][eE])?[ ])?",end:"\\s*$",numDec:"(\\d+(?:\\.\\d+)?)",numZone:"(\\d+)"},REGEXP_UTM=new RegExp(RE_ATOM.start+RE_ATOM.numDec+RE_ATOM.separator+RE_ATOM.numDec+RE_ATOM.separator+RE_ATOM.zone+RE_ATOM.numZone+RE_ATOM.end),MAX_EASTING=1e6,EPSG_GEOGRAPHIC="EPSG:4326",SCALE={"°":"deg","'":"min",'"':"sec","’":"min","”":"sec"},SCALE_FACTOR={deg:1,min:60,sec:3600},LONG_MIN=-200,LONG_MAX=-100,LAT_MIN=0,LAT_MAX=90;WFML.Location.test=function(){WFML.Location.testParse(),WFML.Location.testParseLocation()},WFML.Location.testParseLocation=function(){function test(s,expected,title){var actual=parseLocation(s),errorCause="Unable to Parse";if(actual){var loc=actual;if(loc[0]===expected[0]&&loc[1]===expected[1])return;if(loc[1]===expected[0]&&loc[0]===expected[1])return;errorCause="Incorrect Value (expected ="+expected+" )"}fail=!0,console.error("input "+s+" failed. Cause: "+errorCause+"  Actual = "+actual+" ("+title+")")}var fail=!1
;test("48°24'59.41\" N 123°30'25.34\" W",[-123.50703888888889,48.41650277777778],"lat long; no spaces after components"),test("48°24'59.41\"N,123°30'25.34\"W",[-123.50703888888889,48.41650277777778],"lat long; no spaces"),test("48 0.0000 -123 0.0000",[-123,48],"lat long with zero minutes"),test("48.440 -123.378",[-123.378,48.44],"lat long DD"),test("48.440, -123.378",[-123.378,48.44]),test("48 26.4' -123 22.68'",[-123.378,48.44]),test("48 26.4', -123 22.68'",[-123.378,48.44]),test("48 26.4 -123 22.68",[-123.378,48.44]),test("48 26.4, -123 22.68",[-123.378,48.44]),test("48 26' 24\" -123 22' 40.8\"",[-123.378,48.44]),test("48 26' 24\", -123 22' 40.8\"",[-123.378,48.44]),test("48 26 24 -123 22 40.8",[-123.378,48.44]),test("48 26 24, -123 22 40.8",[-123.378,48.44]),test("-123.378 48.440",[-123.378,48.44]),test("-123.378, 48.440",[-123.378,48.44]),test("-123 22.68' 48 26.4'",[-123.378,48.44]),test("-123 22.68', 48 26.4'",[-123.378,48.44]),test("-123 22.68 48 26.4",[-123.378,48.44]),test("-123 22.68, 48 26.4",[-123.378,48.44]),test("-123 22' 40.8\" 48 26' 24\"",[-123.378,48.44]),test("-123 22' 40.8\", 48 26' 24\"",[-123.378,48.44]),test("-123 22 40.8 48 26 24",[-123.378,48.44]),test("-123 22 40.8, 48 26 24",[-123.378,48.44]),test("-123 22 40.8, 48 26 24",[-123.378,48.44]),test("48.440N, 123.378W",[-123.378,48.44],"lat long with quadrant letters"),test("588840 5613787 9",[-127.74282465291321,50.669139944269546],"UTM Easting-Northing"),test("588840 5613787 ZONE 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 Zone 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 zone 9",[-127.74282465291321,50.669139944269546]),test("588840 5613787 Z 9",[-127.74282465291321,50.669139944269546]),test("588840.5 5613787.5 Z 9",[-127.74282465291321,50.669139944269546]),test("5613787 588840 9",[-127.74282465291321,50.669139944269546],"UTM Northing-Easting"),test("10, 160",[-160,10]),test("10, 100",[-100,10]),test("80, 160",[-160,80]),test("80, 100",[-100,80]),fail?console.error("WFML.Location.parseLocation: Failures encountered"):console.log("WFML.Location.parseLocation: All tests passed")},WFML.Location.testParse=function(){function test(s,expectedLoc){var actual=check(s,expectedLoc);!actual&&expectedLoc&&(fail=!0,console.error("input "+s+" failed - actual = "+actual))}function check(s,expectedLoc){var actual=WFML.Location.parse(s),loc=actual;if(!loc){if(expectedLoc)return;return actual}if(loc[0]===expectedLoc[0]&&loc[1]===expectedLoc[1])return actual}var fail=!1;return test("48.440 -123.378",[-123.378,48.44]),test(" 48.440 -123.378 ",[-123.378,48.44]),test(" 48.440 -123.378",[-123.378,48.44]),test("",null),test("A",null),test("4",null),test("4.",null),test("48.44",null),test("48.440, ",null),test("48.440 ",null),test("48.440 AB",null),test("588840 5",null),test("588840 5613787",null),test("588840 5613787 Z",null),test("588840 5613787 ZONE ",null),test("588840 5613787 ZONE A",null),fail?console.error("WFML.Location.parse: Failures encountered"):console.log("WFML.Location.parse: All tests passed"),!fail}}(),function(){function toArray(o){return o instanceof Array?o:[o]}function computeChildrenVisMix(child){for(var hasChildVisible=!1,hasChildNonVisible=!1,hasChildMixed=!1,i=0;i<child.length;i++){var ch=child[i];ch.visible()&&(hasChildVisible=!0),ch.visible()||(hasChildNonVisible=!0),ch.isMixed()&&(hasChildMixed=!0)}var mix=!!hasChildMixed||hasChildVisible&&hasChildNonVisible;return{mixed:mix,isVisible:!mix&&hasChildVisible}}function cqlInExpr(def){var quoteVals=WFML.Util.map(def.values,function(v){return"'"+v+"'"}),inVals=quoteVals.join(",");return def.name+" IN ("+inVals+")"}function cqlLikeExpr(def){var names=def.name.split(","),like=" ILIKE '%"+def.like+"%'";return"("+WFML.Util.map(names,function(nm){return nm+like}).join(" OR ")+")"}function sldFill(style){var sld="";if(style.fillClr){sld+='<CssParameter name="fill">'+sldExpr(style.fillClr)+"</CssParameter>"}return style.fillOpacity&&(sld+='<CssParameter name="fill-opacity">'+style.fillOpacity+"</CssParameter>"),sld.length>0&&(sld="<Fill>"+sld+"</Fill>"),sld}function sldStroke(style){var sld="";return style.strokeClr&&(sld+='<CssParameter name="stroke">'+style.strokeClr+"</CssParameter>"),style.strokeWidth&&(sld+='<CssParameter name="stroke-width">'+style.strokeWidth+"</CssParameter>"),sld.length>0&&(sld="<Stroke>"+sld+"</Stroke>"),sld}function sldText(style){var sld="";style.label&&(sld+="<Label><ogc:PropertyName>"+style.label+"</ogc:PropertyName></Label>");var font="";style.fontFamily&&(font+='<CssParameter name="font-family">'+style.fontFamily+"</CssParameter>"),style.fontStyle&&(font+='<CssParameter name="font-style">'+style.fontStyle+"</CssParameter>"),style.fontWeight&&(font+='<CssParameter name="font-weight">'+style.fontWeight+"</CssParameter>"),style.fontSize&&(font+='<CssParameter name="font-size">'+style.fontSize+"</CssParameter>"),font.length>0&&(sld+="<Font>"+font+"</Font>");var pointPlacement="",anchor="";return style.anchorX&&(anchor+="<AnchorPointX>"+style.anchorX+"</AnchorPointX>"),style.anchorY&&(anchor+="<AnchorPointY>"+style.anchorY+"</AnchorPointY>"),anchor.length>0&&(pointPlacement+="<AnchorPoint>"+anchor+"</AnchorPoint>"),pointPlacement.length>0&&(sld+="<LabelPlacement><PointPlacement>"+pointPlacement+"</PointPlacement></LabelPlacement>"),sld.length>0&&(sld="<TextSymbolizer>"+sld+"</TextSymbolizer>"),sld}function sldExpr(expr){return expr instanceof String?expr:expr instanceof Number?expr:expr.op&&"recode"===expr.op?sldRecode(expr):expr}function sldRecode(op){var sld="",rec='<ogc:Function name="Recode">',prop="<ogc:PropertyName>"+op.name+"</ogc:PropertyName>";rec+=prop;for(var i=0;i<op.map.length;i++)rec+="<ogc:Literal>"+op.map[i].data+"</ogc:Literal>",rec+="<ogc:Literal>"+op.map[i].value+"</ogc:Literal>";if(rec+="</ogc:Function>",sld=rec,op.else){sld='<ogc:Function name="if_then_else">'+('<ogc:Function name="in">'+prop+sldDataList(op.map)+"</ogc:Function>")+rec+"<ogc:Literal>"+op.else+"</ogc:Literal></ogc:Function>"}return sld}function sldDataList(arr){for(var sld="",i=0;i<arr.length;i++)sld+="<ogc:Literal>"+arr[i].data+"</ogc:Literal>";return sld}function infoProps(f,attributes){return attributes?infoPropsFromAttr(f,attributes):infoPropsRaw(f)}function infoPropsFromAttr(fprops,attributes){for(var props=[],i=0;i<attributes.length;i++){var propName=attributes[i].name,val=infoPropDisplayValue(fprops,propName),name=attributes[i].title;name||(name=attributes[i].name),props.push({name:attributes[i].title,value:val,description:attributes[i].description})}return props}function infoPropDisplayValue(fprops,name){var val=fprops[name];return val=fprops.hasOwnProperty(name)?val:"##MISSING##",val||(val=""),val}function infoPropsRaw(fprops){var props=[];for(var i in fprops)fprops.hasOwnProperty(i)&&props.push({name:i,value:fprops[i]});return props}WFML.LayerManager=function(wfmlMap){this.wfmlMap=wfmlMap,this.leafMap=wfmlMap.leafMap,this.overlay=[],this.loading=!1},WFML.LayerManager.prototype.init=function(layerConf){function getOverlay(LM,lyr){return currOV||(currOV=new WFML.Overlay(LM,{url:service(lyr).url,format:"image/png",transparent:!0,tiled:service(lyr).tiled,opacity:lyr.opacity,isVisible:!0})),currOV}function service(lyr){return lyr.service?services[lyr.service]:{url:null,tiled:!1}}function finalizeOverlay(LM){currOV&&(LM.overlay.push(currOV),currOV=null)}for(var layers=layerConf.layers,services=layerConf.services,currService=null,currOpacity=null,i=0;i<layers.length;i++){var lyr=layers[i];(function(lyr){return currService!=lyr.service||currOpacity!=lyr.opacity})(lyr)&&(finalizeOverlay(this),lyr.folder,currService=lyr.service,currOpacity=lyr.opacity),function(LM,lyr){getOverlay(LM,lyr),currOV.addLayer(lyr)}(this,lyr)}finalizeOverlay(this);var self=this;this.leafMap.on("zoom",function(){self.update()});var zIndex=2;for(i=this.overlay.length-1;i>=0;i--)this.overlay[i].init(this.wfmlMap,zIndex),zIndex+=1;var currOV=null},WFML.LayerManager.prototype.find=function(key){return this.findById(key)},WFML.LayerManager.prototype.findById=function(id){for(var iov=this.overlay.length-1;iov>=0;iov--)for(var ov=this.overlay[iov],ilyr=0;ilyr<ov.layers.length;ilyr++){var lyr=ov.layers[ilyr];if(lyr.id&&lyr.id===id)return lyr;if(lyr.layers==id)return lyr}return null},WFML.LayerManager.prototype.update=function(){for(var iov=this.overlay.length-1;iov>=0;iov--){this.overlay[iov].update()}},WFML.LayerManager.prototype.redraw=function(){for(var iov=this.overlay.length-1;iov>=0;iov--){var ov=this.overlay[iov];ov.leafLayer&&ov.leafLayer.redraw()}},WFML.LayerManager.prototype.isInScaleRange=function(scaleMin,scaleMax){var scale=this.wfmlMap.scale();return!(scaleMin&&scale<scaleMin)&&!(scaleMax&&scale>scaleMax)},WFML.LayerManager.prototype.zoomToScale=function(scaleMin,scaleMax){var scale=this.wfmlMap.scale(),scaleTarget=null,roundDown=!0;if(scaleMin&&scale<scaleMin&&(scaleTarget=scaleMin,roundDown=!1),scaleMax&&scale>scaleMax&&(scaleTarget=scaleMax,roundDown=!0),scaleTarget){var levelTarget=this.wfmlMap.zoomForScale(scaleTarget,roundDown);return this.wfmlMap.zoomLevel(levelTarget),!0}},WFML.LayerManager.prototype._loading=function(){this.loading,this.wfmlMap.control.spinner&&this.wfmlMap.control.spinner.enable(),this.loading=!0,this.loadStartTime=Date.now(),this.loadOverlayStatus=[],this.wfmlMap.callback.loadStart&&this.wfmlMap.callback.loadStart()},WFML.LayerManager.prototype._updateLoad=function(){for(var isLoadFinished=!0,iov=0;iov<this.overlay.length;iov++){var ov=this.overlay[iov];ov.hasService()&&("load"!=ov.loadStatus?isLoadFinished=!1:this._logLayerLoad(ov,iov))}isLoadFinished&&(this.wfmlMap.control.spinner.disable(),this.loadTimeMillis=Date.now()-this.loadStartTime,this.loading=!1,this._DEBUG&&this._logDisplay(),this.wfmlMap.callback.loadEnd&&this.wfmlMap.callback.loadEnd())},WFML.LayerManager.prototype._logLayerLoad=function(ov,iov){var status=this.loadOverlayStatus;if(status&&!status[iov]){var time=Date.now()-this.loadStartTime,lyrs=ov.layerNames(),bbox=ov.leafLayer._map&&ov.leafLayer.getBbox?ov.leafLayer.getBbox():"";lyrs.length<=0&&(lyrs=null,time=0,bbox=null),status[iov]={overlay:ov,loadTimeMillis:time,layers:lyrs,url:ov.url,bbox:bbox}}},WFML.LayerManager.prototype._logDisplay=function(){console.log("\n>>>>>> Layer Load total time: "+this.loadTimeMillis+" ms    Zoom: "+this.leafMap.getZoom());var bbox=null;this.loadOverlayStatus.forEach(function(a){a.bbox&&(bbox=a.bbox)}),console.log("BBOX: "+bbox);for(var i in this.loadOverlayStatus){var stat=this.loadOverlayStatus[i];if(stat.layers){var logOpacity=stat.overlay.opacity?"  opacity: "+stat.overlay.opacity:"";console.log("Svc: "+stat.overlay.url+" [ "+stat.loadTimeMillis+" ms ]  Layers:  "+stat.layers+logOpacity)}}},WFML.LayerManager.prototype.legend=function(){for(var legend=[],iov=0;iov<this.overlay.length;iov++)for(var ov=this.overlay[iov],ilyr=0;ilyr<ov.layers.length;ilyr++){var lyr=ov.layers[ilyr];lyr.visible()&&legend.push({title:lyr.title,entries:lyr.legend()})}return legend},WFML.LayerManager.prototype.visible=function(isVisible){for(var iov=0;iov<this.overlay.length;iov++){this.overlay[iov].visible(isVisible)}},WFML.LayerManager.prototype.listView=function(){for(var layers=[],iov=0;iov<this.overlay.length;iov++)for(var ov=this.overlay[iov],ilyr=0;ilyr<ov.layers.length;ilyr++){var lyr=ov.layers[ilyr];layers.push(lyr)}return layers},WFML.LayerManager.prototype.treeView=function(){for(var root=new WFML.LayerGroupView,iov=0;iov<this.overlay.length;iov++)for(var ov=this.overlay[iov],ilyr=0;ilyr<ov.layers.length;ilyr++){var lyr=ov.layers[ilyr],grp=root.findExpand(toArray(lyr.folder));grp.addLayer(lyr)}return root.computeMixed(),root},WFML.LayerGroupView=function(title){this.title=title,this.isVisible=!0,this.mixed=null,this.child=[],this.parent=null},WFML.LayerGroupView.prototype.isFolder=function(){return!0},WFML.LayerGroupView.prototype.parent=function(){return this.parent},WFML.LayerGroupView.prototype.children=function(){return this.child},WFML.LayerGroupView.prototype.findChild=function(title){for(var i=0;i<this.child.length;i++){var ch=this.child[i];if(ch.title==title)return ch}return null},WFML.LayerGroupView.prototype.findExpand=function(folders,level){if(level||(level=0),0==folders.length)return this;var chTitle=folders[level],grp=this.findChild(chTitle);return grp||(grp=this.addGroup(chTitle)),folders.length==level+1?grp:grp.findExpand(folders,level+1)},WFML.LayerGroupView.prototype.addGroup=function(title){return this.addChild(new WFML.LayerGroupView(title))},WFML.LayerGroupView.prototype.addLayer=function(lyr){return this.addChild(new WFML.LayerView(lyr))},WFML.LayerGroupView.prototype.addChild=function(ch){return this.child.push(ch),ch.parent=this,ch},WFML.LayerGroupView.prototype.visible=function(isVis){if(void 0===isVis)return this.isVisible;var isChanged=isVis!=this.isVisible;this.isVisible=isVis;for(var i=0;i<this.child.length;i++)this.child[i].visible(isVis);isChanged&&this.fireChange()},WFML.LayerGroupView.prototype.isMixed=function(){return this.mixed},WFML.LayerGroupView.prototype.computeMixed=function(){for(var i=0;i<this.child.length;i++){var ch=this.child[i];ch.isFolder()&&ch.computeMixed()}var vm=computeChildrenVisMix(this.child);this.mixed=vm.mixed,this.isVisible=vm.isVisible},WFML.LayerGroupView.prototype.updateMixed=function(){var vm=computeChildrenVisMix(this.child),isChanged=vm.mixed!=this.mixed||vm.isVisible!=this.isVisible;this.mixed=vm.mixed,this.isVisible=vm.isVisible,isChanged&&this.fireChange(),this.parent&&this.parent.updateMixed()},WFML.LayerGroupView.prototype.onChange=function(f){this.onChangeFn=f},WFML.LayerGroupView.prototype.fireChange=function(){this.onChangeFn&&this.onChangeFn(this)},WFML.LayerView=function(layer){this.layer=layer,this.title=layer.title;var self=this;this.layer.onChange(function(){self.fireChange(),self.parent.updateMixed()})},WFML.LayerView.prototype.isFolder=function(){return!1},WFML.LayerView.prototype.isMixed=function(){return!1},WFML.LayerView.prototype.layer=function(){return this.layer},WFML.LayerView.prototype.visible=function(isVis){if(void 0===isVis)return this.layer.visible();var oldVisible=this.layer.visible();this.layer.visible(isVis),oldVisible!=this.layer.visible()&&this.fireChange(),this.parent.updateMixed()},WFML.LayerView.prototype.onChange=function(f){this.onChangeFn=f},WFML.LayerView.prototype.fireChange=function(){this.onChangeFn&&this.onChangeFn(this)},WFML.Overlay=function(layerMgr,def){this.layerMgr=layerMgr,this.leafMap=layerMgr.leafMap,this.url=def.url,this.format=def.format?def.format:"image/png",this.transparent=!def.transparent||def.transparent,this.tiled=def.tiled,this.layers=[],this.loadStatus="",this.opacity=def.opacity},WFML.Overlay.prototype.init=function(wfmlMap,zIndex){var opt={layers:this.layerNames(),format:this.format,zIndex:zIndex,transparent:this.transparent,opacity:this.opacity};if(this.hasService()){this.tiled?this.leafLayer=L.tileLayer.wms(this.url,opt):this.leafLayer=L.nonTiledLayer.wms(this.url,opt),this.leafLayer.addTo(this.leafMap),this.update();var self=this;this.leafLayer.on("loading",function(){self.loadStatus="loading",self.layerMgr._loading()}),this.leafLayer.on("load",function(){self.loadStatus="load",self.layerMgr._updateLoad(),self.salt()})}},WFML.Overlay.prototype.hasService=function(){return this.url},WFML.Overlay.prototype.update=function(){if(this.hasService()){var lyrNames=this.layerNames();this.leafLayer.wmsParams.layers=lyrNames;var lyrStyles=this.layerStyles();lyrStyles&&(this.leafLayer.wmsParams.styles=lyrStyles),this.salt();var lyrFilters=this.layerFilters();lyrFilters.length>0?this.leafLayer.wmsParams.cql_filter=lyrFilters:delete this.leafLayer.wmsParams.cql_filter;var sld=this.sldBody();sld?this.leafLayer.wmsParams.SLD_BODY=sld:delete this.leafLayer.wmsParams.SLD_BODY,0==lyrNames.length?this.leafMap.removeLayer(this.leafLayer):(this.leafMap.hasLayer(this.leafLayer)||this.leafMap.addLayer(this.leafLayer),this.leafLayer.redraw())}},WFML.Overlay.prototype.addLayer=function(def){this.layers.push(new WFML.Layer(this,def))},WFML.Overlay.prototype.salt=function(){this.leafLayer.wmsParams.SALT=Math.random()},WFML.Overlay.prototype.layerNames=function(){return WFML.Util.map(this.layers,function(lyr){return lyr.isDisplayed()?lyr.layers:null}).reverse().join(",")},WFML.Overlay.prototype.layerStyles=function(){var names=WFML.Util.map(this.layers,function(lyr){return lyr.isDisplayed()?lyr.styles?lyr.styles:"":null}),styles=names.reverse().join(",");return styles.replace(",","").trim().length<=0?null:styles},WFML.Overlay.prototype.visible=function(isVisible){this.layers.forEach(function(lyr){lyr.isVisible=!0===isVisible}),this.update()},WFML.Overlay.prototype.sldBody=function(){return WFML.Util.find(this.layers,function(lyr){return lyr.sld?lyr.sld:null})},WFML.Overlay.prototype.layerFilters=function(){var filters=WFML.Util.map(this.layers,function(lyr){return lyr.visible()?lyr.cqlFilter:null});return 0==filters.join("").length?"":WFML.Util.map(filters,function(f){return f.length>0?f:"INCLUDE"}).reverse().join(";")},WFML.Layer=function(overlay,config){this.overlay=overlay,this._initFromConfig(config),this.cqlFilter="",this.sld="",this.callbackOnChange=[]},WFML.Layer.prototype._initFromConfig=function(def){this.title=def.title,this.id=def.id,this.source=def.source,this.folder=def.folder,this.layers=def.layers,this.styles=def.styles,this.scaleMax=def.scaleMax,this.scaleMin=def.scaleMin,this.opacity=def.opacity,this.attributes=def.attributes,this.isVisible=void 0!=def.visible&&def.visible;var self=this;!function(){self.legendDef=null,self.overlay.hasService()&&(self.legendDef=[{label:null,url:self.legendURL(),width:null}])}()},WFML.Layer.prototype.getId=function(){return this.id?this.id:this.layers},WFML.Layer.prototype.onChange=function(callback){this.callbackOnChange.push(callback)},WFML.Layer.prototype._fireChange=function(){for(var i in this.callbackOnChange)this.callbackOnChange[i](this)},WFML.Layer.prototype.visible=function(isVis){if(void 0==isVis)return this.isVisible;var isChange=isVis!=this.isVisible;this.isVisible=!0===isVis,this.overlay.update(),"WFML.Markers"==this.source&&this.overlay.layerMgr.wfmlMap.markerMgr.showMarkers(this.id,this.isVisible),isChange&&this._fireChange()},WFML.Layer.prototype.isDisplayed=function(){return this.isVisible&&this.isInScaleRange()},WFML.Layer.prototype.hasScaleRange=function(){return this.scaleMin||this.scaleMax},WFML.Layer.prototype.isInScaleRange=function(){return this.overlay.layerMgr.isInScaleRange(this.scaleMin,this.scaleMax)},WFML.Layer.prototype.zoomToScale=function(){this.overlay.layerMgr.zoomToScale(this.scaleMin,this.scaleMax)},WFML.Layer.prototype.redraw=function(){this.overlay.update()},WFML.Layer.prototype.filter=function(filter){this.cqlFilter=WFML.Layer.Util.toCQL(filter),this.overlay.update()},WFML.Layer.prototype.style=function(style){this.sld=WFML.Layer.Util.toSLD(this.layers,style),this.overlay.update()},WFML.Layer.prototype.legend=function(legendDef){if(!legendDef)return this.legendDef;this.legendDef=legendDef},WFML.Layer.prototype.legendURL=function(){return WFML.Util.getParamString({SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"getlegendgraphic",FORMAT:"image/png",LAYER:this.layers},this.overlay.url+"?")},WFML.Layer.prototype.identify=function(pt){var serviceUrl=this.overlay.url,layerName=this.layers,size=this.overlay.leafMap.getSize(),crs=this.overlay.leafMap.options.crs,bnds=this.overlay.leafMap.getBounds(),sw=crs.project(bnds.getSouthWest()),ne=crs.project(bnds.getNorthEast()),bbox=sw.x+","+sw.y+","+ne.x+","+ne.y,params={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",bbox:bbox,feature_count:20,height:size.y,width:size.x,buffer:10,info_format:"application/json",layers:layerName,query_layers:layerName};params.srs="EPSG:3857",params.x=parseInt(pt.x),params.y=parseInt(pt.y);var getOptions={method:"GET",url:serviceUrl,data:params,xhrFields:{}};return $.ajax(getOptions).then(function(data){if(data&&data.features&&data.features.length>0)return data.features})},WFML.Layer.prototype.infoPopupHTML=function(features){for(var f=features[0],prop=infoProps(f.properties,this.attributes),$top=$('<div class="wfml-info-content">'),i=0;i<prop.length;i++){var $d=$('<div  class="wfml-info-line">').appendTo($top);$('<span class="wfml-info-name">').text(prop[i].name).attr("title",prop[i].description).appendTo($d),$('<span class="wfml-info-value">').text(prop[i].value).appendTo($d)}return $top.get(0)},WFML.Layer.Util={},WFML.Layer.Util.toCQL=function(filter){return filter&&0!=filter.length?WFML.Util.map(filter,function(def){return def.like?cqlLikeExpr(def):cqlInExpr(def)}).join(" AND "):""},WFML.Util.toSLD=function(lyrName,style){return'<?xml version="1.0" encoding="ISO-8859-1"?><StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><NamedLayer><Name>'+lyrName+"</Name><UserStyle><FeatureTypeStyle><Rule><PolygonSymbolizer>"+sldFill(style)+sldStroke(style)+"</PolygonSymbolizer>"+sldText(style)+"</Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>"},WFML.Popup={},WFML.Popup.infoHtml=function(features,attributeDef,options){var f=features[0],prop=infoProps(f,attributeDef),clz=options.className?options.className:"wfml-info-content",$top=$('<div class="'+clz+'">');options.title&&$('<div class="wfml-info-title">').text(options.title).appendTo($top);for(var i=0;i<prop.length;i++){var $d=$('<div  class="wfml-info-line">').appendTo($top);$('<span class="wfml-info-name">').text(prop[i].name).attr("title",prop[i].description).appendTo($d),$('<span class="wfml-info-value">').text(prop[i].value).appendTo($d)}return $top.get(0)}}(),L.Control.ActionButton=L.Control.extend({options:{action:null,className:"no-op",position:"topleft",title:""},initialize:function(options){L.Util.setOptions(this,options)},onAdd:function(map){return this.map=map,this.active=!1,this.controlDiv=L.DomUtil.create("div","wfml-control"),L.DomUtil.addClass(this.controlDiv,this.options.className),this.controlDiv.setAttribute("title",this.options.title),this.controlDiv.control=this,this.options.action&&L.DomEvent.on(this.controlDiv,"click",this.options.action),this.controlDiv}}),L.control.actionButton=function(options){return new L.Control.ActionButton(options)},L.Control.BoxZoom=L.Control.extend({options:{position:"topleft",title:"Zoom to Box",onFinished:function(){}},initialize:function(options){L.Util.setOptions(this,options)},onAdd:function(map){return this.map=map,this.active=!1,this.controlDiv=L.DomUtil.create("div","wfml-control wfml-control-zoom-box"),this.controlDiv.setAttribute("title",this.options.title),this.controlDiv.control=this,L.DomEvent.on(this.controlDiv,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(this.controlDiv,"click",L.DomEvent.stopPropagation),L.DomEvent.on(this.controlDiv,"click",L.DomEvent.preventDefault),L.DomEvent.on(this.controlDiv,"click",function(){this.control.toggleState()}),this.setShiftKeyHandler(),this.setStateOff(),this.controlDiv},toggleState:function(){this.active?this.setStateOff():this.setStateOn()},setStateOn:function(){this.active=!0,this.map.dragging.disable(),this.map.on("mousedown",this.handleMouseDown,this),this.map.on("boxzoomend",this.setStateOff,this),L.DomUtil.addClass(this.map._container,"leaflet-control-boxzoom-active")},setStateOff:function(){this.active=!1,this.map.off("mousedown",this.handleMouseDown,this),this.map.dragging.enable(),L.DomUtil.removeClass(this.map._container,"leaflet-control-boxzoom-active"),this.options.onFinished()},setShiftKeyHandler:function(){function handleShift(event){self.active&&(event.shiftKey?self.setStateOn():self.setStateOff())}var self=this;window.addEventListener("keydown",handleShift,!1),window.addEventListener("keypress",handleShift,!1),window.addEventListener("keyup",handleShift,!1)},handleMouseDown:function(event){this.map.boxZoom._onMouseDown.call(this.map.boxZoom,{clientX:event.originalEvent.clientX,clientY:event.originalEvent.clientY,which:1,shiftKey:!0})}}),L.control.boxZoom=function(options){return new L.Control.BoxZoom(options)},L.Control.CursorPosition=L.Control.extend({options:{position:"bottomleft"},initialize:function(options){L.setOptions(this,options),this.location=""},onAdd:function(map){this.map=map;return this.displayDiv=L.DomUtil.create("div","wfml-control-coordinatedisplay"),map.on("mousemove",this._update,this),map.on("zoomend",this._update,this),map.whenReady(this._update,this),WFML.Lutil.stopProp(this.displayDiv),this.displayDiv},onRemove:function(map){},_update:function(evt){var self=this;!function(ms,fn){delayed&&clearTimeout(delayed),delayed=setTimeout(fn,ms)}(200,function(){evt.latlng&&(self.location=WFML.Location.format(WFML.Util.toLonLat(evt.latlng)));var scale=self.getScale();self.displayDiv.innerHTML='<div class="wfml-scale">1 : '+formatNumber(scale)+'</div><div class="wfml-location">'+self.location+"</div>"});var delayed},getScale:function(){return WFML.Lutil.scale(this.map)}}),L.control.cursorPosition=function(options){return new L.Control.CursorPosition(options)},L.Control.Geolocation=L.Control.extend({options:{position:"topleft"},initialize:function(options){L.Util.setOptions(this,options)},onAdd:function(map){this.control=L.DomUtil.create("div","wfml-control wfml-control-zoom-location"),this.control.setAttribute("tooltip","Zoom to my location"),this.spinner=L.DomUtil.create("div","spinner",this.control);var self=this;return L.DomEvent.on(this.control,"click",function(){self.spinner.style.visibility="visible",map.once("locationfound locationerror",function(){self.spinner.style.visibility="hidden"}),map.locate({setView:!0})}),this.control}}),L.control.geolocation=function(options){return new L.Control.Geolocation(options)},function(){"use strict";L.Map.prototype._initControlPos=function(_initControlPos){return function(){_initControlPos.apply(this,arguments),this._controlCorners.topcenter=L.DomUtil.create("div","leaflet-top leaflet-center",this._controlContainer),this._controlCorners.bottomcenter=L.DomUtil.create("div","leaflet-bottom leaflet-center",L.DomUtil.create("div","leaflet-control-bottomcenter",this._controlContainer))}}(L.Map.prototype._initControlPos),L.Crosshairs=L.LayerGroup.extend({options:{style:{opacity:1,fillOpacity:0,weight:2,color:"#f00",radius:20}},initialize:function(latLng,options){L.LayerGroup.prototype.initialize.call(this),L.Util.setOptions(this,options),this.loc=L.latLng(latLng)},onAdd:function(map){this._map=map,this.crosshair={circle:L.circleMarker([0,0],this.options.style),longitude_line_north:L.polyline([],this.options.style),longitude_line_south:L.polyline([],this.options.style),latitude_line_east:L.polyline([],this.options.style),latitude_line_west:L.polyline([],this.options.style)};for(var layer in this.crosshair)this.addLayer(this.crosshair[layer]);this._setCrosshairs(this.loc),this._show(),this._map.on("moveend",this._setCrosshairs.bind(this)),this.eachLayer(map.addLayer,map)},onRemove:function(map){this._map.off("moveend",this._setCrosshairs),this.eachLayer(this.removeLayer,this)},_show:function(){this.eachLayer(function(l){this._map.addLayer(l)},this)},_hide:function(){this.eachLayer(function(l){this._map.removeLayer(l)},this)},_setCrosshairs:function(){var latlng=this.loc;if(latlng&&this._map){this.crosshair.circle.setLatLng(latlng);var point=this._map.project(latlng);this.crosshair.longitude_line_north.setLatLngs([this._map.unproject([point.x,point.y-this.options.style.radius]),this._map.unproject([point.x,this._map.getPixelBounds().min.y])]),this.crosshair.longitude_line_south.setLatLngs([this._map.unproject([point.x,point.y+this.options.style.radius]),this._map.unproject([point.x,this._map.getPixelBounds().max.y])]),this.crosshair.latitude_line_east.setLatLngs([this._map.unproject([point.x-this.options.style.radius,point.y]),this._map.unproject([this._map.getPixelBounds().min.x,point.y])]),this.crosshair.latitude_line_west.setLatLngs([this._map.unproject([point.x+this.options.style.radius,point.y]),this._map.unproject([this._map.getPixelBounds().max.x,point.y])])}}}),L.crosshairs=function(latLng,options){return new L.Crosshairs(latLng,options)},L.Arrow=L.LayerGroup.extend({options:{title:null,style:{opacity:1,fillOpacity:1,weight:2,fillColor:"#0c0",color:"#080"}},initialize:function(latLngStart,latLngEnd,options){L.LayerGroup.prototype.initialize.call(this),L.Util.setOptions(this,options),this.locStart=L.latLng(latLngStart),this.locEnd=L.latLng(latLngEnd)},onAdd:function(map){this._map=map,this.symbol={arrow:L.polygon([],this.options.style)};for(var layer in this.symbol)this.addLayer(this.symbol[layer]);this._setArrow(this.locStart,this.locEnd),this._show(),this.eachLayer(map.addLayer,map)},onRemove:function(map){this.eachLayer(this.removeLayer,this)},_show:function(){this.eachLayer(function(l){this._map.addLayer(l)},this)},_hide:function(){this.eachLayer(function(l){this._map.removeLayer(l)},this)},_setArrow:function(){if(this.locStart&&this.locEnd&&this._map){var pt0=this._map.project(this.locStart),pt1=this._map.project(this.locEnd),dx=(this._map.getPixelBounds(),pt1.x-pt0.x),dy=pt1.y-pt0.y,dist=Math.sqrt(dx*dx+dy*dy),cos=dx/dist,sin=dy/dist;if(!(100>dist)){var baseL=[23*cos+3*sin,23*sin+3*-cos],baseR=[23*cos+3*-sin,23*sin+3*cos],headL0=[75*cos+5*sin,75*sin+5*-cos],headL1=[75*cos+15*sin,75*sin+15*-cos],tipPt=[100*cos,100*sin],headR0=[75*cos+5*-sin,75*sin+5*cos],headR1=[75*cos+15*-sin,75*sin+15*cos],pts=[baseR,baseL,headL0,headL1,tipPt,headR1,headR0],latlngs=function(map,pts){for(var p2=[],i=0;i<pts.length;i++)p2.push(map.unproject(pts[i]));return p2}(this._map,function(pts,x,y){for(var p2=[],i=0;i<pts.length;i++)p2.push([pts[i][0]+x,pts[i][1]+y]);return p2}(pts,pt0.x,pt0.y)),tipLL=latlngs[4];if(this.symbol.arrow.setLatLngs(latlngs),this.options.title&&this.options.title.length>0){var dir=cos<=0?"left":"right";this.symbol.arrow.bindTooltip(this.options.title,{permanent:!0,offset:[0,10],direction:dir}),this.symbol.arrow.openTooltip(tipLL)}}}}}),L.arrow=function(latLngStart,latLngEnd,options){return new L.Arrow(latLngStart,latLngEnd,options)},L.Layer.include({showDelay:1200,hideDelay:0,bindTooltipDelayed:function(content,options){return content instanceof L.Tooltip?(L.setOptions(content,options),this._tooltip=content,content._source=this):(this._tooltip&&!options||(this._tooltip=new L.Tooltip(options,this)),this._tooltip.setContent(content)),this._initTooltipInteractionsDelayed(),this._tooltip.options.permanent&&this._map&&this._map.hasLayer(this)&&this.openTooltipWithDelay(),this},_openTooltipDelayed:function(e){var layer=e.layer||e.target;this._tooltip&&this._map&&this.openTooltipWithDelay(layer,this._tooltip.options.sticky?e.latlng:void 0)},openTooltipDelayed:function(layer,latlng){if(layer instanceof L.Layer||(latlng=layer,layer=this),layer instanceof L.FeatureGroup)for(var id in this._layers){layer=this._layers[id];break}return latlng||(latlng=layer.getCenter?layer.getCenter():layer.getLatLng()),this._tooltip&&this._map&&(this._tooltip._source=layer,this._tooltip.update(),this._map.openTooltip(this._tooltip,latlng),this._tooltip.options.interactive&&this._tooltip._container&&(addClass(this._tooltip._container,"leaflet-clickable"),this.addInteractiveTarget(this._tooltip._container))),this},openTooltipWithDelay:function(t,i){this._delay(this.openTooltipDelayed,this,this.showDelay,t,i)},closeTooltipDelayed:function(){return this._tooltip&&(this._tooltip._close(),this._tooltip.options.interactive&&this._tooltip._container&&(removeClass(this._tooltip._container,"leaflet-clickable"),this.removeInteractiveTarget(this._tooltip._container))),this},closeTooltipWithDelay:function(){clearTimeout(this._timeout),this._delay(this.closeTooltipDelayed,this,this.hideDelay)},_delay:function(func,scope,delay,t,i){var me=this
;this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(function(){func.call(scope,t,i),delete me._timeout},delay)},_initTooltipInteractionsDelayed:function(remove$$1){if(remove$$1||!this._tooltipHandlersAdded){var onOff=remove$$1?"off":"on",events={remove:this.closeTooltipWithDelay,move:this._moveTooltip};this._tooltip.options.permanent?events.add=this._openTooltipDelayed:(events.mouseover=this._openTooltipDelayed,events.mouseout=this.closeTooltipWithDelay,events.click=this.closeTooltipWithDelay,this._tooltip.options.sticky&&(events.mousemove=this._moveTooltip),L.touch&&(events.click=this._openTooltipDelayed)),this[onOff](events),this._tooltipHandlersAdded=!remove$$1}}}),L.Tooltip.include({_setPosition:function(pos){var map=this._map,container=this._container,centerPoint=map.latLngToContainerPoint(map.getCenter()),tooltipPoint=map.layerPointToContainerPoint(pos),direction=this.options.direction,tooltipWidth=container.offsetWidth,tooltipHeight=container.offsetHeight,offset=L.point(this.options.offset),anchor=this._getAnchor();if("auto-all"===direction){var mapMax=L.point(2*centerPoint.x,2*centerPoint.y),isClose={left:tooltipPoint.x-tooltipWidth-20<0,right:tooltipPoint.x+tooltipWidth+20>mapMax.x,top:tooltipPoint.y-tooltipHeight-20<0,bottom:tooltipPoint.y+tooltipHeight+20>mapMax.y};direction="top";var offsetDir=[0,-1];isClose.top?(direction="bottom",offsetDir=[0,1],isClose.left?(direction="bottom-right",offsetDir=[1,1]):isClose.right&&(direction="bottom-left",offsetDir=[-1,1])):isClose.bottom?(direction="top",offsetDir=[0,-1],isClose.left?(direction="top-right",offsetDir=[1,-1]):isClose.right&&(direction="top-left",offsetDir=[-1,-1])):isClose.left?(direction="right",offsetDir=[1,0]):isClose.right&&(direction="left",offsetDir=[-1,0]),offset=L.point(offsetDir[0]*offset.x,offsetDir[1]*offset.y)}var ttClassDir=direction;"top"===direction?pos=pos.add(L.point(-tooltipWidth/2+offset.x,-tooltipHeight+offset.y+anchor.y,!0)):"top-left"===direction?pos=pos.add(L.point(-(tooltipWidth+anchor.x-offset.x),-tooltipHeight+offset.y+anchor.y,!0)):"top-right"===direction?pos=pos.add(L.point(offset.x+anchor.x,-tooltipHeight+offset.y+anchor.y,!0)):"bottom"===direction?pos=pos.subtract(L.point(tooltipWidth/2-offset.x,-offset.y,!0)):"bottom-left"===direction?pos=pos.subtract(L.point(tooltipWidth+anchor.x-offset.x,-offset.y,!0)):"bottom-right"===direction?pos=pos.subtract(L.point(-(offset.x+anchor.x),-offset.y,!0)):"center"===direction?pos=pos.subtract(L.point(tooltipWidth/2+offset.x,tooltipHeight/2-anchor.y+offset.y,!0)):"right"===direction||"auto"===direction&&tooltipPoint.x<centerPoint.x?(ttClassDir="right",pos=pos.add(L.point(offset.x+anchor.x,anchor.y-tooltipHeight/2+offset.y,!0))):(ttClassDir="left",pos=pos.subtract(L.point(tooltipWidth+anchor.x-offset.x,tooltipHeight/2-anchor.y-offset.y,!0))),L.DomUtil.removeClass(container,"leaflet-tooltip-right"),L.DomUtil.removeClass(container,"leaflet-tooltip-left"),L.DomUtil.removeClass(container,"leaflet-tooltip-top"),L.DomUtil.removeClass(container,"leaflet-tooltip-bottom"),L.DomUtil.addClass(container,"leaflet-tooltip-"+ttClassDir),L.DomUtil.setPosition(container,pos)}})}(),L.LoadSpinner=L.Control.extend({options:{position:"bottomcenter"},initialize:function(options){L.setOptions(this,options)},onAdd:function(map){var container=L.DomUtil.create("div","leaflet-control-spinner");return this.div=container,this.div.style.display="none",container},onRemove:function(map){},disable:function(){return this.div.style.display="none",this},enable:function(){return this.div.style.display="block",this}}),L.loadSpinner=function(){return new L.LoadSpinner},L.Control.MiniMap=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{position:"bottomright",toggleDisplay:!1,zoomLevelOffset:-5,zoomLevelFixed:!1,centerFixed:!1,zoomAnimation:!1,autoToggleDisplay:!1,minimized:!1,width:150,height:150,collapsedWidth:19,collapsedHeight:19,aimingRectOptions:{color:"#ff7800",weight:1,clickable:!1},shadowRectOptions:{color:"#000000",weight:1,clickable:!1,opacity:0,fillOpacity:0},strings:{hideText:"Hide MiniMap",showText:"Show MiniMap"},mapOptions:{}},initialize:function(layer,options){L.Util.setOptions(this,options),this.options.aimingRectOptions.clickable=!1,this.options.shadowRectOptions.clickable=!1,this._layer=layer},onAdd:function(map){this._mainMap=map,this._container=L.DomUtil.create("div","leaflet-control-minimap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation);var mapOptions={attributionControl:!1,dragging:!this.options.centerFixed,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),scrollWheelZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),doubleClickZoom:this.options.centerFixed?"center":!this._isZoomLevelFixed(),boxZoom:!this._isZoomLevelFixed(),crs:map.options.crs};return mapOptions=L.Util.extend(this.options.mapOptions,mapOptions),this._miniMap=new L.Map(this._container,mapOptions),this._miniMap.addLayer(this._layer),this._mainMapMoving=!1,this._miniMapMoving=!1,this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._miniMap.whenReady(L.Util.bind(function(){this._aimingRect=L.rectangle(this._mainMap.getBounds(),this.options.aimingRectOptions).addTo(this._miniMap),this._shadowRect=L.rectangle(this._mainMap.getBounds(),this.options.shadowRectOptions).addTo(this._miniMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._miniMap.on("movestart",this._onMiniMapMoveStarted,this),this._miniMap.on("move",this._onMiniMapMoving,this),this._miniMap.on("moveend",this._onMiniMapMoved,this)},this)),this._container},addTo:function(map){L.Control.prototype.addTo.call(this,map);var center=this.options.centerFixed||this._mainMap.getCenter();return this._miniMap.setView(center,this._decideZoom(!0)),this._setDisplay(this.options.minimized),this},onRemove:function(map){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._miniMap.off("moveend",this._onMiniMapMoved,this),this._miniMap.removeLayer(this._layer)},changeLayer:function(layer){this._miniMap.removeLayer(this._layer),this._layer=layer,this._miniMap.addLayer(this._layer)},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this._toggleButtonInitialTitleText(),"leaflet-control-minimap-toggle-display leaflet-control-minimap-toggle-display-"+this.options.position,this._container,this._toggleDisplayButtonClicked,this):void 0,this._toggleDisplayButton.style.width=this.options.collapsedWidth+"px",this._toggleDisplayButton.style.height=this.options.collapsedHeight+"px"},_toggleButtonInitialTitleText:function(){return this.options.minimized?this.options.strings.showText:this.options.strings.hideText},_createButton:function(html,title,className,container,fn,context){var link=L.DomUtil.create("a",className,container);link.innerHTML=html,link.href="#",link.title=title;var stop=L.DomEvent.stopPropagation;return L.DomEvent.on(link,"click",stop).on(link,"mousedown",stop).on(link,"dblclick",stop).on(link,"click",L.DomEvent.preventDefault).on(link,"click",fn,context),link},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?this._restore():this._minimize()},_setDisplay:function(minimize){minimize!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width=this.options.collapsedWidth+"px",this._container.style.height=this.options.collapsedHeight+"px",this._toggleDisplayButton.className+=" minimized-"+this.options.position,this._toggleDisplayButton.title=this.options.strings.showText):this._container.style.display="none",this._minimized=!0,this._onToggle()},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace("minimized-"+this.options.position,""),this._toggleDisplayButton.title=this.options.strings.hideText):this._container.style.display="block",this._minimized=!1,this._onToggle()},_onMainMapMoved:function(e){if(this._miniMapMoving)this._miniMapMoving=!1;else{var center=this.options.centerFixed||this._mainMap.getCenter();this._mainMapMoving=!0,this._miniMap.setView(center,this._decideZoom(!0)),this._setDisplay(this._decideMinimized())}this._aimingRect.setBounds(this._mainMap.getBounds())},_onMainMapMoving:function(e){this._aimingRect.setBounds(this._mainMap.getBounds())},_onMiniMapMoveStarted:function(e){if(!this.options.centerFixed){var lastAimingRect=this._aimingRect.getBounds(),sw=this._miniMap.latLngToContainerPoint(lastAimingRect.getSouthWest()),ne=this._miniMap.latLngToContainerPoint(lastAimingRect.getNorthEast());this._lastAimingRectPosition={sw:sw,ne:ne}}},_onMiniMapMoving:function(e){this.options.centerFixed||!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setBounds(new L.LatLngBounds(this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.sw),this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.ne))),this._shadowRect.setStyle({opacity:1,fillOpacity:.3}))},_onMiniMapMoved:function(e){this._mainMapMoving?this._mainMapMoving=!1:(this._miniMapMoving=!0,this._mainMap.setView(this._miniMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_isZoomLevelFixed:function(){var zoomLevelFixed=this.options.zoomLevelFixed;return this._isDefined(zoomLevelFixed)&&this._isInteger(zoomLevelFixed)},_decideZoom:function(fromMaintoMini){if(this._isZoomLevelFixed())return fromMaintoMini?this.options.zoomLevelFixed:this._mainMap.getZoom();if(fromMaintoMini)return this._mainMap.getZoom()+this.options.zoomLevelOffset;var toRet,currentDiff=this._miniMap.getZoom()-this._mainMap.getZoom(),proposedZoom=this._miniMap.getZoom()-this.options.zoomLevelOffset;return currentDiff>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._miniMap.getMinZoom()-this.options.zoomLevelOffset?this._miniMap.getZoom()>this._lastMiniMapZoom?(toRet=this._mainMap.getZoom()+1,this._miniMap.setZoom(this._miniMap.getZoom()-1)):toRet=this._mainMap.getZoom():toRet=proposedZoom,this._lastMiniMapZoom=this._miniMap.getZoom(),toRet},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?!!this._mainMap.getBounds().contains(this._miniMap.getBounds()):this._minimized},_isInteger:function(value){return"number"==typeof value},_isDefined:function(value){return void 0!==value},_onToggle:function(){L.Util.requestAnimFrame(function(){L.DomEvent.on(this._container,"transitionend",this._fireToggleEvents,this),L.Browser.any3d||L.Util.requestAnimFrame(this._fireToggleEvents,this)},this)},_fireToggleEvents:function(){L.DomEvent.off(this._container,"transitionend",this._fireToggleEvents,this);var data={minimized:this._minimized};this.fire(this._minimized?"minimize":"restore",data),this.fire("toggle",data)}}),function(){WFML.BASE_URL="",WFML.Img={highlightPoint:"img/highlight.png",editPoint:"img/edit-point.png",editPointShaded:"img/edit-point-shaded.png",selectPoint:"img/select-point-marker.png"},WFML.createMap=function(mapId,mapConfig,overlayConfig){var map=new WFML.Map(mapId,mapConfig,overlayConfig);return new WFML.API(map)},WFML.API=function(map){this._map=map,this.map={extent:function(){return map.extent()},resize:function(){map.resize()},redraw:function(){map.layerMgr.redraw()}},this.basemap={all:function(){return map._baseMaps},switch:function(i){map.currentBase&&map.leafMap.removeLayer(map.currentBase.layer),map.currentBase=map._baseMaps[i],map.leafMap.addLayer(map.currentBase.layer)}},this.navigation={zoom:function(lonlat,level){map.zoom(lonlat,level)},pan:function(lonlat){map.pan(lonlat)}},this.callback={click:function(callback){map.setClickHandler(callback)},hover:function(callback,delay){map.setHoverHandler(callback,delay)},selectPoint:function(callback){map.callback.selectpoint=callback},loadStart:function(callback){map.callback.loadStart=callback},loadEnd:function(callback){map.callback.loadEnd=callback},extentChange:function(callback){map.callback.extentChange=callback}},this.selectPoint={get:function(){return map.selectPointBuffer},clear:function(){map.selectPoint()}},this.distance={pixels:function(lonlat1,lonlat2){var pt1=map.leafMap.latLngToLayerPoint(WFML.Util.toLatLng(lonlat1)),pt2=map.leafMap.latLngToLayerPoint(WFML.Util.toLatLng(lonlat2)),dx=pt1.x-pt2.x,dy=pt1.y-pt2.y;return Math.sqrt(dx*dx+dy*dy)}},this.highlight={add:function(lonlat){lonlat&&WFML.Util.marker(lonlat,map.icon.highlight).addTo(map.layer.highlight)},clear:function(){map.layer.highlight.clearLayers()}},this.layer={treeView:function(){return map.layerMgr.treeView()},legend:function(id,legendDef){if(!id)return map.layerMgr.legend();var lyr=map.layerMgr.find(id);if(lyr)return lyr.legend(legendDef)},onChange:function(id,callback){var lyr=map.layerMgr.find(id);lyr&&lyr.onChange(callback)},filter:function(id,filter){var lyr=map.layerMgr.find(id);lyr&&lyr.filter(filter)},infoPopup:function(id,featureFilter){map.infoPopup(id,featureFilter)},redraw:function(id){var lyr=map.layerMgr.find(id);lyr&&lyr.redraw()},style:function(id,style){var lyr=map.layerMgr.find(id);lyr&&lyr.style(style)},visible:function(id,isVisible){if("*"==id)map.layerMgr.visible(isVisible);else{var lyr=map.layerMgr.find(id);lyr&&lyr.visible(isVisible)}}},this.primary={set:function(id){map.primary(id)},redraw:function(){map.layer.primary&&map.layer.primary.redraw()},filter:function(filter){map.primaryFilter(filter)}},this.edit={start:function(lonlat,callback){map.editStart(lonlat,callback)},stop:function(){map.editStop()}},this.search={clear:function(){map.search.clear()},setMaximumDistance:function(distance){map.search.setMaximumDistance(distance)},setAnchor:function(location){map.search.setAnchor(location)},zoomToAnchor:function(){map.search.zoom()},panToAnchor:function(){map.search.pan()},showCandidate:function(location){map.search.showCandidate(location)},setResultHandler:function(callback){map.search.setResultHandler(callback)},findPlace:function(text){map.search.findPlace(text)},findRoad:function(text){map.search.findRoad(text)},findIntersection:function(text1,text2){map.search.findIntersection(text1,text2)}},this.tool={activate:function(toolId){map.toolMgr.setActiveTool(toolId)}},this.legend={addLayers:function(legendLayers){map.legendAdd(legendLayers)}},this.marker={addMarkers:function(id,markers,option){map.markerMgr.addMarkers.apply(map.markerMgr,arguments)},addClusteredMarkers:function(id,markers,option){map.markerMgr.addClusteredMarkers.apply(map.markerMgr,arguments)},removeMarkers:function(id){map.markerMgr.removeMarkers.apply(map.markerMgr,arguments)},showMarkers:function(id,visible){map.markerMgr.showMarkers.apply(map.markerMgr,arguments)}}},WFML.BaseMaps={BCBase:{title:"BC Topo",maxZoom:18,url:"https://maps.gov.bc.ca/arcserver/rest/services/Province/web_mercator_cache/MapServer/tile/{z}/{y}/{x}"},BCRoad:{title:"BC Roads",maxZoom:18,url:"https://maps.gov.bc.ca/arcserver/rest/services/Province/roads_wm/MapServer/tile/{z}/{y}/{x}"},EsriTopo:{title:"ESRI Topo",maxZoom:18,url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"},EsriImagery:{title:"ESRI Imagery",maxZoom:18,url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_imagery/MapServer/tile/{z}/{y}/{x}"},EsriStreet:{title:"ESRI Streets",maxZoom:18,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"},EsriLightGray:{title:"ESRI Light Gray",maxZoom:18,url:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"},EsriHillshade:{title:"ESRI Hillshade",maxZoom:18,url:"https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}"}}}(),function(){"use strict";WFML.MarkerManager=function(map){this.map=map,this.layer={},this.layers=[]},WFML.MarkerManager.prototype.addMarkers=function(id,markers,option){if(id in this.layer)throw new Error('marker layer "'+id+'" already defined');option=Object.assign({visible:!0,populateTooltip:function(){}},option),markers.forEach(function(m){option.populatePopup&&m.bindPopup(function(featureLayer){return option.populatePopup(featureLayer.feature)},option.popupConfig?option.popupConfig:{}),option.markersClickCallback&&m.on("click",function(event){return option.markersClickCallback(event)});var ttopt=option.tooltipConfig?option.tooltipConfig:{};option.populateTooltipClass&&(ttopt.className=option.populateTooltipClass(m.feature)),m.showDelay=800,m.bindTooltipDelayed(function(featureLayer){return option.populateTooltip(featureLayer.feature)},ttopt)});var ly=L.featureGroup(markers);this.layers.push(id),this.layer[id]={id:id,layer:ly,visible:!1},this.showMarkers(id,option.visible)},WFML.MarkerManager.prototype.addClusteredMarkers=function(id,markers,option){function iconCreateFunction(cluster){var markerClass="marker-cluster";markerClass=option.clustering.className?option.clustering.className:function(cluster){var childCount=cluster.getChildCount(),c="marker-cluster marker-cluster-";return c+=childCount<10?"small":childCount<100?"medium":"large"}(cluster);var childCount=cluster.getChildCount();return new L.DivIcon({html:"<div><span>"+childCount+"</span></div>",className:markerClass,iconSize:new L.Point(40,40)})}if(id in this.layer)throw new Error('marker layer "'+id+'" already defined');option=Object.assign({visible:!0,clustering:{}},option),this.addMarkers(id,markers,Object.assign({},option,{visible:!1})),option.clustering.iconCreateFunction||(option.clustering.iconCreateFunction=iconCreateFunction);var cluster=L.markerClusterGroup(option.clustering);option.clustering.forceSpiderfyOnClick&&cluster.on("clusterclick",function(a){a&&a.layer&&a.layer.spiderfy()}),cluster.addLayers([this.layer[id].layer]),this.layer[id].layer=cluster,this.showMarkers(id,option.visible)},WFML.MarkerManager.prototype.removeMarkers=function(id){id in this.layer&&(this.showMarkers(id,!1),delete this.layer[id],this.layers=this.layers.filter(function(lid){return lid!=id}))},WFML.MarkerManager.prototype.showMarkers=function(id,visible){if(id in this.layer){var markers=this.layer[id];!markers.visible!=!visible&&(visible?this.map.leafMap.addLayer(markers.layer):this.map.leafMap.removeLayer(markers.layer),markers.visible=!!visible)}}}(),function(){function searchPlaces(data){data.searchState.placeText?data.searchState.places=sortData(searchData(WFML.PLACES,data.searchState.placeText,!1,data.anchorPt)):data.searchState.places=[]}function searchRoads(data){data.searchState.roadText?data.searchState.roads=sortData(searchData(WFML.ROADS,data.searchState.roadText,!1,data.anchorPt,data.maxDistance)):data.searchState.roads=[]}function searchData(source,str,searchIn,anchorPt,maxDist){var locs=[];if(str.length<=0)return locs;for(var strLow=str.toLowerCase(),strIn=" "+strLow,i=0;i<source.length;i++){var place=source[i];if(match(place.n,strLow,strIn,searchIn)){var pt=[place.x,place.y],loc={name:place.n,type:place.t,dist:null,loc:pt};if(setAnchorData(anchorPt,loc),maxDist&&loc.dist>maxDist)continue;locs.push(loc)}}return locs}function match(name,strLow,strIn,searchIn){var nlow=name.toLowerCase(),isPref=nlow.startsWith(strLow);if(!searchIn)return isPref;var isIn=nlow.indexOf(strIn)>-1;return isPref||isIn}function sortData(locations){return locations.sort(function(a,b){return null==a.dist||null==b.dist?a.name>b.name?1:-1:a.dist-b.dist})}function removeDuplicateIntersections(locations){for(var uniq=[],i=0;i<locations.length;i++){var candidate=locations[i];if(i>0){if(isDuplicateIntersection(uniq[uniq.length-1],candidate))continue}uniq.push(candidate)}return uniq}function isDuplicateIntersection(intLoc1,intLoc2){if(intLoc1.name!==intLoc2.name)return!1;if(intLoc1.dist&&intLoc2.dist){if(intLoc1.dist-intLoc2.dist>1)return!1}return!0}function setAnchorData(anchorPt,loc){anchorPt&&(loc.dist=distance(anchorPt,loc)/1e3,loc.direction=direction(anchorPt,loc.loc),loc.dist<EPSILON&&(loc.isAnchor=!0))}function searchIntersections(data){if(!data.searchState.intersectionsText)return void(data.searchState.intersections=[]);var query={ver:1.2,maxResults:1e3,outputSRS:4326,addressString:data.searchState.intersectionsText.join(" and "),matchPrecision:"INTERSECTION",autoComplete:!0};return new Promise(function(res,rej){$.ajax({timeout:1e4,dataType:"jsonp",url:"https://geocoder.api.gov.bc.ca/addresses.geojsonp",data:query}).then(res,rej)}).then(function(result){var resultLoc=$.map(result.features,function(feature){if(feature.geometry.coordinates&&"BC"!=feature.properties.fullAddress&&feature.properties.intersectionName){var loc={name:feature.properties.fullAddress,type:"intersection",dist:null,dir:null,loc:feature.geometry.coordinates};return setAnchorData(data.anchorPt,loc),loc}});data.searchState.intersections=removeDuplicateIntersections(sortData(resultLoc))})}function distance(loc1,loc2){return loc1&&loc2?WFML.Search.toLatLng(loc1).distanceTo(WFML.Search.toLatLng(loc2)):0}function direction(p1,p2){return p1&&p2?WFML.Util.direction(p1,p2):""}var EPSILON=1e-4;WFML.Search=function(map){this.map=map,this.leafmap=map.leafMap,this.data=new WFML.SearchData},WFML.Search.prototype.data=function(){return this.data},WFML.Search.prototype.clear=function(){return this.crosshairs(),this.crosshairs2(),this.arrow(),this.data.init()},WFML.Search.prototype.setMaximumDistance=function(distance){return this.data.setMaximumDistance(distance)},WFML.Search.prototype.setAnchor=function(pt){return this.crosshairs(pt),this.crosshairs2(),this.arrow(),this.data.setAnchor(pt)},WFML.Search.prototype.zoom=function(){var level=this.map.zoom(),newLevel=level+4;this.map.zoom(this.data.anchorLocation(),newLevel)},WFML.Search.prototype.pan=function(){this.map.pan(this.data.anchorLocation())},WFML.Search.prototype.showCandidate=function(loc){if(this.crosshairs2(),this.arrow(),loc){this.crosshairs2(loc);var anchor=this.data.anchorLocation();anchor&&this.arrow(anchor,loc)}},WFML.Search.prototype.setResultHandler=function(callback){this.data.setResultHandler(callback)},WFML.Search.prototype.findPlace=function(txt){return this.data.findPlace(txt)},WFML.Search.prototype.findRoad=function(txt){return this.data.findRoad(txt)},WFML.Search.prototype.findIntersection=function(txt1,txt2){return this.data.findIntersection(txt1,txt2)},WFML.Search.prototype.crosshairs=function(pt){this.map.indicator("crosshairs",pt,"crosshairs")},WFML.Search.prototype.crosshairs2=function(loc){var pt=loc?loc.loc:null,opt={style:{opacity:.6,fillOpacity:0,weight:2,color:"#08f",radius:20}};this.map.indicator("crosshairs2",pt,"crosshairs",opt)},WFML.Search.prototype.arrow=function(pt,loc){if(!pt)return void this.map.indicator("arrow");var lbl=loc.name+" - "+WFML.Search.formatDistance(loc.dist,"km");this.map.indicator("arrow",pt,"arrow",{target:loc.loc,label:lbl})},WFML.Search.toLatLng=function(loc){return loc instanceof Array?new L.LatLng(loc[1],loc[0]):new L.LatLng(loc.loc[1],loc.loc[0])},WFML.Search.formatDDM=function(dd){dd=Math.abs(dd);var d=Math.abs(Math.trunc(dd));return d+" "+(60*(dd-d)).toFixed(3)},WFML.Search.formatDistance=function(dist,unit){return null==dist?"n/a":dist<10?dist.toFixed(1)+" "+unit:dist.toFixed(0)+" "+unit},WFML.SearchData=function(){this.init(),this.maxDistance=null,this.callback=null},WFML.SearchData.prototype.init=function(){return this.searchState={placeText:null,places:[],roadText:null,roads:[],intersectionsText:null,intersections:[]},this.anchorPt=null,this.updateResults()},WFML.SearchData.prototype.setResultHandler=function(callback){null!=callback&&"function"!=typeof callback||(this.callback=callback)},WFML.SearchData.prototype.setMaximumDistance=function(distance){return this.maxDistance=distance,this.updateResults()},WFML.SearchData.prototype.setAnchor=function(pt){return this.anchorPt=pt,this.updateResults()},WFML.SearchData.prototype.anchorLocation=function(){return this.anchorPt},WFML.SearchData.prototype.findPlace=function(text){return this.searchState.places=[],this.searchState.placeText=text,this.updateResults()},WFML.SearchData.prototype.findRoad=function(text){return this.searchState.roads=[],this.searchState.roadText=text,this.searchState.intersections=[],this.searchState.intersectionsText=null,this.updateResults()},WFML.SearchData.prototype.findIntersection=function(text1,text2){return this.searchState.intersections=[],this.searchState.intersectionsText=[text1,text2],this.searchState.roads=[],this.searchState.roadText=null,this.updateResults()},WFML.SearchData.prototype.updateResults=function(){var self=this;return this.callback?Promise.resolve().then(function(){return searchPlaces(self)}).then(function(){return searchRoads(self)}).then(function(){return searchIntersections(self)}).then(function(){self.callback&&self.callback.call(null,Object.assign({anchorPt:self.anchorPt,maxDistance:self.maxDistance},self.searchState))},function(e){self.callback&&self.callback.call(null,null,e)}):Promise.resolve()}}(),function(){WFML.ToolManager=function(map){this.map=map,this.leafMap=map.leafMap,this.toolbars={},this.init(map.mapId),this.toolRegistry={},this.tools=[],this.currentToolId=null},WFML.ToolManager.prototype.init=function(mapId){this.toolbars.main=L.DomUtil.create("div","wfml-toolbar wfml-toolbar-main",L.DomUtil.get(mapId)),this.toolbars.layer=L.DomUtil.create("div","wfml-toolbar wfml-toolbar-right",L.DomUtil.get(mapId))},WFML.ToolManager.prototype._add=function(id,tool,toolbar){if(id in this.toolRegistry)throw new Error('tool "'+id+'" already exists');tool._init(id,this),this.toolRegistry[id]=tool,this.tools.push(tool),toolbar&&(tool.div=L.DomUtil.create("div","wfml-tool",toolbar),L.DomUtil.addClass(tool.div,tool.className),tool.div.title=tool.options.title,tool.div.addEventListener("click",function(){if(tool.active)return void tool.deactivate();tool.activate()}),WFML.Lutil.stopProp(tool.div))},WFML.ToolManager.prototype.addHidden=function(id,tool){this._add(id,tool)},WFML.ToolManager.prototype.addToMain=function(id,tool){this._add(id,tool,this.toolbars.main)},WFML.ToolManager.prototype.addToLayer=function(id,tool){this._add(id,tool,this.toolbars.layer)},WFML.ToolManager.prototype.setActiveTool=function(toolId,active){if(null!=toolId&&!(toolId in this.toolRegistry))throw new Error('tool "'+toolId+"\" doesn't exist");!1!==active?(this.tools.forEach(function(t){t.id!=toolId&&t.deactivate()}),this.currentToolId=toolId,this.toolRegistry[toolId].activate()):(this.currentToolId=null,this.toolRegistry[toolId].deactivate())},WFML.ToolManager.prototype.getActiveTool=function(){if(this.currentToolId)return this.toolRegistry[this.currentToolId]},WFML.Tool=function(options){this.options=options||{},this.className=options.className},WFML.Tool.prototype._init=function(id,toolmgr){this.id=id,this.mgr=toolmgr,this.map=toolmgr.map,this.leafMap=toolmgr.leafMap,this.active=!1,this.initialize()},WFML.Tool.prototype.initialize=function(){},WFML.Tool.prototype.activate=function(){return!this.active&&(this.active=!0,this.mgr.setActiveTool(this.id,!0),this.div&&L.DomUtil.addClass(this.div,"wfml-control-active"),this.mapClass&&L.DomUtil.addClass(this.leafMap._container,this.mapClass),!0)},WFML.Tool.prototype.deactivate=function(){return!!this.active&&(this.active=!1,this.mgr.setActiveTool(this.id,!1),this.div&&L.DomUtil.removeClass(this.div,"wfml-control-active"),this.mapClass&&L.DomUtil.removeClass(this.leafMap._container,this.mapClass),!0)},WFML.Tool.prototype.isActive=function(){return this.active},WFML.ActionTool=function(options,action){WFML.Tool.call(this,options),this.action=action},WFML.ActionTool.prototype=Object.create(WFML.Tool.prototype),WFML.ActionTool.prototype.activate=function(){var self=this;return!!WFML.Tool.prototype.activate.apply(this)&&(this.action(this.map),setTimeout(function(){self.deactivate()},50),!0)},WFML.LeafletTool=function(options,onDeactivateFn){WFML.Tool.call(this,options),this.onDeactivateFn=onDeactivateFn},WFML.LeafletTool.prototype=Object.create(WFML.Tool.prototype),WFML.LeafletTool.prototype.deactivate=function(){if(!WFML.Tool.prototype.deactivate.apply(this))return!1;this.onDeactivateFn()}}(),function(){function isDrawing(e){var isBtnDown=e.originalEvent.buttons>0;return isModified(e)&&isBtnDown}function isModified(e){return!!e.originalEvent.shiftKey}function isPointSame(pt,pts){return!(pts.length<=0)&&pt.equals(pts[pts.length-1])}function locatePtAlong(latlng0,latlng1,segFrac){var p0=WFML.Util.toLonLat(latlng0),p1=WFML.Util.toLonLat(latlng1),dx=p1[0]-p0[0],dy=p1[1]-p0[1];return[p0[0]+dx*segFrac,p0[1]+dy*segFrac]}function computeBearing(pts,pt){var p1=null,p2=null;return pt?(p1=pts.length>=1?pts[pts.length-1]:null,p2=pt):pts.length>=2&&(p1=pts[pts.length-2],p2=pts[pts.length-1]),p1&&p2?bearing(p1,p2):0}function bearing(latlng1,latlng2){var lat1=toRadians(latlng1.lat),lon1=toRadians(latlng1.lng),lat2=toRadians(latlng2.lat),lon2=toRadians(latlng2.lng),y=Math.sin(lon2-lon1)*Math.cos(lat2),x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1),bearing=toDegrees(Math.atan2(y,x));return bearing<0&&(bearing=360-Math.abs(bearing)),bearing}function toRadians(deg){return deg*(Math.PI/180)}function toDegrees(rad){return rad*(180/Math.PI)}function computeRingArea(pts){var n=pts.length,sum=0,area=0;if(n>2){for(var i=0;i<n;i++){var i1=i%n,i2=(i+1)%n,i3=(i+2)%n,p1=pts[i1],p2=pts[i2];sum+=(rad(pts[i3].lng)-rad(p1.lng))*Math.sin(rad(p2.lat))}area=sum*GEO_RADIUS*GEO_RADIUS/2}return Math.abs(area)}function rad(num){return num*Math.PI/180}function setLayerScale(div,lyr){lyr.layer.isInScaleRange()?L.DomUtil.removeClass(div,"wfml-layerlist-scale-out"):L.DomUtil.addClass(div,"wfml-layerlist-scale-out")}WFML.MeasureTool=function(options){WFML.Tool.call(this,options),this.mapClass="tool-map-active-measure",this.measurePts=[],this.tentative=null,this.mapListeners={click:this.onClick,dblclick:this.onDblClick,mousemove:this.onMove},this.decimalPlaces=1};var measureState={EMPTY:0,IN_PROGRESS:1,DONE:2};WFML.MeasureTool.prototype=Object.create(WFML.Tool.prototype),WFML.MeasureTool.prototype.initialize=function(){this._createDOM(),WFML.Lutil.stopProp(this.panelDiv)},WFML.MeasureTool.prototype._createDOM=function(){this.panelDiv=this.map.createElement("div","wfml-tool-measure-panel");var measuresDiv=L.DomUtil.create("div","wfml-tool-measure-measures",this.panelDiv);this.distText=L.DomUtil.create("div","wfml-tool-measure-text",measuresDiv),this.bearingText=L.DomUtil.create("div","wfml-tool-measure-text",measuresDiv),this.areaText=L.DomUtil.create("div","wfml-tool-measure-text",measuresDiv);var btnDiv=L.DomUtil.create("div","wfml-tool-measure-btns",this.panelDiv);this.btnSelectMid=L.DomUtil.create("div","wfml-tool-measure-btn",btnDiv),L.DomUtil.addClass(this.btnSelectMid,"wfml-tool-measure-selectmid"),this.btnSelectMid.title="Select Midpoint",this.btnSelectEnd=L.DomUtil.create("div","wfml-tool-measure-btn",btnDiv),L.DomUtil.addClass(this.btnSelectEnd,"wfml-tool-measure-selectend"),this.btnSelectEnd.title="Select Endpoint";var self=this;this.btnSelectEnd.addEventListener("click",function(){if(self.hasPoint()){var pt=self.endPoint();self.map.selectPoint(pt)}}),this.btnSelectMid.addEventListener("click",function(){if(self.hasPoint()){var pt=self.midPoint();self.map.selectPoint(pt)}})},WFML.MeasureTool.prototype.hasPoint=function(){return this.measurePts.length>=1},WFML.MeasureTool.prototype.endPoint=function(){
return this.hasPoint()?WFML.Util.toLonLat(this.measurePts[this.measurePts.length-1]):null},WFML.MeasureTool.prototype.midPoint=function(){return this.hasPoint()?this.computeMidpoint(this.measurePts):null},WFML.MeasureTool.prototype.activate=function(){return!!WFML.Tool.prototype.activate.apply(this)&&(this.leafMap.boxZoom.disable(),this.leafMap.doubleClickZoom.disable(),this.leafMap.on(this.mapListeners,this),this.panelDiv.style.display="block",this.measurePts=[],this.distText.textContent="",this.bearingText.textContent="",this.areaText.textContent="",this.map.selectPoint(),this._layer=L.layerGroup().addTo(this.leafMap),!0)},WFML.MeasureTool.prototype.deactivate=function(){return!!WFML.Tool.prototype.deactivate.apply(this)&&(this.leafMap.boxZoom.enable(),this.leafMap.doubleClickZoom.enable(),this.leafMap.off(this.mapListeners),this.panelDiv.style.display="none",this.leafMap.removeLayer(this._layer),!0)},WFML.MeasureTool.prototype.onClick=function(e){this.state!=measureState.IN_PROGRESS&&(this.measurePts=[],this._layer.clearLayers(),this.map.selectPoint()),this.state=measureState.IN_PROGRESS;var pt=e.latlng;return this.addPt(pt)&&this.update(),!1},WFML.MeasureTool.prototype.onMove=function(e){if(this.state==measureState.IN_PROGRESS){var pt=e.latlng;isDrawing(e)?(this.addPt(pt),this.update()):this.update(pt)}},WFML.MeasureTool.prototype.onDblClick=function(e){return this.state=measureState.DONE,!1},WFML.MeasureTool.prototype.addPt=function(pt){return!isPointSame(pt,this.measurePts)&&(this.measurePts.push(pt),!0)},WFML.MeasureTool.prototype.update=function(pt){this.updateGraphic(this.measurePts,pt),this.updateDisplay(this.measurePts,pt)},WFML.MeasureTool.prototype.updateGraphic=function(pts,pt){if(pt){if(this.tentativeLine&&(this.tentativeLine.remove(),this.tentativeLine=null),pts.length>0){var tentativePts=[pts[pts.length-1],pt];this.tentativeLine=L.polyline(tentativePts,{color:"#ff00ff",weight:2,dashArray:"6,6",interactive:!1}),this.tentativeLine.addTo(this._layer)}}else{L.polyline(pts,{color:"#ff00ff",weight:2,interactive:!1}).addTo(this._layer)}},WFML.MeasureTool.prototype.updateDisplay=function(pts,pt){var m=this.computeDistance(pts,pt),kmTxt=(m/1e3).toFixed(this.decimalPlaces)+" km",nmTxt=(m/1e3*.539957).toFixed(this.decimalPlaces)+" nm",miTxt=(m/1e3*.621371).toFixed(this.decimalPlaces)+" mi",distTxt=kmTxt+" / "+miTxt+" / "+nmTxt,txt=distTxt+"  ";this.distText.textContent=txt;var bearing=computeBearing(pts,pt);this.bearingText.textContent=bearing.toFixed(1)+" TN";var area=computeRingArea(pts),areaHa=(area/1e4).toFixed(1);this.areaText.textContent=areaHa+" ha"},WFML.MeasureTool.prototype.computeDistance=function(pts,pt){for(var dist=0,i=1;i<pts.length;i++)dist+=this.leafMap.distance(pts[i],pts[i-1]);return pt&&pts.length>0&&(dist+=this.leafMap.distance(pts[pts.length-1],pt)),dist},WFML.MeasureTool.prototype.computeMidpoint=function(pts){for(var totLen=this.computeDistance(pts),midLen=totLen/2,len=0,i=1;i<pts.length;i++){var segLen=this.leafMap.distance(pts[i],pts[i-1]);if(len+segLen>midLen){var segFrac=(midLen-len)/segLen;return locatePtAlong(pts[i-1],pts[i],segFrac)}len+=segLen}return WFML.Util.toLonLat(pts[pts.length-1])};var GEO_RADIUS=6378137;WFML.SelectPointTool=function(options){WFML.Tool.call(this,options),this.mapClass="tool-map-active-selectpoint"},WFML.SelectPointTool.prototype=Object.create(WFML.Tool.prototype),WFML.SelectPointTool.prototype.initialize=function(){this.displayDiv=this.map.createElement("div","wfml-tool-selectpoint-panel"),this.inputText=L.DomUtil.create("input","wfml-tool-selectpoint-text",this.displayDiv),WFML.Lutil.stopProp(this.displayDiv)},WFML.SelectPointTool.prototype.activate=function(){return!!WFML.Tool.prototype.activate.apply(this)&&(this.leafMap.on("click",this.onClick,this),this.leafMap.on("mousemove",this.update,this),this.displayDiv.style.display="block",this.map.selectPoint(),!0)},WFML.SelectPointTool.prototype.deactivate=function(){return!!WFML.Tool.prototype.deactivate.apply(this)&&(this.leafMap.off("click",this.onClick,this),this.displayDiv.style.display="none",!0)},WFML.SelectPointTool.prototype.update=function(e){var coord=WFML.Util.toLonLat(e.latlng),txt=WFML.Location.format(coord);this.inputText.value=txt},WFML.SelectPointTool.prototype.onClick=function(e){this.update(e),this.inputText.select(),document.execCommand("copy");var coord=WFML.Util.toLonLat(e.latlng);this.map.selectPoint(coord),this.deactivate()},WFML.LayerListTool=function(options){var self=this;this.legendShow=!1,WFML.ActionTool.call(this,options,function(){self.doAction()}),this.filterClear()},WFML.LayerListTool.prototype=Object.create(WFML.ActionTool.prototype);WFML.LayerListTool.prototype.initialize=function(){var self=this;this.map.leafMap.on("zoom",function(){self.onMapZoom()})},WFML.LayerListTool.prototype.doAction=function(){this.sidebar||(this.sidebar=this.map.sidebar().create("wfml-layerlist","Layer List",300),this.create(),this.render()),this.map.sidebar().show(this.sidebar,!0)},WFML.LayerListTool.prototype.isFilterOn=function(){return this.filter.visible||this.filter.text&&this.filter.text.length>0},WFML.LayerListTool.prototype.filterClear=function(){this.filter={text:"",visible:!1}},WFML.LayerListTool.prototype.applyFilter=function(opt){opt?(opt.hasOwnProperty("text")&&(this.filter.text=opt.text),opt.hasOwnProperty("visible")&&(this.filter.visible=opt.visible)):this.filterClear(),this.render()},WFML.LayerListTool.prototype.isNodeFiltered=function(node){if(!this.filter.visible||node.visible())return this.filterMatches(node.title)},WFML.LayerListTool.prototype.filterMatches=function(s){if(!s)return!1;var re=new RegExp(this.filter.text,"i");return s.match(re)},WFML.LayerListTool.prototype.create=function(){var sidebarContent=this.sidebar.content,toolbar=L.DomUtil.create("div","wfml-layerlist-toolbar",this.sidebar.toolbar),toolLegend=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-legend",toolbar),toolFilter=L.DomUtil.create("div","wfml-layerlist-tool wfml-layerlist-tool-filter",toolbar);this.layerListDiv=L.DomUtil.create("div","wfml-layerlist",sidebarContent);var filterBar=L.DomUtil.create("div","wfml-layerlist-filterbar wfml-layerlist-filterbar-hidden",this.layerListDiv);L.DomUtil.create("span","wfml-layerlist-filter-label",filterBar).innerText="Search ";var filterInput=L.DomUtil.create("input","wfml-layerlist-filter-input",filterBar),filterVis=(L.DomUtil.create("div","wfml-layerlist-filter-visible-icon",filterBar),L.DomUtil.create("input","",filterBar));filterVis.type="checkbox",this.layerListItemsDiv=L.DomUtil.create("div","wfml-layerlist",this.layerListDiv);var self=this;toolLegend.addEventListener("click",function(){self.onLegendToggle()}),toolFilter.addEventListener("click",function(){filterBar.classList.toggle("wfml-layerlist-filterbar-hidden")?self.applyFilter():(self.filterClear(),filterInput.value="",filterVis.checked=!1)}),filterInput.addEventListener("input",function(evt){self.applyFilter({text:filterInput.value})}),filterVis.addEventListener("click",function(evt){self.applyFilter({visible:filterVis.checked})})},WFML.LayerListTool.prototype.render=function(){var tree=this.map.layerMgr.treeView();this.isFilterOn()&&this.filterSetState(tree),this.listItems=[],L.DomUtil.empty(this.layerListItemsDiv),this.renderFolder(tree,0,this.layerListItemsDiv)},WFML.LayerListTool.prototype.filterSetState=function(node){var nodeVis=!1;if(node.isFolder()){if(node.child)for(var i=0;i<node.child.length;i++){var ch=node.child[i],isVis=this.filterSetState(ch);isVis&&(nodeVis=!0,node.isFilterExpand=!0)}}else this.isNodeFiltered(node)&&(nodeVis=!0);return node.isFilterVis=nodeVis,nodeVis},WFML.LayerListTool.prototype.renderFolder=function(folder,level,parentDiv){var folderDiv=parentDiv;if(folder.title&&(folderDiv=this.renderItem(folder,level,parentDiv)),folder.child)for(var i=0;i<folder.child.length;i++)this.renderFolder(folder.child[i],level+1,folderDiv)},WFML.LayerListTool.prototype.renderItem=function(lyr,level,parentDiv){function renderLegendEntries(entries,legendDiv){for(var i=0;i<entries.length;i++){var ent=entries[i],div=L.DomUtil.create("div","wfml-legend-entry",legendDiv),img=L.DomUtil.create("img","wfml-legend-image",div);img.src=ent.url,ent.width&&(img.style.width=ent.width),ent.height&&(img.style.height=ent.height);var lbl=ent.label;if(lbl){L.DomUtil.create("span","wfml-legend-label",div).innerHTML=lbl}}}function onVisCtlClick(evt,lyr){if(evt.ctrlKey)return void lyr.visible(!0);if(visCtl.classList.contains("wfml-layerlist-vis-mixed"))return void lyr.visible(!1);var isOn=visCtl.classList.contains("wfml-layerlist-vis-on");lyr.visible(!isOn),setItemVis(visCtl,lyr)}function setLayerState(lyr){setItemVis(visCtl,lyr),lyr.isFolder()||setLayerScale(titleDiv,lyr)}function setItemVis(vis,lyr){var clz="wfml-layerlist-vis "+(lyr.visible()?"wfml-layerlist-vis-on":"wfml-layerlist-vis-off");lyr.isMixed()&&(clz="wfml-layerlist-vis wfml-layerlist-vis-mixed"),vis.className=clz,!isFolder&&legendDiv&&(legendDiv.style.display=self.legendShow&&lyr.visible()?"block":"none")}function onFolderCtlClick(evt){var isOpen="none"!==folDiv.style.display;evt.ctrlKey&&setChildFolderState(folDiv,!isOpen),setFolderState(folDiv,folCtl,!isOpen)}function setFolderState(folDiv,folCtl,isOpen){folDiv.style.display=isOpen?"block":"none",folCtl.className="wfml-layerlist-expand"+(isOpen?"":" wfml-layerlist-close")}function setChildFolderState(folDiv,isOpen){for(var collCtl=folDiv.getElementsByClassName("wfml-layerlist-expand"),i=0;i<collCtl.length;i++){collCtl.item(i).className="wfml-layerlist-expand"+(isOpen?"":" wfml-layerlist-close")}var coll=folDiv.getElementsByClassName("wfml-layerlist-folder-container");for(i=0;i<coll.length;i++){coll.item(i).style.display=isOpen?"block":"none"}}if(!this.isFilterOn()||lyr.isFilterVis){var self=this,isFolder=lyr.isFolder(),clz="wfml-layerlist-item "+(isFolder?"wfml-layerlist-folder":"wfml-layerlist-layer"),item=L.DomUtil.create("div",clz,parentDiv),folDiv=null;if(isFolder){var folCtl=L.DomUtil.create("div","wfml-layerlist-expand",item);folCtl.title=WFML.Tooltip.LAYER_FOLDER_EXPAND,folDiv=L.DomUtil.create("div","wfml-layerlist-folder-container",parentDiv);var padding=8*(level+1);folDiv.style.paddingLeft=padding+"px";var isOpen=lyr.isMixed()||lyr.visible();this.isFilterOn()&&(isOpen=lyr.isFilterExpand),setFolderState(folDiv,folCtl,isOpen),folCtl.addEventListener("click",function(evt){onFolderCtlClick(evt)})}var visCtl=L.DomUtil.create("div","wfml-layerlist-state wfml-layerlist-off",item);visCtl.title=isFolder?WFML.Tooltip.LAYER_VIS_FOLDER:WFML.Tooltip.LAYER_VIS_LAYER,visCtl.addEventListener("click",function(evt){onVisCtlClick(evt,lyr)});var titleDiv=L.DomUtil.create("div","wfml-layerlist-title",item);titleDiv.innerText=lyr.title,titleDiv.addEventListener("dblclick",function(evt){isFolder||lyr.layer.zoomToScale()}),!isFolder&&lyr.layer.hasScaleRange()&&(titleDiv.title=WFML.Tooltip.LAYER_TITLE);var legendDiv=null;return isFolder||function(lyr,parentDiv){var entries=lyr.layer.legend();entries&&entries[0].url&&(legendDiv=L.DomUtil.create("div","wfml-layerlist-legend",parentDiv),renderLegendEntries(entries,legendDiv))}(lyr,item),setLayerState(lyr),lyr.onChange(function(){setLayerState(lyr)}),this.listItems.push({layer:lyr,titleDiv:titleDiv,legendDiv:legendDiv}),folDiv}},WFML.LayerListTool.prototype.onMapZoom=function(){this.listItems&&this.listItems.forEach(function(item){item.layer.isFolder()||setLayerScale(item.titleDiv,item.layer)})},WFML.LayerListTool.prototype.onLegendToggle=function(){var showLegend=!this.legendShow;this.legendShow=showLegend,this.listItems&&this.listItems.forEach(function(item){if(!item.layer.isFolder()){var isDisp=showLegend&&item.layer.visible(),disp=isDisp?"block":"none";item.legendDiv&&(item.legendDiv.style.display=disp)}})},WFML.Tooltip={LAYER_VIS_LAYER:"Click to change layer visibility",LAYER_VIS_FOLDER:"Click to change folder content visibility\nCtrl-click sets all to on",LAYER_FOLDER_EXPAND:"Click to open / close folder\nCtrl-click changes subfolders as well",LAYER_TITLE:"Double-click to zoom to scale range"}}();